<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            min-height: 100vh;
            background-color: #050505;
            font-family: 'Outfit', system-ui, sans-serif;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 460px;
            position: relative;
        }

        .card {
            background: #0a0a0a;
            border: 1px solid #1e293b;
            border-radius: 2rem;
            padding: 3rem 2.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 80px rgba(249, 115, 22, 0.06), 0 25px 50px rgba(0,0,0,0.5);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #f97316, #3b82f6);
        }

        .icon-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(59, 130, 246, 0.15));
            border: 1px solid rgba(249, 115, 22, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .icon-circle svg {
            width: 36px;
            height: 36px;
            color: #f97316;
        }

        h1 {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 900;
            color: #fff;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .email-badge {
            display: block;
            text-align: center;
            background: rgba(249, 115, 22, 0.08);
            border: 1px solid rgba(249, 115, 22, 0.2);
            border-radius: 12px;
            padding: 10px 16px;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            color: #f97316;
            font-weight: 600;
            word-break: break-all;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 48px 14px 16px;
            background: #111;
            border: 1px solid #1e293b;
            border-radius: 14px;
            color: #fff;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
            outline: none;
        }

        .input-wrapper input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
        }

        .input-wrapper input::placeholder {
            color: #475569;
        }

        .toggle-pass {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .toggle-pass:hover {
            color: #f97316;
        }

        .strength-bar {
            height: 4px;
            border-radius: 2px;
            background: #1e293b;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar .fill {
            height: 100%;
            border-radius: 2px;
            transition: all 0.4s;
            width: 0%;
        }

        .strength-text {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #64748b;
            text-align: right;
        }

        .requirements {
            background: rgba(59, 130, 246, 0.06);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 14px;
            padding: 14px 16px;
            margin: 1.25rem 0;
        }

        .requirements p {
            font-size: 0.8rem;
            font-weight: 700;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .requirements ul {
            list-style: none;
            padding: 0;
        }

        .requirements li {
            font-size: 0.8rem;
            color: #64748b;
            padding: 3px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
        }

        .requirements li.met {
            color: #22c55e;
        }

        .requirements li .check {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1.5px solid #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .requirements li.met .check {
            background: #22c55e;
            border-color: #22c55e;
        }

        .requirements li.met .check svg {
            opacity: 1;
        }

        .requirements li .check svg {
            width: 10px;
            height: 10px;
            color: #fff;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-submit {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f97316, #3b82f6);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.5rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(249, 115, 22, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2.5px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .state { display: none; }
        .state.active { display: block; }

        .success-icon {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
            border: 2px solid rgba(34, 197, 94, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            animation: scaleIn 0.5s ease;
        }

        .success-icon svg {
            width: 44px;
            height: 44px;
            color: #22c55e;
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .btn-go-store {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 1.5rem;
        }

        .btn-go-store:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
        }

        .error-icon {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            border: 2px solid rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .error-icon svg {
            width: 44px;
            height: 44px;
            color: #ef4444;
        }

        .error-msg {
            text-align: center;
            color: #ef4444;
            font-size: 0.9rem;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-top: 1rem;
        }

        .btn-retry {
            display: block;
            width: 100%;
            padding: 16px;
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            color: #f97316;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
            margin-top: 1.5rem;
        }

        .btn-retry:hover {
            background: rgba(249, 115, 22, 0.2);
        }

        .footer {
            text-align: center;
            margin-top: 2rem;
            color: #334155;
            font-size: 0.75rem;
        }

        @media (max-width: 480px) {
            .card { padding: 2rem 1.5rem; border-radius: 1.5rem; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div id="state-form" class="state active">
                <div class="icon-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" /></svg>
                </div>
                <h1>Nueva Contraseña</h1>
                <p class="subtitle">Elegí una contraseña segura para proteger tu cuenta.</p>
                <div id="email-display" class="email-badge" style="display:none;"></div>

                <form id="reset-form" onsubmit="return false;">
                    <div class="form-group">
                        <label>Nueva Contraseña</label>
                        <div class="input-wrapper">
                            <input type="password" id="new-pass" placeholder="Escribí tu nueva contraseña" autocomplete="new-password" required />
                            <button type="button" class="toggle-pass" onclick="togglePass('new-pass', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                        </div>
                        <div class="strength-bar"><div class="fill" id="strength-fill"></div></div>
                        <div class="strength-text" id="strength-text"></div>
                    </div>

                    <div class="form-group">
                        <label>Confirmar Contraseña</label>
                        <div class="input-wrapper">
                            <input type="password" id="confirm-pass" placeholder="Repetí tu nueva contraseña" autocomplete="new-password" required />
                            <button type="button" class="toggle-pass" onclick="togglePass('confirm-pass', this)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                        </div>
                    </div>

                    <div class="requirements">
                        <p>Tu contraseña debe tener:</p>
                        <ul>
                            <li id="req-length"><span class="check"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></span> Al menos 6 caracteres</li>
                            <li id="req-upper"><span class="check"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></span> Una letra mayúscula</li>
                            <li id="req-number"><span class="check"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></span> Un número</li>
                            <li id="req-match"><span class="check"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></span> Las contraseñas coinciden</li>
                        </ul>
                    </div>

                    <button type="submit" class="btn-submit" id="btn-submit" disabled>GUARDAR NUEVA CONTRASEÑA</button>
                </form>
            </div>

            <div id="state-success" class="state">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <h1 style="color: #22c55e;">¡Contraseña Actualizada!</h1>
                <p class="subtitle" style="margin-bottom: 0;">Tu contraseña fue cambiada exitosamente. Ya podés iniciar sesión con tu nueva contraseña.</p>
                <a href="/" class="btn-go-store">IR A LA TIENDA E INICIAR SESIÓN</a>
            </div>

            <div id="state-error" class="state">
                <div class="error-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </div>
                <h1 style="color: #ef4444;">Error</h1>
                <p class="subtitle">No pudimos procesar tu solicitud.</p>
                <div class="error-msg" id="error-msg">El enlace ha expirado o ya fue utilizado. Solicitá un nuevo enlace desde la tienda.</div>
                <a href="/" class="btn-retry">VOLVER A LA TIENDA</a>
            </div>

            <div class="footer">Protegemos tu cuenta con los más altos estándares de seguridad.</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, verifyPasswordResetCode, confirmPasswordReset } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfllte-D_I3h3TwBaiSL4KVfWrCSVh9ro",
            authDomain: "sustore-63266.firebaseapp.com",
            projectId: "sustore-63266"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const params = new URLSearchParams(window.location.search);
        const oobCode = params.get('oobCode');
        const mode = params.get('mode');

        const stateForm = document.getElementById('state-form');
        const stateSuccess = document.getElementById('state-success');
        const stateError = document.getElementById('state-error');
        const emailDisplay = document.getElementById('email-display');
        const btnSubmit = document.getElementById('btn-submit');
        const newPassInput = document.getElementById('new-pass');
        const confirmPassInput = document.getElementById('confirm-pass');

        function showState(state) {
            stateForm.classList.remove('active');
            stateSuccess.classList.remove('active');
            stateError.classList.remove('active');
            state.classList.add('active');
        }

        if (!oobCode || mode !== 'resetPassword') {
            document.getElementById('error-msg').textContent = 'Enlace inválido. Solicitá un nuevo enlace desde la tienda.';
            showState(stateError);
        } else {
            verifyPasswordResetCode(auth, oobCode).then((email) => {
                emailDisplay.textContent = email;
                emailDisplay.style.display = 'block';
            }).catch(() => {
                document.getElementById('error-msg').textContent = 'Este enlace ha expirado o ya fue utilizado. Volvé a la tienda y solicitá uno nuevo.';
                showState(stateError);
            });
        }

        function validate() {
            const pass = newPassInput.value;
            const confirm = confirmPassInput.value;

            const hasLength = pass.length >= 6;
            const hasUpper = /[A-Z]/.test(pass);
            const hasNumber = /\d/.test(pass);
            const matches = pass.length > 0 && pass === confirm;

            document.getElementById('req-length').classList.toggle('met', hasLength);
            document.getElementById('req-upper').classList.toggle('met', hasUpper);
            document.getElementById('req-number').classList.toggle('met', hasNumber);
            document.getElementById('req-match').classList.toggle('met', matches);

            let strength = 0;
            if (hasLength) strength++;
            if (hasUpper) strength++;
            if (hasNumber) strength++;
            if (pass.length >= 10) strength++;

            const fill = document.getElementById('strength-fill');
            const text = document.getElementById('strength-text');
            const levels = [
                { width: '0%', color: '#1e293b', label: '' },
                { width: '25%', color: '#ef4444', label: 'Débil' },
                { width: '50%', color: '#f97316', label: 'Regular' },
                { width: '75%', color: '#eab308', label: 'Buena' },
                { width: '100%', color: '#22c55e', label: 'Fuerte' }
            ];
            fill.style.width = levels[strength].width;
            fill.style.background = levels[strength].color;
            text.textContent = levels[strength].label;
            text.style.color = levels[strength].color;

            btnSubmit.disabled = !(hasLength && matches);
            return hasLength && matches;
        }

        newPassInput.addEventListener('input', validate);
        confirmPassInput.addEventListener('input', validate);

        document.getElementById('reset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validate()) return;

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="spinner"></span>';

            try {
                await confirmPasswordReset(auth, oobCode, newPassInput.value);
                showState(stateSuccess);
            } catch (err) {
                console.error('Reset error:', err);
                const code = err?.code || '';
                if (code === 'auth/expired-action-code') {
                    document.getElementById('error-msg').textContent = 'El enlace ha expirado. Volvé a la tienda y solicitá uno nuevo.';
                } else if (code === 'auth/invalid-action-code') {
                    document.getElementById('error-msg').textContent = 'Este enlace ya fue utilizado o es inválido. Solicitá uno nuevo.';
                } else if (code === 'auth/weak-password') {
                    document.getElementById('error-msg').textContent = 'La contraseña es muy débil. Usá al menos 6 caracteres.';
                } else {
                    document.getElementById('error-msg').textContent = err?.message || 'Error desconocido. Intentá de nuevo.';
                }
                showState(stateError);
            }
        });

        window.togglePass = function(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>';
            }
        };
    </script>
</body>
</html>
