import o,{useState as I,useEffect as V,useRef as j}from"react";import{Send as qe,X as ve,Trash2 as je,Plus as Ie}from"lucide-react";var Ee=({product:n,onAdd:S})=>{let[k,_]=I(1),F=n.basePrice*(1-(n.discount||0)/100);return o.createElement("div",{className:"min-w-[200px] max-w-[200px] bg-[#1a1a1a] rounded-2xl border border-white/5 overflow-hidden flex flex-col group snap-center"},o.createElement("div",{className:"relative h-28 bg-white p-2"},o.createElement("img",{src:n.image,className:"w-full h-full object-contain group-hover:scale-110 transition duration-500",alt:n.name}),n.discount>0&&o.createElement("div",{className:"absolute top-2 left-2 bg-red-600 text-white text-[10px] font-black px-2 py-0.5 rounded-full shadow-lg"},"-",n.discount,"%")),o.createElement("div",{className:"p-3 flex-1 flex flex-col"},o.createElement("h4",{className:"text-white font-bold text-xs line-clamp-2 mb-2 leading-tight h-8"},n.name),o.createElement("div",{className:"mt-auto"},o.createElement("div",{className:"flex items-center gap-2 mb-3"},o.createElement("span",{className:"text-yellow-500 font-black text-sm"},"$",Math.round(F).toLocaleString()),n.discount>0&&o.createElement("span",{className:"text-slate-500 text-[10px] line-through"},"$",n.basePrice.toLocaleString())),o.createElement("div",{className:"flex items-center gap-2"},o.createElement("div",{className:"flex bg-black/40 rounded-lg border border-white/5 overflow-hidden"},o.createElement("button",{onClick:()=>_(Math.max(1,k-1)),className:"px-2 py-1 text-slate-400 hover:text-white hover:bg-white/5 transition"},"-"),o.createElement("span",{className:"px-2 py-1 text-xs text-white font-bold min-w-[24px] text-center"},k),o.createElement("button",{onClick:()=>_(Math.min(n.stock||99,k+1)),className:"px-2 py-1 text-slate-400 hover:text-white hover:bg-white/5 transition"},"+")),o.createElement("button",{onClick:()=>S(n,k),className:"flex-1 bg-yellow-600 hover:bg-yellow-500 text-white py-1.5 rounded-lg text-[10px] font-black transition flex items-center justify-center gap-1 shadow-lg shadow-yellow-900/20"},o.createElement(Ie,{className:"w-3 h-3"})," LISTO")))))},De=o.memo(({settings:n,products:S,addToCart:k,controlPanel:_,coupons:F,appId:ye})=>{if(!(()=>{try{return String(window.location.href||"").includes("sustia=1")?!0:new URLSearchParams(window.location.search).get("sustia")==="1"}catch{return!1}})()&&n?.subscriptionPlan!=="premium")return null;let[E,ae]=I(!1),[W,re]=I(!1),Ne=n?.botImage||"sustia-ai-v2.jpg",$e=`sustore_sustia_chat_${ye}`,ne={role:"model",text:"Â¡Hola! Soy SustIA ðŸ¤–, tu asistente personal. Â¿Buscas algo especial hoy? Puedo verificar stock y agregar productos a tu carrito."},[D,M]=I([ne]),[X,ie]=I(""),[ce,le]=I(!1),P=j(null),ue=j(null),de=j(D),Y=j(!1),Z=j(null),Q=j(!0),$=Array.isArray(S)?S:[],ke=Array.isArray(F)?F:[];V(()=>{let s=()=>{try{re(document?.documentElement?.classList?.contains("dark-mode")===!0)}catch{re(!1)}};s();let c;try{c=new MutationObserver(()=>s()),document?.documentElement&&c.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]})}catch{}return()=>{try{c?.disconnect?.()}catch{}}},[]);let w=s=>s==null?"":String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(),Ae=s=>{let c=w(s);if(!c)return[];let t=c.split(/[\s,.;:!?/()\\[\]{}"â€œâ€'â€™\-+*_]+/).filter(Boolean),h=new Set(["el","la","los","las","un","una","unos","unas","de","del","en","con","sin","para","por","a","al","que","como","cual","cuales","donde","cuando","quien","quienes","hola","buenas","buenos","dia","dias","tardes","noches","busco","buscar","tenes","tienes","precio","vale","cuesta","quiero","necesito","hay","me","te","mi","mis","tu","tus","agrega","agregar","agregame","agregalo","sumar","sumame","poner","pone","comprar","compralo","llevo","carrito","bolsa","cesta","mas","menos","muy","super","re"]);return t.filter(p=>p.length>1&&!h.has(p)&&!/^\d+$/.test(p))},G=(s,c)=>{if(!s)return null;let t=parseFloat(String(s).replace(",","."));return Number.isFinite(t)?c.includes(`${s}k`)||c.includes(`${s} k`)||c.includes(`${s}mil`)||c.includes(`${s} mil`)?t*1e3:t:null},Pe=s=>{let c=w(s),t=c.match(/\b(?:x|por)\s*(\d{1,3})\b/);if(t)return Math.max(1,Math.min(99,parseInt(t[1],10)));let h=c.match(/\b(\d{1,3})\s*(?:u|ud|uds|unidad|unidades|pcs|piezas)\b/);if(h)return Math.max(1,Math.min(99,parseInt(h[1],10)));let p=c.match(/\b(\d{1,2})\b/);return p&&c.match(/\b(agrega|agregar|agregame|sum[aÃ¡]|pone|poner|met[eÃ©]|quiero|llevo|comprar)\b/)?Math.max(1,Math.min(99,parseInt(p[1],10))):1},L=s=>{let c=[];return Array.isArray(s?.categories)&&c.push(...s.categories),typeof s?.category=="string"&&s.category.trim()&&c.push(s.category),c.filter(Boolean).map(t=>String(t).trim()).filter(Boolean)},A=s=>{let c=Number(s?.basePrice)||0,t=Number(s?.discount)||0;return c*(1-t/100)};V(()=>{ue.current?.scrollIntoView({behavior:"smooth"})},[D,E]),V(()=>{de.current=D},[D]),V(()=>()=>{Q.current=!1},[]);let C=(s,c)=>{if(!c||typeof c!="string"||!s||typeof s!="string")return!1;let t=w(s),h=w(c);if(t.includes(h))return!0;let p=0,v=-1;for(let u of h){let b=t.indexOf(u,v+1);b>-1&&(p++,v=b)}return p/h.length>.75},Se=async(s,c)=>{await new Promise(e=>setTimeout(e,500+Math.random()*500));let t=w(s),h=String(s||"").trim(),p=Pe(t),v=P.current;v&&Date.now()-(v.ts||0)>3e5&&(P.current=null);let u=e=>{P.current={...e,ts:Date.now()}},b=()=>{P.current=null};if(t.length<=1)return P.current?{text:"No entendÃ­ bien, Â¿podÃ©s escribir un poco mÃ¡s?"}:{text:"Te leÃ­, pero me falta info ðŸ˜Š. Â¿QuÃ© estÃ¡s buscando? (ej: 'auriculares', 'zapatillas', 'envÃ­o', 'pagos')"};if(t.match(/\b(gracias|gracia|muchas gracias|thx|thanks)\b/)&&t.length<40)return b(),{text:"Â¡De nada! Si necesitÃ¡s algo mÃ¡s, acÃ¡ estoy ðŸ˜Š"};if(t.match(/\b(chau|adios|bye|nos vemos|hasta luego)\b/)&&t.length<30)return b(),{text:"Â¡Hasta la prÃ³xima! ðŸ‘‹ Cuando quieras, estoy acÃ¡."};if(t.match(/\b(hola|holas|buen dia|buenos dias|buenas tardes|buenas noches|buenas|hello|hi|hey|que tal|como estas|como va|todo bien)\b/)&&t.length<40)return b(),{text:"Â¡Hola! ðŸ‘‹ Â¿QuÃ© querÃ©s hacer? PodÃ©s pedirme productos, ofertas, cupones, envÃ­o, pagos o que agregue algo al carrito."};if(t.match(/\b(quien sos|que sos|que haces|sos real|sos un bot|asistente)\b/))return{text:`Soy SustIA${n?.storeName?` de **${n.storeName}**`:""}. Puedo ayudarte a encontrar productos, ver ofertas/cupones y armar el carrito mÃ¡s rÃ¡pido.`};if(_){if(t.match(/modo\s*(?:oscuro|noche|dark)/))return _.setDarkMode(!0),{text:"He activado el modo oscuro ðŸŒ™"};if(t.match(/modo\s*(?:claro|dia|light)/))return _.setDarkMode(!1),{text:"He activado el modo claro â˜€ï¸"};if(t.match(/(?:ver|abrir|ir al)\s*(?:carrito|bolsa|cesta)/))return _.openCart(),{text:"Abriendo tu carrito ðŸ›’"}}let T=!!t.match(/\b(envio|envios|entrega|delivery|domicilio|retiro|retirar|pickup|como llega|cuando llega|hacen envios|mandan)\b/),U=!!t.match(/\b(pago|pagos|tarjeta|mercado\s*pago|transferencia|cbu|alias|efectivo|como pago|formas? de pago|metodos? de pago)\b/),me=!!t.match(/\b(descuento|descuentos|promo|promos|cupon|cupones|oferta|ofertas|codigo|rebaja|rebajas)\b/),pe=!!t.match(/\b(categorias|categoria|rubros|rubro|secciones)\b/),fe=!!t.match(/\b(ayuda|soporte|contacto|human|persona|asesor|whatsapp)\b/),he=!!t.match(/\b(quienes somos|about)\b/)||!!t.match(/\b(sobre|informacion)\b/)&&!t.match(/\bsobre\s+(un|el|la|este|esta|ese|esa|esto)\b/),Le=T||U||me||pe||fe||he;if(P.current&&!Le){let e=P.current,r=!!t.match(/\b(si|sip|sep|claro|dale|bueno|yes|por favor|obvio|ok|sale|va|vamos|manda|quiero|mostrame|show)\b/),d=!!t.match(/\b(no|nah|paso|cancelar|nada|asi esta bien|despues|luego|no gracias|esta bien asi)\b/);if(e.action==="asked_location"){b();let l=h,{deliveryEnabled:f,pickupEnabled:i,deliveryFee:y,freeAbove:a,pickupAddress:m}=e.data||{},x=w(m),g=w(l),se=x&&(x.includes(g)||g.includes((x.split(",")[0]||"").trim())),N=[`ðŸ“ Para **${l}**:`];if(i&&se?N.push(`âœ… PodÃ©s retirar en nuestro local: **${m}**.`):i&&N.push(`ðŸª Tenemos retiro en local en **${m||"direcciÃ³n a coordinar"}**, pero queda en otra zona.`),f){let H=y>0?`$${y.toLocaleString()}`:"sin costo";N.push(`ðŸšš Hacemos envÃ­os a domicilio (${H}${a>0?`, gratis superando $${a.toLocaleString()}`:""}).`),N.push(`Para confirmar costo exacto a ${l}, avanzÃ¡ al checkout o consultanos.`)}return!i&&!f&&N.push("TodavÃ­a no tenemos envÃ­o configurado. Consultanos para coordinar."),n?.whatsappLink&&N.push(`
ðŸ’¬ CoordinÃ¡ por WhatsApp: ${n.whatsappLink}`),N.push(`
Â¿NecesitÃ¡s algo mÃ¡s? Puedo mostrarte productos, ofertas o medios de pago.`),{text:N.join(`
`)}}if(e.action==="showed_products"&&Array.isArray(e.shownProducts)&&e.shownProducts.length>0){let l=e.shownProducts,f=[{p:/\b(primero|primer|1ro|1ero|1Â°)\b/,i:0},{p:/\b(segundo|2do|2Â°)\b/,i:1},{p:/\b(tercero|tercer|3ro|3ero|3Â°)\b/,i:2},{p:/\b(cuarto|4to|4Â°)\b/,i:3},{p:/\b(ultimo|quinto|5to|5Â°)\b/,i:l.length-1}],i=null;for(let a of f)if(t.match(a.p)&&l[a.i]){i=l[a.i];break}if(!i&&t.match(/\b(ese|este|eso|esto)\b/)&&(i=l[0]),!i){let a=t.match(/\b(?:el|la|n[uÃº]mero)\s*(\d)\b/);a&&l[parseInt(a[1],10)-1]&&(i=l[parseInt(a[1],10)-1])}if(!i&&t.length>3&&(i=l.find(a=>{let m=w(a.name);return m.includes(t)||t.includes(m.split(" ")[0])})),!!t.match(/\b(agrega|agregar|agregame|agregalo|sum[aÃ¡]|sumale|pone|poner|met[eÃ©]|comprar|compralo|quiero|dame|llevo|lo quiero|al carrito|sumalo|mandalo)\b/)){let a=i||l[0];k(a,p);let m=l.filter(x=>x.id!==a.id).slice(0,3);return m.length>0?(u({action:"asked_yes_no",subAction:"cross_sell",data:m,shownProducts:m}),{text:`Â¡Listo! AgreguÃ© **${p}x ${a.name}** al carrito ðŸ›’

Â¿QuerÃ©s ver algo mÃ¡s para complementar?`,products:[a]}):(b(),{text:`Â¡Listo! AgreguÃ© **${p}x ${a.name}** al carrito ðŸ›’ Â¿Algo mÃ¡s?`,products:[a]})}if(i&&t.match(/\b(info|detalle|detalles|especif|descrip|cuenta|contame|mas sobre)\b/)){let a=i,m=A(a),x=L(a),g=[`ðŸ“¦ **${a.name}**`,`ðŸ’° $${Math.round(m).toLocaleString()}${(a.discount||0)>0?` (${a.discount}% OFF)`:""}`];return a.description&&g.push(`ðŸ“ ${String(a.description).slice(0,200)}`),x.length>0&&g.push(`ðŸ·ï¸ ${x.join(", ")}`),g.push(`ðŸ“Š Stock: ${a.stock||0} unidades`),g.push(`
Â¿Lo agregamos al carrito?`),u({action:"asked_yes_no",subAction:"add_product",data:a,shownProducts:l}),{text:g.join(`
`),products:[a]}}if(i){let a=i,m=A(a);return u({action:"asked_yes_no",subAction:"add_product",data:a,shownProducts:l}),{text:`**${a.name}** â€” $${Math.round(m).toLocaleString()}${(a.discount||0)>0?` (${a.discount}% OFF)`:""}

Â¿Lo agrego al carrito?`,products:[a]}}if(t.match(/\b(barato|economico|baratos|economicos|menor precio)\b/)){let a=[...l].sort((m,x)=>A(m)-A(x));return u({action:"showed_products",shownProducts:a,searchKeywords:e.searchKeywords}),{text:"Ordenados de mÃ¡s econÃ³mico a mÃ¡s caro:",products:a}}if(t.match(/\b(caro|caros|premium|mejor calidad|top|mejor)\b/)){let a=[...l].sort((m,x)=>A(x)-A(m));return u({action:"showed_products",shownProducts:a,searchKeywords:e.searchKeywords}),{text:"Las opciones de mayor precio/calidad:",products:a}}if(t.match(/\b(otro|otros|otras|mas opciones|ver mas|siguiente|siguientes|que mas hay|hay mas)\b/)){let a=new Set(l.map(g=>g.id)),m=$.filter(g=>!a.has(g.id)&&(Number(g.stock)||0)>0&&g.isActive!==!1);if(Array.isArray(e.searchKeywords)&&e.searchKeywords.length>0){let g=m.filter(se=>{let N=w(se.name);return e.searchKeywords.some(H=>N.includes(H)||C(N,H))});g.length>0&&(m=g)}let x=m.slice(0,5);return x.length>0?(u({action:"showed_products",shownProducts:x,searchKeywords:e.searchKeywords}),{text:"MÃ¡s opciones:",products:x}):{text:"No tengo mÃ¡s opciones con ese criterio. Â¿QuerÃ©s buscar otra cosa?"}}}if(e.action==="asked_yes_no"){if(r){if(b(),e.subAction==="cross_sell"&&Array.isArray(e.data))return{text:"Â¡MirÃ¡ estas opciones! ðŸ”¥",products:e.data};if(e.subAction==="show_deals"&&Array.isArray(e.data))return{text:"Las mejores ofertas ahora mismo:",products:e.data};if(e.subAction==="add_product"&&e.data)return k(e.data,p),{text:`Â¡Listo! AgreguÃ© **${p}x ${e.data.name}** al carrito ðŸ›’ Â¿Algo mÃ¡s?`,products:[e.data]}}if(d)return b(),{text:"Perfecto. Â¿NecesitÃ¡s algo mÃ¡s? ðŸ˜Š"}}if(e.action==="asked_category"){let f=[...new Set([...Array.isArray(n?.categories)?n.categories:[],...$.flatMap(i=>L(i))])].find(i=>C(w(i),t)||C(t,w(i)));if(f){let i=$.filter(y=>(Number(y.stock)||0)>0&&y.isActive!==!1&&L(y).some(a=>a.toLowerCase()===f.toLowerCase())).slice(0,5);return i.length>0?(u({action:"showed_products",shownProducts:i,searchKeywords:[]}),{text:`Productos en **${f}**:`,products:i}):{text:`No hay productos disponibles en "${f}" ahora. Â¿Buscamos otra categorÃ­a?`}}}}if(pe){let e=[...new Set($.flatMap(d=>L(d)))],r=[...new Set([...Array.isArray(n?.categories)?n.categories:[],...e])].map(d=>String(d).trim()).filter(Boolean);return r.length===0?{text:"TodavÃ­a no tengo categorÃ­as configuradas. Decime quÃ© estÃ¡s buscando y lo resuelvo igual."}:(u({action:"asked_category"}),{text:`Tenemos estas categorÃ­as:

${r.slice(0,10).map(d=>`- ${d}`).join(`
`)}

Decime cuÃ¡l te interesa y te muestro opciones.`})}if(he){let e=n?.aboutUsText||"";return e.trim()?{text:e.trim()}:{text:"Esta tienda todavÃ­a no cargÃ³ su secciÃ³n â€œSobre nosotrosâ€. Â¿QuerÃ©s que te ayude a encontrar un producto?"}}if(T){let e=!!n?.shippingDelivery?.enabled,r=!!n?.shippingPickup?.enabled,d=Number(n?.shippingDelivery?.fee)||0,l=Number(n?.shippingDelivery?.freeAbove)||0,f=n?.shippingPickup?.address||"",i=[];return r&&i.push(`ðŸ“ Retiro en local: ${f?`**${f}**`:"a coordinar"}.`),e&&(l>0?i.push(`ðŸšš EnvÃ­o a domicilio: $${d.toLocaleString()} (gratis desde $${l.toLocaleString()}).`):i.push(`ðŸšš EnvÃ­o a domicilio: $${d.toLocaleString()}.`)),!r&&!e&&i.push("TodavÃ­a no tengo configurado el mÃ©todo de entrega."),i.push("Si me decÃ­s tu ciudad/zona, te digo lo mejor para vos."),u({action:"asked_location",data:{deliveryEnabled:e,pickupEnabled:r,deliveryFee:d,freeAbove:l,pickupAddress:f}}),{text:i.join(`
`)}}if(U){let e=!!n?.paymentMercadoPago?.enabled,r=!!n?.paymentTransfer?.enabled,d=!!n?.paymentCash&&!!n?.shippingPickup?.enabled,l=r&&t.match(/\b(alias|cbu|transferencia)\b/),f=[];if(e&&f.push("ðŸ’³ Tarjeta (Mercado Pago)"),r&&f.push("ðŸ¦ Transferencia"),d&&f.push("ðŸ’µ Efectivo (solo retiro en local)"),f.length===0)return{text:"TodavÃ­a no tengo mÃ©todos de pago configurados."};if(l){let i=n?.paymentTransfer?.holderName?String(n.paymentTransfer.holderName).trim():"",y=n?.paymentTransfer?.alias?String(n.paymentTransfer.alias).trim():"",a=n?.paymentTransfer?.cbu?String(n.paymentTransfer.cbu).trim():"",m=["Para transferir, usÃ¡ estos datos:"];return i&&m.push(`- Titular: ${i}`),y&&m.push(`- Alias: ${y}`),a&&m.push(`- CBU: ${a}`),!i&&!y&&!a&&m.push("- AÃºn no estÃ¡n cargados los datos."),{text:m.join(`
`)}}return{text:`PodÃ©s pagar con:

${f.map(i=>`- ${i}`).join(`
`)}

Â¿Con cuÃ¡l preferÃ­s?`}}if(fe)return n?.whatsappLink?{text:`Claro. Si necesitas asistencia personalizada ðŸ§‘â€ðŸ’», escribinos a WhatsApp: ${n.whatsappLink} ðŸ“²`}:{text:"Estoy diseÃ±ado para ayudarte las 24hs ðŸ¤–. Â¿BuscÃ¡s algo en especÃ­fico?"};if(me){let e=ke.filter(d=>{if(!d?.code)return!1;let l=!d.expirationDate||new Date(d.expirationDate)>new Date,f=Array.isArray(d.usedBy)?d.usedBy.length:0,i=!d.usageLimit||f<d.usageLimit;return l&&i}),r=$.filter(d=>(Number(d?.discount)||0)>0&&(Number(d?.stock)||0)>0);return e.length>0?{text:`Â¡SÃ­! Tenemos estos cupones:

${e.map(l=>`ðŸŽ« **${l.code}** (${l.type==="percentage"?l.value+"%":"$"+l.value} OFF)`).join(`
`)}

Â¡Usalos al finalizar tu compra! ðŸ›’`}:r.length>0?(u({action:"asked_yes_no",subAction:"show_deals",data:r.sort(()=>.5-Math.random()).slice(0,5)}),{text:`No tengo cupones activos, pero hay **${r.length}** productos con descuento. Â¿QuerÃ©s verlos? ðŸ·ï¸`}):{text:"No tengo promociones activas ahora, pero nuestros precios son los mejores ðŸ˜‰"}}let R=t.match(/(?:mas|muy|super)\s*(?:barato|economico|bajo)|mas\s*economico/),be=t.match(/(?:mas|muy|super)\s*(?:caro|mejor|calidad|top|premium)|costoso|lujo/),ge=t.match(/(?:agrega|agregar|agregame|sum[aÃ¡]|pone|poner|met[eÃ©]|comprar|quiero|dame|carrito|llevo|lo quiero)/),xe=0,ee=1/0,we=t.match(/(?:menos|menor|bajo)\s*(?:de|a|que)?\s*\$?\s*(\d+(?:[.,]\d+)?)(?:\s*(?:k|mil))?/);if(we){let e=G(we[1],t);e!==null&&(ee=e)}let te=t.match(/entre\s*\$?\s*(\d+(?:[.,]\d+)?)(?:\s*(?:k|mil))?\s*y\s*\$?\s*(\d+(?:[.,]\d+)?)(?:\s*(?:k|mil))?/);if(te){let e=G(te[1],t),r=G(te[2],t);e!==null&&(xe=e),r!==null&&(ee=r)}let oe=[...new Set($.flatMap(e=>L(e)))].find(e=>C(e,t)||C(t,e)),K=oe?oe.toLowerCase():null,Te=new Map([["celu","celular"],["cel","celular"],["tele","televisor"],["tv","televisor"],["compu","computadora"],["notebook","laptop"],["auris","auriculares"],["zapas","zapatillas"],["remera","camiseta"],["remeras","camisetas"],["funda","funda"],["cable","cable"],["cargador","cargador"],["protector","protector"],["vidrio","vidrio templado"]]),z=Ae(t).flatMap(e=>{let r=Te.get(e);return r?[e,r]:[e]});if(z.length===0&&!K&&!R&&!be&&!ge){let e=$.filter(r=>(Number(r.stock)||0)>0&&r.isActive!==!1).find(r=>C(w(r.name),t));return e?(u({action:"showed_products",shownProducts:[e],searchKeywords:[t]}),{text:"Â¿BuscÃ¡s esto?",products:[e]}):{text:"Â¿Me decÃ­s quÃ© producto o categorÃ­a querÃ©s ver? TambiÃ©n podÃ©s preguntar por envÃ­o, pagos o cupones."}}let B=$.filter(e=>(Number(e?.stock)||0)>0&&e?.isActive!==!1);B=B.filter(e=>{let r=A(e);return r>=xe&&r<=ee}),K&&(B=B.filter(e=>L(e).some(r=>r.toLowerCase()===K)));let q=B.map(e=>{let r=0,d=w(e.name),l=w(e.description);return z.forEach(f=>{d.includes(f)?r+=10:C(d,f)&&(r+=5),l.includes(f)&&(r+=2)}),K&&!z.length&&(r+=5),e.isFeatured&&(r+=5),e.discount>0&&(r+=3),R&&(r+=1/(A(e)||1)*1e4),be&&(r+=A(e)/100),{product:e,score:r}}).filter(e=>e.score>0).sort((e,r)=>r.score-e.score).slice(0,5).map(e=>e.product);if(q.length===0){let e=$.filter(r=>(Number(r.discount)||0)>0&&(Number(r.stock)||0)>0).slice(0,3);return e.length>0?(u({action:"showed_products",shownProducts:e,searchKeywords:z}),{text:"No encontrÃ© eso exactamente, pero mirÃ¡ estas opciones con descuento:",products:e}):{text:"No encontrÃ© lo que buscÃ¡s. ProbÃ¡ con otra palabra o preguntame por categorÃ­as ðŸ”Ž"}}if(ge&&q.length>0){let e=q[0];k(e,p);let r=$.filter(d=>d.id!==e.id&&(Number(d.stock)||0)>0&&d.isActive!==!1).sort(()=>.5-Math.random()).slice(0,3);return r.length>0?(u({action:"asked_yes_no",subAction:"cross_sell",data:r,shownProducts:r}),{text:`Â¡Listo! AgreguÃ© **${p}x ${e.name}** al carrito ðŸ›’

Â¿QuerÃ©s ver algo para complementar? ðŸ‘€`,products:[e]}):(b(),{text:`Â¡Listo! AgreguÃ© **${p}x ${e.name}** al carrito ðŸ›’ Â¿Algo mÃ¡s?`,products:[e]})}u({action:"showed_products",shownProducts:q,searchKeywords:z});let O="EncontrÃ© estas opciones. Â¿QuerÃ©s que te muestre mÃ¡s o me decÃ­s un presupuesto?";return K&&(O=`EncontrÃ© esto en **${oe}**:`),R&&(O="Las opciones mÃ¡s econÃ³micas:"),q.length===1&&(O="EncontrÃ© esto para vos:"),{text:O,products:q}},_e=async(s,c)=>{let t=null,h=new Promise((p,v)=>{t=setTimeout(()=>v(new Error("timeout")),c)});try{return await Promise.race([s,h])}finally{t&&clearTimeout(t)}},J=async(s,c={})=>{let t=!!c.alreadyAddedUser,h=String(s||"").trim().slice(0,300);if(!h)return;if(Y.current){if(!t){let u={role:"client",text:h};M(b=>[...b,u])}Z.current={text:h,alreadyAddedUser:!0};return}Y.current=!0,ie("");let p=t?null:{role:"client",text:h},v=[...de.current||[],...p?[p]:[]];p&&M(u=>[...u,p]),le(!0);try{let u=await _e(Se(h,v),12e3);if(!Q.current)return;let b=u?.text&&typeof u.text=="string"?u.text:"PerdÃ³n, tuve un problema procesando eso. Â¿PodÃ©s reformularlo?",T=Array.isArray(u?.products)?u.products:void 0;M(U=>[...U,{role:"model",text:b,products:T}])}catch{if(!Q.current)return;let b=n?.whatsappLink?`Uy, se me trabÃ³ por un momento. Si querÃ©s, hablÃ¡ por WhatsApp: ${n.whatsappLink}`:"Uy, se me trabÃ³ por un momento. Â¿Probamos de nuevo?";M(T=>[...T,{role:"model",text:b}])}finally{Q.current&&le(!1),Y.current=!1;let u=Z.current;u&&u.text&&(Z.current=null,setTimeout(()=>J(u.text,{alreadyAddedUser:u.alreadyAddedUser===!0}),0))}},Ce=async()=>J(X),Me=s=>{let c=String(s||"").trim();c&&J(c)};return o.createElement("div",{className:"fixed bottom-4 right-4 z-[9999] flex flex-col items-end pointer-events-none"},E&&o.createElement("div",{className:"bg-[#0f0f0f]/95 backdrop-blur-2xl border border-white/10 rounded-[2rem] w-[calc(100vw-2rem)] sm:w-80 md:w-96 h-[min(600px,80dvh)] shadow-[0_20px_50px_rgba(0,0,0,0.5)] flex flex-col mb-4 animate-fade-up overflow-hidden font-sans pointer-events-auto ring-1 ring-white/10 relative mr-0 sm:mr-0"},o.createElement("div",{className:"bg-gradient-to-r from-yellow-500 to-amber-600 p-5 flex justify-between items-center relative z-10"},o.createElement("div",{className:"flex items-center gap-3"},o.createElement("div",{className:"p-1 bg-white/20 rounded-full backdrop-blur-md overflow-hidden border border-white/30"},o.createElement("img",{src:Ne,className:"w-9 h-9 object-cover rounded-full",alt:"SustIA"})),o.createElement("div",null,o.createElement("h3",{className:"font-black text-white text-sm tracking-tight"},"SustIA AI"),o.createElement("p",{className:"text-[10px] text-white/90 font-bold flex items-center gap-1.5"},o.createElement("span",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.8)]"}),"En lÃ­nea"))),o.createElement("div",{className:"flex items-center gap-1"},o.createElement("button",{onClick:()=>{try{localStorage.removeItem($e)}catch{}P.current=null,M([ne])},className:"text-white/80 hover:text-white p-2 hover:bg-white/10 rounded-full transition-colors",title:"Limpiar chat"},o.createElement(je,{className:"w-5 h-5"})),o.createElement("button",{onClick:()=>ae(!1),className:"text-white/80 hover:text-white p-2 hover:bg-white/10 rounded-full transition-colors",title:"Cerrar"},o.createElement(ve,{className:"w-5 h-5"})))),o.createElement("div",{className:`px-4 py-2 border-b ${W?"bg-[#111] border-white/5":"bg-slate-50 border-slate-200"}`},o.createElement("div",{className:"flex gap-2 overflow-x-auto pb-1 custom-scrollbar"},[{label:"Ofertas",value:"Mostrame ofertas"},{label:"Cupones",value:"TenÃ©s cupones?"},{label:"EnvÃ­o",value:"CÃ³mo es el envÃ­o?"},{label:"Pagos",value:"QuÃ© medios de pago hay?"},{label:"CategorÃ­as",value:"QuÃ© categorÃ­as tenÃ©s?"},{label:"WhatsApp",value:"Necesito hablar con una persona"}].map(s=>o.createElement("button",{key:s.label,type:"button","data-testid":`quick-action-${s.label.toLowerCase()}`,onClick:()=>{Me(s.value)},className:W?"shrink-0 px-3 py-1.5 rounded-full text-[11px] font-bold border border-white/10 bg-[#1a1a1a] text-white hover:bg-[#222] transition":"shrink-0 px-3 py-1.5 rounded-full text-[11px] font-bold border border-slate-200 bg-white text-slate-800 hover:bg-slate-50 transition"},o.createElement("span",{className:W?"text-white":"text-slate-800"},s.label))))),o.createElement("div",{className:"flex-1 overflow-y-auto p-5 space-y-6 bg-[#0a0a0a]/50 custom-scrollbar relative"},D.map((s,c)=>o.createElement("div",{key:c,className:`flex flex-col ${s.role==="client"?"items-end":"items-start"} animate-fade-in`},o.createElement("div",{className:`max-w-[85%] p-4 rounded-2xl text-[13px] leading-relaxed shadow-lg ${s.role==="client"?"bg-gradient-to-br from-yellow-500 to-amber-600 text-white rounded-tr-none border border-white/10":"bg-[#1a1a1a] text-slate-200 rounded-tl-none border border-white/5"}`},o.createElement("p",{className:"whitespace-pre-wrap"},s.text)),s.products&&s.products.length>0&&o.createElement("div",{className:"mt-3 flex gap-3 overflow-x-auto pb-2 w-full custom-scrollbar pl-1 snap-x"},s.products.map(t=>o.createElement(Ee,{key:t.id,product:t,onAdd:(h,p)=>{k(h,p),M(v=>[...v,{role:"model",text:`Agregado ${p}x ${h.name} al carrito! ðŸ›’`}])}}))))),ce&&o.createElement("div",{className:"flex justify-start"},o.createElement("div",{className:"bg-[#1a1a1a] p-3 rounded-2xl rounded-bl-none border border-white/5 flex gap-1"},o.createElement("span",{className:"w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce"}),o.createElement("span",{className:"w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),o.createElement("span",{className:"w-1.5 h-1.5 bg-slate-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}}))),o.createElement("div",{ref:ue})),o.createElement("div",{className:"p-3 bg-[#0a0a0a] border-t border-white/10 relative z-0"},o.createElement("form",{onSubmit:s=>{s.preventDefault(),Ce()},className:"flex gap-2 items-center"},o.createElement("input",{className:"flex-1 bg-[#1a1a1a] border border-white/10 rounded-full px-4 py-2.5 text-sm text-white focus:border-yellow-500/50 outline-none transition placeholder:text-slate-600",placeholder:"Escribe aquÃ­...",value:X,onChange:s=>ie(s.target.value)}),o.createElement("button",{type:"submit",className:"p-2.5 bg-yellow-600 hover:bg-yellow-500 text-white rounded-full transition shadow-lg shadow-yellow-600/20 disabled:opacity-50 disabled:cursor-not-allowed",disabled:ce||!X.trim()},o.createElement(qe,{className:"w-4 h-4"}))))),o.createElement("button",{onClick:()=>ae(!E),className:"pointer-events-auto w-14 h-14 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(234,179,8,0.4)] hover:scale-110 transition-transform group relative z-50"},E?o.createElement(ve,{className:"w-6 h-6 text-white"}):o.createElement("div",{className:"w-full h-full p-1"},o.createElement("img",{src:"sustia-ai-v2.jpg",className:"w-full h-full object-cover rounded-full opacity-95 group-hover:scale-110 transition-transform duration-300",alt:"SustIA"})),!E&&o.createElement("span",{className:"absolute -top-1 -right-1 flex h-4 w-4"},o.createElement("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"}),o.createElement("span",{className:"relative inline-flex rounded-full h-4 w-4 bg-yellow-500 border border-black"}))))},(n,S)=>!(n.settings?.subscriptionPlan!==S.settings?.subscriptionPlan||n.products!==S.products)),Ye=De;export{Ye as default};
//# sourceMappingURL=SustIABot-ODOYDSOX.js.map
