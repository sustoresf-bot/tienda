<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustore - Tecnolog√≠a Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
        .neon-text { text-shadow: 0 0 10px rgba(6, 182, 212, 0.7); }
        .neon-border { box-shadow: 0 0 5px rgba(6, 182, 212, 0.5), inset 0 0 5px rgba(6, 182, 212, 0.1); border-color: rgba(6, 182, 212, 0.5); }
        .neon-border:hover { box-shadow: 0 0 15px rgba(6, 182, 212, 0.8), inset 0 0 10px rgba(6, 182, 212, 0.2); border-color: #22d3ee; }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 30px -10px rgba(6, 182, 212, 0.3); }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; border-radius: 0.75rem; transition: all 0.3s; outline: none; }
        .input-dark:focus { border-color: #06b6d4; box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.15); background-color: #1e293b; }
        .animate-fade-up { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pulse-slow { animation: pulseSlow 4s infinite; }
        @keyframes pulseSlow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .toast-enter { animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .chat-bubble-user { background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); border-radius: 18px 18px 0 18px; }
        .chat-bubble-ai { background: #1e293b; border: 1px solid #334155; border-radius: 18px 18px 18px 0; }
        .chat-container { max-height: 80vh; bottom: 90px; }
        
        /* Admin specific styles */
        .admin-sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .admin-sidebar-link:hover, .admin-sidebar-link.active { background: rgba(6, 182, 212, 0.1); border-left-color: #06b6d4; color: white; }
        .admin-card { background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; }
        .bar-chart-container { display: flex; align-items: flex-end; gap: 8px; height: 60px; }
        .bar-chart-bar { width: 6px; background: #06b6d4; border-radius: 4px; opacity: 0.7; transition: height 0.5s; }
        .bar-chart-bar:hover { opacity: 1; transform: scaleY(1.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ShoppingBag, X, User, Search, Zap, CheckCircle, MessageCircle, Instagram, Minus, Heart, Tag, Plus, Trash2, Edit, AlertTriangle, RefreshCw, Brain, Ticket, LogOut, Mail, Lock, Gift, Copy, Save, AlertCircle, Menu, Home, Info, FileText, UserPlus, Shield, Smartphone, ArrowRight, ArrowLeft, DollarSign, Users, Package, LayoutDashboard, Settings, Bot, Send, HelpCircle, FileQuestion, LogIn, Eye, Truck, Phone, MapPin, CreditCard, ChevronRight, TrendingUp, Filter, BarChart3, Calendar, Download, Sparkles } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, getDocs, deleteDoc, where, writeBatch, getDoc } from 'firebase/firestore';

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAfllte-D_I3h3TwBaiSL4KVfWrCSVh9ro",
          authDomain: "sustore-63266.firebaseapp.com",
          projectId: "sustore-63266",
          storageBucket: "sustore-63266.firebasestorage.app",
          messagingSenderId: "684651914850",
          appId: "1:684651914850:web:f3df09e5caf6e50e9e533b",
          measurementId: "G-X3K7XGYPRD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "sustore-prod-v3";

        const defaultSettings = {
            storeName: "SUSTORE", primaryColor: "#06b6d4", currency: "$", admins: "lautarocorazza63@gmail.com", sellerEmail: "sustoresf@gmail.com", instagramUser: "sustore_sf", whatsappLink: "https://wa.me/message/3MU36VTEKINKP1", logoUrl: "", heroUrl: "", markupPercentage: 0, categories: ["Celulares", "Accesorios", "Audio", "Computaci√≥n", "Gaming", "Accesorios Gen√©ricos"], aboutUsText: "Somos una empresa dedicada a traer la mejor tecnolog√≠a al mejor precio."
        };

        const Toast = ({ message, type, onClose }) => {
            const styles = { success: 'border-green-500 bg-slate-900/95 text-green-400', error: 'border-red-500 bg-slate-900/95 text-red-400', info: 'border-cyan-500 bg-slate-900/95 text-cyan-400', warning: 'border-yellow-500 bg-slate-900/95 text-yellow-400' };
            useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
            return (<div className={`toast-enter flex items-center gap-3 p-4 rounded-xl border-l-4 shadow-2xl mb-3 max-w-sm w-full backdrop-blur-md ${styles[type] || styles.info} border border-slate-800 text-white relative group z-[999]`}><p className="text-sm font-medium pr-6 text-white">{message}</p><button onClick={onClose} className="absolute top-2 right-2 text-slate-500 hover:text-white"><X className="w-4 h-4" /></button></div>);
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-up">
                    <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl shadow-2xl max-w-sm w-full neon-border">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <p className="text-slate-400 mb-6 text-sm">{message}</p>
                        <div className="flex gap-3"><button onClick={onCancel} className="flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg font-bold transition">Cancelar</button><button onClick={onConfirm} className="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold transition shadow-lg shadow-red-500/20">Confirmar</button></div>
                    </div>
                </div>
            );
        };

        const OrderDetailsModal = ({ order, onClose, onToggleStatus, onDelete }) => {
            if (!order) return null;
            return (
                <div className="fixed inset-0 z-[160] flex items-center justify-center bg-black/90 backdrop-blur-md animate-fade-up p-4 overflow-y-auto">
                    <div className="bg-slate-900 border border-slate-700 rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
                            <div>
                                <h3 className="text-2xl font-bold text-white flex items-center gap-2">Pedido <span className="text-cyan-400">#{order.orderId}</span></h3>
                                <p className="text-slate-400 text-sm">{new Date(order.date).toLocaleString()}</p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-800 rounded-full text-slate-400 hover:text-white"><X className="w-6 h-6"/></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto space-y-6">
                            {/* ESTADO Y ACCIONES */}
                            <div className="flex flex-wrap gap-4 items-center justify-between bg-slate-800/30 p-4 rounded-xl border border-slate-700">
                                <div className="flex items-center gap-3">
                                    <span className={`px-3 py-1 rounded-full text-sm font-bold ${order.status === 'Realizado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>{order.status}</span>
                                    <span className="text-slate-400 text-sm font-mono">ID BD: {order.id}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => onToggleStatus(order)} className="px-4 py-2 bg-blue-600/20 text-blue-400 hover:bg-blue-600/40 rounded-lg text-sm font-bold transition">Cambiar Estado</button>
                                    <button onClick={() => onDelete(order)} className="px-4 py-2 bg-red-600/20 text-red-400 hover:bg-red-600/40 rounded-lg text-sm font-bold transition flex items-center gap-2"><Trash2 className="w-4 h-4"/> Eliminar y Restaurar Stock</button>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                {/* DATOS CLIENTE */}
                                <div className="space-y-4">
                                    <h4 className="text-cyan-400 font-bold uppercase text-xs tracking-wider border-b border-cyan-900/50 pb-2">Datos del Cliente</h4>
                                    <div className="bg-slate-800/50 p-4 rounded-xl space-y-2 text-sm">
                                        <div className="flex items-center gap-3"><User className="w-4 h-4 text-slate-500"/> <span className="text-white font-bold">{order.customer.name}</span></div>
                                        <div className="flex items-center gap-3"><div className="w-4 h-4 text-slate-500 text-xs font-bold text-center">@</div> <span className="text-slate-300">{order.customer.username}</span></div>
                                        <div className="flex items-center gap-3"><CreditCard className="w-4 h-4 text-slate-500"/> <span className="text-slate-300">DNI: {order.customer.dni}</span></div>
                                        <div className="flex items-center gap-3"><Mail className="w-4 h-4 text-slate-500"/> <span className="text-slate-300">{order.customer.email}</span></div>
                                        <div className="flex items-center gap-3"><Phone className="w-4 h-4 text-slate-500"/> <span className="text-slate-300">{order.customer.phone}</span></div>
                                    </div>
                                </div>

                                {/* DATOS ENVIO */}
                                <div className="space-y-4">
                                    <h4 className="text-purple-400 font-bold uppercase text-xs tracking-wider border-b border-purple-900/50 pb-2">Env√≠o y Pago</h4>
                                    <div className="bg-slate-800/50 p-4 rounded-xl space-y-2 text-sm">
                                        <div className="flex items-start gap-3"><MapPin className="w-4 h-4 text-slate-500 mt-1"/> <span className="text-slate-300">{order.shippingAddress}</span></div>
                                        <div className="flex items-center gap-3"><Truck className="w-4 h-4 text-slate-500"/> <span className="text-slate-300">M√©todo: Env√≠o a Domicilio</span></div>
                                        <div className="flex items-center gap-3"><DollarSign className="w-4 h-4 text-slate-500"/> <span className="text-slate-300">Pago: <span className="font-bold text-white">{order.paymentMethod}</span></span></div>
                                    </div>
                                </div>
                            </div>

                            {/* PRODUCTOS */}
                            <div>
                                <h4 className="text-white font-bold uppercase text-xs tracking-wider border-b border-slate-700 pb-2 mb-4">Productos ({order.items.length})</h4>
                                <div className="space-y-2">
                                    {order.items.map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center bg-slate-800 p-3 rounded-xl border border-slate-700">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 bg-slate-700 rounded-lg flex items-center justify-center text-xs font-bold text-white">{item.quantity}x</div>
                                                <div>
                                                    <p className="text-white font-bold text-sm">{item.title}</p>
                                                    <p className="text-slate-500 text-xs">ID Prod: {item.productId || 'N/A'}</p>
                                                </div>
                                            </div>
                                            <p className="text-cyan-400 font-bold text-sm">${item.unit_price.toLocaleString()}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* TOTALES */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col gap-2">
                                <div className="flex justify-between text-slate-400 text-sm"><span>Subtotal</span><span>${order.subtotal?.toLocaleString()}</span></div>
                                {order.discount > 0 && <div className="flex justify-between text-green-400 text-sm"><span>Descuento ({order.discountCode} - {order.discountPercent}%)</span><span>-${order.discount?.toLocaleString()}</span></div>}
                                <div className="border-t border-slate-700 pt-2 mt-2 flex justify-between text-xl font-black text-white"><span>Total</span><span>${order.total.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Loading = ({ message }) => (
            <div className="fixed inset-0 bg-[#020617]/95 z-[200] flex flex-col items-center justify-center backdrop-blur-md">
                <div className="relative">
                    <div className="absolute inset-0 bg-cyan-500 blur-xl opacity-20 animate-pulse"></div>
                    {message === 'EMAIL' ? <Mail className="w-16 h-16 text-cyan-400 animate-bounce relative z-10" /> : <RefreshCw className="w-16 h-16 text-cyan-400 animate-spin relative z-10" />}
                </div>
                <p className="text-cyan-400 text-lg font-bold tracking-[0.2em] mt-6 animate-pulse neon-text">{message || 'CARGANDO...'}</p>
            </div>
        );

        const AIChat = ({ products, onAddToCart, userName, onChangeView, onFilterCategory }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [isTyping, setIsTyping] = useState(false);
            const chatEndRef = useRef(null);

            // --- CEREBRO MEJORADO DE SUSTIA V2 ---
            // Base de conocimiento est√°tica para respuestas r√°pidas
            const knowledgeBase = [
                { keywords: ['hola', 'buen', 'dia', 'tarde', 'noche', 'hey'], response: "¬°Hola! üëã Soy SUSTIA, tu asistente virtual inteligente. Puedo ayudarte a encontrar productos, responder dudas sobre env√≠os o gestionar tu pedido. ¬øEn qu√© te ayudo hoy?" },
                { keywords: ['envio', 'envi', 'llegar', 'demora', 'tiempo'], response: "Realizamos env√≠os a todo el pa√≠s üöö. Los tiempos dependen de tu ubicaci√≥n, pero generalmente despachamos en 24hs h√°biles. ¬°Te avisaremos por WhatsApp!" },
                { keywords: ['pago', 'pagar', 'tarjeta', 'efectivo', 'transferencia', 'cuotas'], response: "Aceptamos Transferencia Bancaria (con descuento especial) y Efectivo. Estamos trabajando para integrar tarjetas pronto. üí≥" },
                { keywords: ['ubicacion', 'donde', 'local', 'direccion'], response: "Somos una tienda 100% online con base en Santa Fe. Hacemos env√≠os o coordinamos puntos de retiro. üìç" },
                { keywords: ['garantia', 'devolucion', 'cambio', 'roto'], response: "Todos nuestros productos tienen garant√≠a de f√°brica. Si tienes un problema, cont√°ctanos por WhatsApp y lo solucionamos al instante. üõ°Ô∏è" },
                { keywords: ['horario', 'atencion'], response: "¬°Estamos online 24/7! üåô‚òÄÔ∏è Pero respondemos consultas humanas de Lunes a S√°bado de 9:00 a 20:00hs." },
                { keywords: ['quien', 'eres', 'bot', 'ia'], response: "Soy SUSTIA ü§ñ, una IA entrenada para gestionar esta tienda y ayudarte con todo lo que necesites." },
                { keywords: ['ayuda', 'help'], response: "Puedo buscar productos (ej: 'busco iphone'), mostrarte categor√≠as (ej: 'ver audio'), o ayudarte con tu cuenta. ¬°Pru√©bame!" }
            ];

            useEffect(() => {
                if(isOpen && messages.length === 0) setMessages([{ role: 'ai', text: userName ? `¬°Hola ${userName}! üëã Soy SUSTIA 2.0. ¬øEn qu√© puedo ayudarte hoy?` : "¬°Hola! Soy SUSTIA ü§ñ. Estoy aqu√≠ para ayudarte a navegar, comprar y resolver dudas." }]);
            }, [isOpen, userName]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isTyping]);

            const processAI = async (text) => {
                const userMsg = { role: 'user', text };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setIsTyping(true);

                // Simulamos "pensamiento"
                setTimeout(() => {
                    const lower = text.toLowerCase();
                    let responseText = "";
                    let relatedProducts = [];
                    let actionTaken = false;

                    // 1. DETECCI√ìN DE COMANDOS DE NAVEGACI√ìN (INTENCIONES DE ACCI√ìN)
                    if (lower.includes('carrito') || lower.includes('cesta')) {
                        responseText = "Te llevo a tu carrito de compras ahora mismo. üõí";
                        onChangeView('cart');
                        actionTaken = true;
                    } else if (lower.includes('perfil') || lower.includes('cuenta') || lower.includes('mis datos')) {
                        responseText = "Abriendo tu perfil de usuario... üë§";
                        onChangeView('profile');
                        actionTaken = true;
                    } else if (lower.includes('inicio') || lower.includes('home') || lower.includes('tienda') || lower.includes('volver')) {
                        responseText = "Volviendo a la tienda principal. üè†";
                        onChangeView('store');
                        actionTaken = true;
                    } else if (lower.includes('cup√≥n') || lower.includes('descuento') || lower.includes('oferta')) {
                        responseText = "¬°Claro! Aqu√≠ tienes la secci√≥n de cupones para que ahorres. üéüÔ∏è";
                        onChangeView('coupons');
                        actionTaken = true;
                    } else if (lower.includes('guia') || lower.includes('como comprar')) {
                        responseText = "Te muestro nuestra gu√≠a de compra paso a paso. üìò";
                        onChangeView('guide');
                        actionTaken = true;
                    }

                    // 2. DETECCI√ìN DE FILTROS DE CATEGOR√çA
                    if (!actionTaken) {
                        const categories = ["celulares", "accesorios", "audio", "computaci√≥n", "gaming"];
                        for (const cat of categories) {
                            if (lower.includes(cat) || (cat === 'celulares' && (lower.includes('celu') || lower.includes('movil') || lower.includes('telefono')))) {
                                const targetCat = cat.charAt(0).toUpperCase() + cat.slice(1);
                                responseText = `He filtrado la tienda para mostrarte solo: ${targetCat}. üì±`;
                                onChangeView('store');
                                onFilterCategory(targetCat === 'Celulares' ? 'Celulares' : (targetCat === 'Computaci√≥n' ? 'Computaci√≥n' : targetCat)); 
                                onFilterCategory(categories.find(c => lower.includes(c)) || 'Celulares'); 
                                actionTaken = true;
                                break;
                            }
                        }
                    }

                    // 3. B√öSQUEDA DE PRODUCTOS (INTELIGENTE)
                    if (!actionTaken && (lower.includes('busco') || lower.includes('quiero') || lower.includes('precio') || lower.includes('tienes') || lower.includes('me recomiendas') || lower.length > 3)) {
                        // Palabras clave a ignorar para la b√∫squeda
                        const stopWords = ['busco', 'quiero', 'precio', 'tienes', 'un', 'una', 'el', 'la', 'de', 'para', 'que', 'me', 'recomiendas', 'algo', 'barato', 'caro'];
                        const searchTerms = lower.split(' ').filter(w => !stopWords.includes(w) && w.length > 2);
                        
                        if (searchTerms.length > 0) {
                            const matches = products.map(p => {
                                let score = 0;
                                const prodText = (p.name + ' ' + p.category + ' ' + (p.description || '')).toLowerCase();
                                searchTerms.forEach(term => {
                                    if (prodText.includes(term)) score += 2; 
                                });
                                return { product: p, score };
                            }).filter(res => res.score > 0).sort((a, b) => b.score - a.score);

                            if (matches.length > 0) {
                                relatedProducts = matches.slice(0, 3).map(m => m.product);
                                responseText = `He encontrado ${matches.length} productos que coinciden con lo que buscas. Aqu√≠ tienes los mejores: üëá`;
                            }
                        }
                    }

                    // 4. BASE DE CONOCIMIENTO (FALLBACK)
                    if (!responseText) {
                        const known = knowledgeBase.find(k => k.keywords.some(kw => lower.includes(kw)));
                        if (known) {
                            responseText = known.response;
                        } else {
                            // Respuesta por defecto inteligente
                            const defaultResponses = [
                                "Mmm, no estoy segura de entender eso. ¬øPodr√≠as ser m√°s espec√≠fico? ü§î Intenta 'busco auriculares' o 'ver celulares'.",
                                "Mis circuitos no procesaron eso. ü§ñ ¬øBuscas un producto espec√≠fico o tienes una duda sobre env√≠os?",
                                "A√∫n estoy aprendiendo. ¬øPodr√≠as preguntarlo de otra forma? Puedo ayudarte a buscar productos o navegar la tienda."
                            ];
                            responseText = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
                        }
                    }

                    setIsTyping(false);
                    setMessages(prev => [...prev, { role: 'ai', text: responseText, products: relatedProducts }]);
                }, 800 + Math.random() * 500); // Delay aleatorio para realismo
            };

            return (
                <>
                    <button onClick={() => setIsOpen(!isOpen)} className={`fixed bottom-6 right-6 z-[100] p-4 rounded-full shadow-[0_0_20px_rgba(6,182,212,0.6)] transition-all duration-300 hover:scale-110 ${isOpen ? 'bg-slate-800 text-cyan-400 rotate-90' : 'bg-cyan-600 text-white animate-bounce'}`}>
                        {isOpen ? <X className="w-6 h-6"/> : <Bot className="w-7 h-7"/>}
                    </button>
                    {isOpen && (
                        <div className="fixed bottom-24 right-4 md:right-6 w-[90%] md:w-96 bg-slate-900/95 backdrop-blur-xl border border-cyan-500/30 rounded-2xl shadow-2xl flex flex-col overflow-hidden z-[100] animate-fade-up chat-container">
                            <div className="p-4 bg-slate-800/50 border-b border-slate-700 flex items-center gap-3">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <div>
                                    <span className="font-bold text-white text-sm block">SUSTIA AI 2.0</span>
                                    <span className="text-[10px] text-cyan-400 font-mono">En l√≠nea | Inteligente</span>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex flex-col ${m.role === 'user' ? 'items-end' : 'items-start'}`}>
                                        <div className={`p-3 text-sm max-w-[85%] ${m.role === 'user' ? 'chat-bubble-user text-white' : 'chat-bubble-ai text-slate-300'}`}>{m.text}</div>
                                        {m.products && m.products.length > 0 && (
                                            <div className="mt-2 w-full max-w-[85%] space-y-2">
                                                {m.products.map(p => (
                                                    <div key={p.id} className="bg-slate-800 rounded-xl p-2 border border-slate-700 cursor-pointer hover:border-cyan-500 transition group flex gap-3 items-center" onClick={() => onAddToCart(p, 1)}>
                                                        <img src={p.image} className="w-12 h-12 object-cover rounded-lg"/>
                                                        <div className="flex-1 min-w-0">
                                                            <p className="font-bold text-xs text-white truncate">{p.name}</p>
                                                            <p className="text-cyan-400 font-bold text-xs">${Number(p.basePrice).toLocaleString()}</p>
                                                        </div>
                                                        <button className="bg-cyan-600/20 text-cyan-400 p-2 rounded-lg hover:bg-cyan-600 hover:text-white transition"><Plus className="w-4 h-4"/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {isTyping && (
                                    <div className="flex items-center gap-1 p-3 bg-slate-800/50 rounded-xl w-fit">
                                        <div className="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                        <div className="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                    </div>
                                )}
                                <div ref={chatEndRef}></div>
                            </div>
                            <form onSubmit={(e) => { e.preventDefault(); if(input.trim()) processAI(input); }} className="p-3 bg-slate-800/50 border-t border-slate-700 flex gap-2"><input className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 text-sm text-white focus:border-cyan-500 outline-none" placeholder="Escribe aqu√≠..." value={input} onChange={e => setInput(e.target.value)} /><button type="submit" className="p-2 bg-cyan-600 rounded-xl text-white hover:bg-cyan-500"><Send className="w-4 h-4"/></button></form>
                        </div>
                    )}
                </>
            );
        };

        function App() {
            const [view, setView] = useState('store');
            const [adminTab, setAdminTab] = useState('dashboard');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState(() => { try { return JSON.parse(localStorage.getItem('nexus_cart')) || []; } catch(e) { return []; } });
            const [users, setUsers] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [currentUser, setCurrentUser] = useState(() => { try { return JSON.parse(localStorage.getItem('nexus_user_data')); } catch(e) { return null; } }); 
            const [favorites, setFavorites] = useState([]);
            const [orders, setOrders] = useState([]);
            const [userOrders, setUserOrders] = useState([]);
            const [settings, setSettings] = useState(defaultSettings);
            const [systemUser, setSystemUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [productToDelete, setProductToDelete] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(''); 
            const [authError, setAuthError] = useState('');
            const [checkoutCoupon, setCheckoutCoupon] = useState('');
            const [appliedCoupon, setAppliedCoupon] = useState(null);
            const [aboutText, setAboutText] = useState('');
            const [toasts, setToasts] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            const [loginData, setLoginData] = useState({ identifier: '', password: '' }); 
            const [registerData, setRegisterData] = useState({ name: '', username: '', email: '', password: '', dni: '', phone: '' });
            const [checkoutData, setCheckoutData] = useState({ address: '', city: '', province: 'Santa Fe', zipCode: '', references: '', paymentChoice: '' });
            const [tempSettings, setTempSettings] = useState(defaultSettings);
            const [newProduct, setNewProduct] = useState({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 });
            const [newCoupon, setNewCoupon] = useState({ code: '', discountPercentage: 10, expirationDate: '', targetUser: '', usageLimit: '' });
            const [editingId, setEditingId] = useState(null);
            const [newCategory, setNewCategory] = useState('');
            const [editingUser, setEditingUser] = useState(null);
            const [newAdminEmail, setNewAdminEmail] = useState('');
            const [selectedOrder, setSelectedOrder] = useState(null); 
            const [adminSearch, setAdminSearch] = useState('');
            const [adminOrderFilter, setAdminOrderFilter] = useState('all');
            const [showProductForm, setShowProductForm] = useState(false);
            
            // --- NUEVOS ESTADOS PARA CUPONES ---
            const [couponTab, setCouponTab] = useState('global'); // 'global' o 'individual'
            const [couponSearch, setCouponSearch] = useState('');

            const fileInputRef = useRef(null);

            const showToast = (message, type = 'info') => { const id = Date.now(); setToasts(prev => [...prev, { id, message, type }]); };
            const removeToast = (id) => { setToasts(prev => prev.filter(t => t.id !== id)); };
            const confirmAction = (title, message, action) => { setModalConfig({ isOpen: true, title, message, onConfirm: () => { action(); setModalConfig({ ...modalConfig, isOpen: false }); } }); };

            useEffect(() => { localStorage.setItem('nexus_cart', JSON.stringify(cart)); }, [cart]);
            useEffect(() => { if (currentUser) localStorage.setItem('nexus_user_data', JSON.stringify(currentUser)); else localStorage.removeItem('nexus_user_data'); }, [currentUser]);
            useEffect(() => { if (currentUser) setCheckoutData(prev => ({ ...prev, address: currentUser.address || '', city: currentUser.city || '', zipCode: currentUser.zipCode || '' })); }, [currentUser]);
            
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (isLoading && !loadingMessage) {
                        setIsLoading(false);
                    }
                }, 5000); 
                return () => clearTimeout(timer);
            }, [isLoading]);

            useEffect(() => { const initAuth = async () => { await signInAnonymously(auth); }; initAuth(); return onAuthStateChanged(auth, setSystemUser); }, []);

            useEffect(() => {
                if (!systemUser) return;
                const prodUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (s) => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))), (e) => { console.error(e); setIsLoading(false); });
                const userUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const couponUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), (s) => setCoupons(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const orderUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => setOrders(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date))));
                const setUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), (s) => {
                    if (!s.empty) { const d = s.docs[0].data(); setSettings({ ...defaultSettings, ...d }); setTempSettings({ ...defaultSettings, ...d }); setAboutText(d.aboutUsText || defaultSettings.aboutUsText); } 
                    else { addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), defaultSettings).catch(e => console.log(e)); }
                    setIsLoading(false);
                }, (e) => { console.error(e); setIsLoading(false); });
                const savedId = localStorage.getItem('nexus_user_id');
                if (savedId && !currentUser) { 
                    getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('__name__', '==', savedId))).then(s => { 
                        if (!s.empty) { const u = {id: s.docs[0].id, ...s.docs[0].data()}; setCurrentUser(u); if (u.favorites) setFavorites(u.favorites); } else { localStorage.removeItem('nexus_user_id'); }
                    }).catch(() => {}); 
                }
                return () => { prodUnsub(); userUnsub(); orderUnsub(); setUnsub(); couponUnsub(); };
            }, [systemUser]);

            useEffect(() => { if (currentUser && orders.length > 0) setUserOrders(orders.filter(o => o.userId === currentUser.id)); }, [currentUser, orders]);

            const isAdmin = (email) => settings.admins && settings.admins.split(',').map(e => e.trim().toLowerCase()).includes(email?.toLowerCase());
            const calculatePrice = (basePrice, discount) => { return discount > 0 ? Math.ceil(Number(basePrice) * (1 - discount / 100)) : Number(basePrice); };
            
            const performAuth = async (isRegister) => {
                setAuthError(''); setIsLoading(true); setLoadingMessage('AUTENTICANDO...');
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    if (isRegister) {
                        if (!registerData.name || !registerData.username || !registerData.email || !registerData.password || !registerData.dni) { setIsLoading(false); return setAuthError("Faltan datos."); }
                        const qEmail = query(usersRef, where("email", "==", registerData.email));
                        const qUser = query(usersRef, where("username", "==", registerData.username));
                        const [snapEmail, snapUser] = await Promise.all([getDocs(qEmail), getDocs(qUser)]);
                        if (!snapEmail.empty) { setIsLoading(false); return setAuthError("Email registrado."); }
                        if (!snapUser.empty) { setIsLoading(false); return setAuthError("Usuario existe."); }
                        const newUser = { ...registerData, role: 'user', joinDate: new Date().toISOString(), favorites: [] };
                        const ref = await addDoc(usersRef, newUser);
                        const qDni = query(usersRef, where("dni", "==", registerData.dni));
                        const snapDni = await getDocs(qDni);
                        if (snapDni.size <= 1) { 
                            const code = `WELCOME-${registerData.username.toUpperCase()}`;
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), { code, discountPercentage: 7, expirationDate: new Date(Date.now() + 86400000*30).toISOString(), targetUser: registerData.email, usageLimit: 1, usedBy: [] });
                            showToast(`¬°Bienvenido! Cup√≥n: ${code}`, 'success');
                        }
                        const userWithId = { ...newUser, id: ref.id }; setCurrentUser(userWithId); localStorage.setItem('nexus_user_id', ref.id); localStorage.setItem('nexus_user_data', JSON.stringify(userWithId));
                    } else {
                        if (!loginData.identifier || !loginData.password) { setIsLoading(false); return setAuthError("Ingresa datos."); }
                        let qLogin = query(usersRef, where("email", "==", loginData.identifier), where("password", "==", loginData.password));
                        let snapLogin = await getDocs(qLogin);
                        if (snapLogin.empty) { qLogin = query(usersRef, where("username", "==", loginData.identifier), where("password", "==", loginData.password)); snapLogin = await getDocs(qLogin); }
                        if (!snapLogin.empty) { const u = { id: snapLogin.docs[0].id, ...snapLogin.docs[0].data() }; setCurrentUser(u); localStorage.setItem('nexus_user_id', u.id); localStorage.setItem('nexus_user_data', JSON.stringify(u)); if (u.favorites) setFavorites(u.favorites); showToast(`Hola ${u.name}!`, 'success'); } else { setIsLoading(false); return setAuthError("Credenciales incorrectas."); }
                    }
                    setView('store'); setAuthError('');
                } catch (e) { setAuthError("Error: " + e.message); }
                setIsLoading(false);
            };

            const onLoginSubmit = (e) => { e.preventDefault(); performAuth(false); };
            const onRegisterSubmit = (e) => { e.preventDefault(); performAuth(true); };
            const handleLogout = () => { localStorage.removeItem('nexus_user_id'); localStorage.removeItem('nexus_user_data'); localStorage.removeItem('nexus_cart'); setCurrentUser(null); setView('store'); setCart([]); setFavorites([]); setIsMenuOpen(false); showToast("Adi√≥s", 'info'); };

            // --- L√ìGICA DE STOCK ARREGLADA ---
            const manageCart = (prod, delta) => {
                const existingItem = cart.find(i => i.product.id === prod.id);
                const currentQty = existingItem ? existingItem.quantity : 0;
                const requestedQty = currentQty + delta;

                // 1. Verificaci√≥n estricta de stock antes de actualizar
                if (requestedQty > Number(prod.stock)) {
                    return showToast("¬°Sin stock suficiente!", 'warning');
                }

                // 2. Si la cantidad llega a 0, eliminar del carrito
                if (requestedQty <= 0) {
                    setCart(cart.filter(i => i.product.id !== prod.id));
                    return;
                }

                // 3. Actualizar estado de forma inmutable
                if (existingItem) {
                    setCart(cart.map(i => 
                        i.product.id === prod.id 
                        ? { ...i, quantity: requestedQty } 
                        : i
                    ));
                    if(delta > 0) showToast("Cantidad actualizada", 'success');
                } else {
                    setCart([...cart, { product: prod, quantity: 1 }]);
                    showToast("A√±adido al carrito", 'success');
                }
            };

            const cartSubtotal = cart.reduce((acc, item) => acc + (calculatePrice(item.product.basePrice, item.product.discount) * item.quantity), 0);
            const discountAmount = appliedCoupon ? Math.ceil(cartSubtotal * (appliedCoupon.discountPercentage / 100)) : 0;
            const cartTotal = cartSubtotal - discountAmount;

            const handleConfirmOrder = async () => {
                if (!currentUser) { setView('login'); return showToast("Inicia sesi√≥n", "info"); }
                if (!checkoutData.address || !checkoutData.city || !checkoutData.zipCode || !checkoutData.paymentChoice) return showToast("Faltan datos de env√≠o", 'warning');
                if (checkoutData.address.length < 5) return showToast("Direcci√≥n muy corta", 'warning');
                setLoadingMessage('EMAIL'); setIsLoading(true); let orderSaved = false;
                try {
                    const newOrder = {
                        orderId: `ORD-${Math.floor(Math.random()*100000)}`,
                        userId: currentUser.id, userEmail: currentUser.email,
                        customer: { name: currentUser.name, username: currentUser.username, email: currentUser.email, dni: currentUser.dni, phone: currentUser.phone },
                        total: cartTotal, subtotal: cartSubtotal, discount: discountAmount, discountCode: appliedCoupon ? appliedCoupon.code : null, discountPercent: appliedCoupon ? appliedCoupon.discountPercentage : 0,
                        items: cart.map(i => ({ productId: i.product.id, title: i.product.name, quantity: i.quantity, unit_price: calculatePrice(i.product.basePrice, i.product.discount) })), 
                        date: new Date().toISOString(), displayDate: new Date().toLocaleString(),
                        shippingAddress: `${checkoutData.address}, ${checkoutData.city} (CP: ${checkoutData.zipCode})`, paymentMethod: checkoutData.paymentChoice, status: 'Pendiente'
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);
                    orderSaved = true;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), { address: checkoutData.address, city: checkoutData.city, zipCode: checkoutData.zipCode });
                    
                    for (const item of cart) {
                         const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.product.id);
                         const snap = await getDoc(pRef);
                         if (snap.exists()) {
                             const currentStock = snap.data().stock;
                             await updateDoc(pRef, { stock: Math.max(0, currentStock - item.quantity) });
                         }
                    }
                    if (appliedCoupon) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'coupons', appliedCoupon.id), { usedBy: [...(appliedCoupon.usedBy || []), currentUser.id] }); }
                    const emailResponse = await fetch('/api/payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...newOrder, shipping: newOrder.shippingAddress, discountDetails: appliedCoupon ? { percentage: appliedCoupon.discountPercentage, amount: discountAmount } : null }) });
                    if (!emailResponse.ok) throw new Error('Error email');
                    showToast(`Pedido confirmado`, 'success'); setCart([]); setView('store'); setAppliedCoupon(null);
                } catch (error) { console.error(error); if (orderSaved) { showToast(`Guardado, pero error email: ${error.message}`, 'warning'); setCart([]); setView('store'); } else { showToast(`Error: ${error.message}`, 'error'); } }
                setIsLoading(false);
            };

            const applyCouponCode = (code) => {
                if(!code) return;
                const found = coupons.find(c => c.code.toUpperCase() === code.toUpperCase());
                if (!found) return showToast("Cup√≥n inv√°lido", 'error');
                if (new Date(found.expirationDate) < new Date()) return showToast("Vencido", 'warning');
                if (found.targetUser && found.targetUser.toLowerCase() !== currentUser.email.toLowerCase()) return showToast("No v√°lido para ti", 'error');
                if (found.usageLimit && found.usedBy && found.usedBy.length >= Number(found.usageLimit)) return showToast("Agotado", 'warning');
                if (found.usedBy && found.usedBy.includes(currentUser.id)) return showToast("Ya usado", 'warning');
                setAppliedCoupon(found); setCheckoutCoupon(code); showToast("Aplicado!", 'success');
            };

            const saveCoupon = async () => {
                if(!newCoupon.code || !newCoupon.expirationDate) return showToast("Faltan datos", 'warning'); setIsLoading(true);
                await addDoc(collection(db,'artifacts',appId,'public','data','coupons'), { code: newCoupon.code.toUpperCase(), discountPercentage: Number(newCoupon.discountPercentage), expirationDate: newCoupon.expirationDate, targetUser: newCoupon.targetUser || '', usageLimit: newCoupon.usageLimit || 9999, usedBy: [] });
                setNewCoupon({code:'', discountPercentage:10, expirationDate:'', targetUser: '', usageLimit: ''}); setIsLoading(false); showToast("Creado", 'success');
            };
            const deleteCouponAction = (id) => confirmAction("Eliminar", "¬øBorrar cup√≥n?", async () => { await deleteDoc(doc(db,'artifacts',appId,'public','data','coupons',id)); showToast("Eliminado", 'info'); });
            const saveProduct = async () => { 
                if(!newProduct.name) return showToast("Faltan datos", 'warning'); setIsLoading(true); 
                const pData={...newProduct, basePrice:Number(newProduct.basePrice), stock:Number(newProduct.stock), discount:Number(newProduct.discount||0), image:newProduct.image||'https://via.placeholder.com/150'}; 
                if(editingId) await updateDoc(doc(db,'artifacts',appId,'public','data','products',editingId), pData); else await addDoc(collection(db,'artifacts',appId,'public','data','products'), pData); 
                setNewProduct({name:'',basePrice:'',category:'',image:'',description:'',stock:'',discount:0}); setEditingId(null); setShowProductForm(false); if(fileInputRef.current) fileInputRef.current.value = ""; setIsLoading(false); showToast("Guardado", 'success');
            };
            const handleImage = (e) => { const f=e.target.files[0]; if(f&&f.size<1000000){const r=new FileReader();r.onload=()=>setNewProduct(p=>({...p,image:r.result}));r.readAsDataURL(f);}else showToast("Imagen pesada", 'error'); };
            const initiateDelete = (p) => confirmAction("Eliminar", `¬øBorrar ${p.name}?`, async () => { await deleteDoc(doc(db,'artifacts',appId,'public','data','products',p.id)); showToast("Borrado", 'info'); });
            const saveSettings = async () => { setIsLoading(true); const q=query(collection(db,'artifacts',appId,'public','data','settings')); const s=await getDocs(q); const d={...tempSettings, aboutUsText: aboutText}; if(!s.empty) await updateDoc(doc(db,'artifacts',appId,'public','data','settings',s.docs[0].id), d); else await addDoc(collection(db,'artifacts',appId,'public','data','settings'), d); showToast("Guardado", 'success'); setIsLoading(false); };
            const toggleOrder = async (o) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: o.status === 'Pendiente' ? 'Realizado' : 'Pendiente' }); showToast("Estado actualizado", 'info'); };
            
            const deleteOrder = (o) => {
                confirmAction("Eliminar Pedido", "Esto eliminar√° el pedido y devolver√° los productos al stock. ¬øConfirmar?", async () => {
                    setIsLoading(true);
                    try {
                        for (const item of o.items) {
                            if (item.productId) {
                                const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.productId);
                                const pSnap = await getDoc(pRef);
                                if (pSnap.exists()) {
                                    const current = pSnap.data().stock;
                                    await updateDoc(pRef, { stock: current + item.quantity });
                                }
                            }
                        }
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id));
                        showToast("Pedido eliminado y stock restaurado", 'success');
                        if (selectedOrder) setSelectedOrder(null);
                    } catch (e) {
                        console.error(e);
                        showToast("Error al eliminar", 'error');
                    }
                    setIsLoading(false);
                });
            };

            const addAdmin = () => { if(!newAdminEmail) return; setTempSettings({...tempSettings, admins: (settings.admins||"") + "," + newAdminEmail }); setNewAdminEmail(''); showToast("Admin agregado", 'info'); };
            const toggleFavorite = async (pid) => { let n; const isAdding = !favorites.includes(pid); if(favorites.includes(pid)) n=favorites.filter(id=>id!==pid); else n=[...favorites, pid]; setFavorites(n); if(currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), {favorites:n}); else localStorage.setItem('nexus_favs', JSON.stringify(n)); showToast(isAdding ? "Favorito" : "Eliminado", 'info'); };
            const saveUserEdit = async () => { if (!editingUser) return; setIsLoading(true); try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUser.id), { name: editingUser.name, username: editingUser.username, email: editingUser.email, dni: editingUser.dni, phone: editingUser.phone }); showToast("Usuario actualizado", 'success'); setEditingUser(null); } catch (e) { showToast("Error", 'error'); } setIsLoading(false); };
            const goIg = () => window.open(`https://www.instagram.com/${settings.instagramUser}/`, '_blank');
            const goWsp = () => window.open(settings.whatsappLink, '_blank');
            const handleEditProduct = (p) => { setNewProduct({...p, basePrice: p.basePrice}); setEditingId(p.id); setShowProductForm(true); };
            const handleEditUser = (user) => setEditingUser({ ...user });
            const addCategory = () => { if(newCategory && !tempSettings.categories.includes(newCategory)) { setTempSettings({...tempSettings, categories:[...tempSettings.categories, newCategory]}); setNewCategory(''); } };
            const removeCategory = (c) => setTempSettings({...tempSettings, categories: tempSettings.categories.filter(x => x!==c)});

            const totalRevenue = orders.reduce((acc, o) => acc + (o.total || 0), 0);

            // Filtro de cupones v√°lidos para el usuario
            const availableCoupons = coupons.filter(c => {
                 if (new Date(c.expirationDate) < new Date()) return false;
                 if (c.targetUser && currentUser && c.targetUser.toLowerCase() !== currentUser.email.toLowerCase()) return false;
                 if (currentUser && c.usedBy.includes(currentUser.id)) return false;
                 return true;
            });

            return (
                <div className="min-h-screen bg-[#020617] text-slate-100 font-sans flex flex-col relative overflow-hidden">
                    <div className="fixed inset-0 z-0 pointer-events-none">
                        <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-[#020617]"></div>
                        <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-600/10 rounded-full blur-[120px] animate-pulse-slow"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cyan-600/10 rounded-full blur-[120px] animate-pulse-slow" style={{animationDelay: '2s'}}></div>
                    </div>

                    <div className="fixed top-20 right-4 z-[300] flex flex-col items-end pointer-events-none">{toasts.map(t => (<div key={t.id} className="pointer-events-auto"><Toast message={t.message} type={t.type} onClose={() => removeToast(t.id)} /></div>))}</div>
                    <ConfirmModal isOpen={modalConfig.isOpen} title={modalConfig.title} message={modalConfig.message} onConfirm={modalConfig.onConfirm} onCancel={() => setModalConfig({ ...modalConfig, isOpen: false })} />
                    <OrderDetailsModal order={selectedOrder} onClose={() => setSelectedOrder(null)} onToggleStatus={toggleOrder} onDelete={deleteOrder} />
                    {isLoading && <Loading message={loadingMessage} />}
                    {view !== 'admin' && <AIChat products={products} onAddToCart={manageCart} userName={currentUser?.name?.split(' ')[0]} onChangeView={setView} onFilterCategory={setSelectedCategory} />}

                    {/* HEADER SE OCULTA EN ADMIN PARA DAR MAS ESPACIO */}
                    {view !== 'admin' && (
                        <header className="fixed top-0 w-full z-40 glass-panel h-16 flex items-center justify-between px-4 lg:px-8 shadow-lg border-b border-cyan-900/30">
                            <div className="flex items-center gap-4 flex-1">
                                <div onClick={() => setView('store')} className="cursor-pointer font-black text-2xl tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400 drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">SUSTORE</div>
                                <div className="flex items-center bg-slate-900/80 border border-slate-700 rounded-full px-4 py-2 w-full max-w-md focus-within:border-cyan-500 focus-within:shadow-[0_0_15px_rgba(6,182,212,0.3)] transition-all duration-300 ml-2">
                                    <Search className="w-4 h-4 mr-2 text-slate-400" /><input className="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-500" placeholder="Buscar..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={goWsp} className="hidden md:block text-green-400 hover:scale-110 transition"><MessageCircle className="w-6 h-6"/></button>
                                <button onClick={goIg} className="hidden md:block text-pink-400 hover:scale-110 transition"><Instagram className="w-6 h-6"/></button>
                                <button onClick={() => setView('favorites')} className="text-slate-400 hover:text-red-400 transition"><Heart className={`w-6 h-6 ${favorites.length > 0 ? 'fill-red-500 text-red-500' : ''}`} /></button>
                                <button onClick={() => setView('cart')} className="relative text-slate-300 hover:text-cyan-400 transition"><ShoppingBag className="w-6 h-6" />{cart.length > 0 && <span className="absolute -top-1 -right-1 bg-cyan-500 text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center border border-slate-900 shadow-[0_0_10px_rgba(6,182,212,0.8)]">{cart.length}</span>}</button>
                                {currentUser ? (
                                    <div onClick={() => setView('profile')} className="w-9 h-9 bg-gradient-to-br from-cyan-600 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xs cursor-pointer hover:shadow-[0_0_15px_rgba(6,182,212,0.6)] transition border border-white/10">{(currentUser.username || "U")[0].toUpperCase()}</div>
                                ) : (
                                    <button onClick={() => setView('login')} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded-full border border-slate-700 transition text-sm font-bold text-white"><User className="w-4 h-4"/> <span className="hidden md:inline">Entrar</span></button>
                                )}
                                <button onClick={() => setIsMenuOpen(true)} className="text-slate-300 hover:text-white ml-2">
                                    <Menu className="w-7 h-7" />
                                </button>
                            </div>
                        </header>
                    )}
                    {view !== 'admin' && <div className="h-20"></div>}

                    <main className={`flex-grow ${view !== 'admin' ? 'p-4' : 'h-screen'} relative z-10 overflow-hidden`}>
                        {view === 'store' && (
                             <div className="animate-fade-up max-w-7xl mx-auto">
                                 <div className="relative w-full h-64 md:h-80 rounded-3xl overflow-hidden mb-8 shadow-2xl border border-cyan-500/20 group">
                                     <div className="absolute inset-0 bg-gradient-to-r from-slate-900 via-slate-900/80 to-transparent z-10"></div>
                                     <img src="https://images.unsplash.com/photo-1550009158-9ebf69173e03?q=80&w=2000&auto=format&fit=crop" className="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105" alt="Tech Banner"/>
                                     <div className="absolute inset-0 z-20 flex flex-col justify-center px-8 md:px-16">
                                         <h1 className="text-4xl md:text-6xl font-black text-white mb-2 drop-shadow-lg neon-text">SUSTORE</h1>
                                         <p className="text-slate-300 mb-6 max-w-md text-lg">La mejor tecnolog√≠a al alcance de tu mano.</p>
                                         <p className="text-cyan-400 font-bold tracking-widest text-sm mb-4 animate-pulse">¬°NUEVO: ACCESORIOS GEN√âRICOS!</p>
                                         <button onClick={() => {document.getElementById('products-grid').scrollIntoView({behavior:'smooth'})}} className="w-fit px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-full shadow-[0_0_20px_rgba(6,182,212,0.5)] transition flex items-center gap-2">Ver Cat√°logo <ArrowRight className="w-4 h-4"/></button>
                                     </div>
                                 </div>
                                 <div className="flex gap-3 overflow-x-auto pb-6 mb-2 no-scrollbar">
                                     <button onClick={() => setSelectedCategory('')} className={`px-6 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all duration-300 ${selectedCategory === '' ? 'bg-cyan-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>Todos</button>
                                     {settings.categories.map(cat => (<button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-6 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all duration-300 ${selectedCategory === cat ? 'bg-cyan-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{cat}</button>))}
                                 </div>
                                 <div id="products-grid" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                     {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) && (selectedCategory === '' || p.category === selectedCategory)).map(p => (
                                         <div key={p.id} className="bg-slate-900/50 backdrop-blur-sm rounded-3xl overflow-hidden border border-slate-800 neon-border card-hover group relative">
                                             <div className="h-56 overflow-hidden relative p-4 bg-slate-950/50">
                                                 <img src={p.image} className="w-full h-full object-contain drop-shadow-2xl transition-transform duration-500 group-hover:scale-110"/>
                                                 <button onClick={() => toggleFavorite(p.id)} className="absolute top-4 right-4 p-2 bg-black/40 backdrop-blur-md rounded-full text-white hover:text-red-500 transition"><Heart className={`w-5 h-5 ${favorites.includes(p.id) ? 'fill-red-500 text-red-500' : ''}`}/></button>
                                                 {p.discount > 0 && <span className="absolute top-4 left-4 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg">-{p.discount}%</span>}
                                             </div>
                                             <div className="p-5 relative">
                                                 <div className="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent opacity-50"></div>
                                                 <p className="text-xs text-cyan-400 font-bold uppercase mb-1 tracking-wider relative z-10">{p.category}</p>
                                                 <h3 className="font-bold text-white text-lg mb-3 truncate relative z-10">{p.name}</h3>
                                                 <div className="flex justify-between items-center relative z-10">
                                                     <div className="flex flex-col">
                                                         {p.discount > 0 && <span className="text-xs text-slate-500 line-through">${Number(p.basePrice).toLocaleString()}</span>}
                                                         <span className="text-2xl font-black text-white drop-shadow-md">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</span>
                                                     </div>
                                                     <button onClick={() => manageCart(p, 1)} className="bg-white text-slate-900 p-3 rounded-xl hover:bg-cyan-400 hover:text-white transition shadow-lg"><Plus className="w-5 h-5"/></button>
                                                 </div>
                                             </div>
                                         </div>
                                     ))}
                                 </div>
                                 
                                 {/* FOOTER A√ëADIDO */}
                                 <footer className="mt-12 py-8 border-t border-slate-800 text-center relative z-10 bg-slate-900/50 backdrop-blur-sm">
                                    <div className="flex justify-center gap-6 mb-4">
                                        <button onClick={goWsp} className="p-3 bg-slate-800 rounded-full hover:bg-green-600 text-slate-400 hover:text-white transition shadow-lg"><MessageCircle className="w-6 h-6"/></button>
                                        <button onClick={goIg} className="p-3 bg-slate-800 rounded-full hover:bg-pink-600 text-slate-400 hover:text-white transition shadow-lg"><Instagram className="w-6 h-6"/></button>
                                    </div>
                                    <p className="text-slate-500 text-sm">¬© 2024 {settings.storeName}. Todos los derechos reservados.</p>
                                 </footer>
                             </div>
                        )}
                        
                        {/* OTRAS VISTAS DEL USUARIO (CART, CHECKOUT, ETC) SE MANTIENEN IGUAL */}
                        {view === 'cart' && (
                            <div className="max-w-5xl mx-auto animate-fade-up">
                                <h2 className="text-3xl font-bold mb-8 text-white flex items-center gap-3 neon-text"><ShoppingBag className="text-cyan-400 w-8 h-8"/> Tu Carrito</h2>
                                {cart.length === 0 ? (
                                    <div className="text-center py-32 bg-slate-900/30 rounded-[2rem] border border-slate-700 border-dashed backdrop-blur-sm"><ShoppingBag className="w-24 h-24 text-slate-700 mx-auto mb-6"/><p className="text-slate-400 text-xl mb-8">Tu carrito est√° vac√≠o.</p><button onClick={() => setView('store')} className="bg-cyan-600 text-white px-10 py-4 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg">Explorar Tienda</button></div>
                                ) : (
                                    <div className="grid gap-8 lg:grid-cols-3">
                                        <div className="lg:col-span-2 space-y-4">
                                            {cart.map((item) => (
                                                <div key={item.product.id} className="bg-slate-900/60 p-4 rounded-2xl border border-slate-700/50 flex gap-6 items-center hover:border-cyan-500/30 transition backdrop-blur-md">
                                                    <img src={item.product.image} className="w-24 h-24 rounded-xl object-cover bg-slate-950 border border-slate-800"/>
                                                    <div className="flex-1 min-w-0"><h3 className="font-bold text-white text-lg truncate mb-1">{item.product.name}</h3><p className="text-cyan-400 font-bold text-lg">${calculatePrice(item.product.basePrice, item.product.discount).toLocaleString()}</p></div>
                                                    <div className="flex items-center gap-3 bg-slate-950 rounded-xl p-2 border border-slate-800">
                                                        <button onClick={() => manageCart(item.product, -1)} className="p-2 hover:text-cyan-400 transition"><Minus className="w-4 h-4"/></button><span className="font-bold w-6 text-center text-lg">{item.quantity}</span><button onClick={() => manageCart(item.product, 1)} className="p-2 hover:text-cyan-400 transition"><Plus className="w-4 h-4"/></button>
                                                    </div>
                                                    <button onClick={() => manageCart(item.product, -item.quantity)} className="p-3 text-slate-500 hover:text-red-400 hover:bg-slate-950 rounded-xl transition"><Trash2 className="w-5 h-5"/></button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="bg-slate-900/80 p-8 rounded-3xl border border-slate-700 h-fit sticky top-24 backdrop-blur-xl shadow-2xl">
                                            <h3 className="font-bold text-white mb-6 text-xl tracking-wide">RESUMEN</h3>
                                            <div className="flex justify-between text-slate-400 mb-3 text-sm"><span>Subtotal</span><span>${cartSubtotal.toLocaleString()}</span></div>
                                            {appliedCoupon && <div className="flex justify-between text-green-400 mb-3 text-sm font-bold"><span>Descuento ({appliedCoupon.code})</span><span>-${discountAmount.toLocaleString()}</span></div>}
                                            <div className="border-t border-slate-700 my-6"></div>
                                            <div className="flex justify-between font-black text-2xl text-white mb-8"><span>Total</span><span className="text-cyan-400">${cartTotal.toLocaleString()}</span></div>
                                            <button onClick={() => setView('checkout')} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 py-4 rounded-xl font-bold text-white hover:from-cyan-500 hover:to-blue-500 shadow-lg transition">Finalizar Compra <ArrowRight className="w-5 h-5"/></button>
                                            <button onClick={() => setView('store')} className="w-full mt-4 py-3 text-slate-400 hover:text-white transition text-sm flex items-center justify-center gap-2"><ArrowLeft className="w-4 h-4"/> Seguir Mirando</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {view === 'checkout' && (
                            <div className="max-w-2xl mx-auto animate-fade-up pb-20">
                                <div className="flex items-center gap-4 mb-8"><button onClick={() => setView('cart')} className="p-3 bg-slate-800 rounded-xl text-slate-400 hover:text-white hover:bg-slate-700 transition"><ArrowLeft className="w-6 h-6"/></button><h2 className="text-3xl font-bold text-white">Confirmar Pedido</h2></div>
                                <div className="space-y-6">
                                    <div className="bg-slate-900/60 p-6 rounded-3xl border border-slate-700/50 backdrop-blur-sm">
                                        <h3 className="text-sm font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><Tag className="w-4 h-4 text-purple-400"/> Cupones</h3>
                                        <div className="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
                                            {coupons.filter(c => ((!c.targetUser || (currentUser && c.targetUser.toLowerCase() === currentUser.email.toLowerCase())) && (!currentUser || !c.usedBy.includes(currentUser.id)) && new Date(c.expirationDate) > new Date())).map(c => (
                                                <button key={c.id} onClick={() => applyCouponCode(c.code)} className="flex items-center gap-2 bg-purple-900/20 border border-purple-500/30 px-4 py-2 rounded-xl hover:bg-purple-900/40 hover:border-purple-500 transition whitespace-nowrap group">
                                                    <span className="font-bold text-purple-400 text-sm group-hover:text-purple-300">{c.code}</span><span className="bg-purple-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded">-{c.discountPercentage}%</span>
                                                </button>
                                            ))}
                                            {coupons.length === 0 && <p className="text-xs text-slate-500">No hay cupones disponibles.</p>}
                                        </div>
                                        <div className="flex gap-2"><input className="flex-1 input-dark p-4 uppercase tracking-widest text-sm" placeholder="O INGRESA C√ìDIGO" value={checkoutCoupon} onChange={e => setCheckoutCoupon(e.target.value)}/><button onClick={() => applyCouponCode(checkoutCoupon)} className="bg-slate-800 hover:bg-purple-600 hover:text-white text-slate-400 px-6 rounded-xl font-bold text-sm transition">APLICAR</button></div>
                                    </div>
                                    <div className="bg-slate-900/60 p-8 rounded-3xl border border-slate-700/50 backdrop-blur-sm">
                                        <h3 className="text-lg font-bold text-white mb-6 flex items-center gap-2"><div className="w-8 h-8 bg-blue-600/20 rounded-lg flex items-center justify-center text-blue-400"><Package className="w-5 h-5"/></div> Datos de Env√≠o</h3>
                                        <div className="space-y-4">
                                            <input className="w-full input-dark p-4" placeholder="Direcci√≥n (Calle, Altura, Piso)" value={checkoutData.address} onChange={e => setCheckoutData({...checkoutData, address: e.target.value})}/>
                                            <div className="grid grid-cols-2 gap-4"><input className="w-full input-dark p-4" placeholder="Ciudad" value={checkoutData.city} onChange={e => setCheckoutData({...checkoutData, city: e.target.value})}/><input className="w-full input-dark p-4" placeholder="C√≥digo Postal" value={checkoutData.zipCode} onChange={e => setCheckoutData({...checkoutData, zipCode: e.target.value})}/></div>
                                            <div className="grid grid-cols-2 gap-4 pt-2">
                                                <button onClick={() => setCheckoutData({...checkoutData, paymentChoice: 'Transferencia'})} className={`p-4 rounded-2xl border transition flex flex-col items-center gap-2 ${checkoutData.paymentChoice === 'Transferencia' ? 'border-cyan-500 bg-cyan-900/20 text-white shadow-lg' : 'border-slate-700 text-slate-400 hover:bg-slate-800'}`}><RefreshCw className="w-6 h-6"/> <span className="text-xs font-bold">Transferencia</span></button>
                                                <button onClick={() => setCheckoutData({...checkoutData, paymentChoice: 'Efectivo'})} className={`p-4 rounded-2xl border transition flex flex-col items-center gap-2 ${checkoutData.paymentChoice === 'Efectivo' ? 'border-cyan-500 bg-cyan-900/20 text-white shadow-lg' : 'border-slate-700 text-slate-400 hover:bg-slate-800'}`}><Zap className="w-6 h-6"/> <span className="text-xs font-bold">Efectivo</span></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-r from-slate-900 to-slate-800 p-6 rounded-3xl border border-cyan-900/50 flex justify-between items-center shadow-2xl"><div className="text-sm text-slate-400">Total a Pagar</div><div className="text-3xl font-black text-white neon-text">${cartTotal.toLocaleString()}</div></div>
                                    <button onClick={handleConfirmOrder} className="w-full py-5 bg-green-600 hover:bg-green-500 text-white font-bold rounded-2xl shadow-lg mt-4 flex items-center justify-center gap-3 text-lg transform hover:scale-[1.01] transition duration-300"><CheckCircle className="w-6 h-6"/> CONFIRMAR PEDIDO</button>
                                </div>
                            </div>
                        )}
                        {view === 'coupons' && (
                            <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-3xl font-bold mb-8 text-white flex items-center gap-3"><Ticket className="text-cyan-400 w-8 h-8"/> Cupones Disponibles</h2>
                                {availableCoupons.length === 0 ? (
                                    <div className="p-8 bg-slate-900/50 rounded-3xl border border-slate-800 text-center">
                                        <p className="text-slate-400 text-lg">No hay cupones activos para ti en este momento.</p>
                                        <button onClick={() => setView('store')} className="mt-4 text-cyan-400 font-bold hover:underline">Volver a la tienda</button>
                                    </div>
                                ) : (
                                    <div className="grid gap-4 md:grid-cols-2">
                                        {availableCoupons.map(c => (
                                            <div key={c.id} className="relative bg-slate-900 border border-purple-900/50 p-6 rounded-2xl flex justify-between items-center overflow-hidden group hover:border-purple-500/50 transition">
                                                <div className="absolute top-0 right-0 w-24 h-24 bg-purple-600/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                                                <div>
                                                    <p className="text-slate-400 text-xs uppercase tracking-widest mb-1">Cup√≥n de Descuento</p>
                                                    <h3 className="text-3xl font-black text-white mb-2">{c.discountPercentage}% OFF</h3>
                                                    <div className="flex items-center gap-2 bg-slate-950 px-3 py-1 rounded-lg border border-slate-800">
                                                        <code className="text-purple-400 font-bold tracking-wider">{c.code}</code>
                                                        <button onClick={() => {navigator.clipboard.writeText(c.code); showToast("Copiado!", "success")}}><Copy className="w-4 h-4 text-slate-500 hover:text-white"/></button>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-xs text-slate-500 mb-4">Vence: {new Date(c.expirationDate).toLocaleDateString()}</p>
                                                    <button onClick={() => {applyCouponCode(c.code); setView('checkout');}} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-500 transition shadow-lg shadow-purple-900/20">Usar Ahora</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        {(view === 'login' || view === 'register') && (
                            <div className="flex items-center justify-center min-h-[80vh] animate-fade-up">
                                <div className="bg-slate-900/80 p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-slate-700 backdrop-blur-xl relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-500 to-purple-500"></div>
                                    <h2 className="text-3xl font-black text-center text-white mb-8 tracking-tight">{view === 'login' ? 'Bienvenido' : 'Crear Cuenta'}</h2>
                                    {authError && <div className="bg-red-500/10 border border-red-500/50 text-red-200 p-4 rounded-xl mb-6 text-sm text-center flex items-center justify-center gap-2"><AlertTriangle className="w-4 h-4"/> {authError}</div>}
                                    <form onSubmit={view === 'login' ? onLoginSubmit : onRegisterSubmit} className="space-y-5">
                                        {view === 'register' && (<><input className="w-full input-dark p-4" placeholder="Nombre Real" value={registerData.name} onChange={e => setRegisterData({...registerData, name: e.target.value})} required/><input className="w-full input-dark p-4" placeholder="Usuario" value={registerData.username} onChange={e => setRegisterData({...registerData, username: e.target.value})} required/><input className="w-full input-dark p-4" placeholder="DNI" value={registerData.dni} onChange={e => setRegisterData({...registerData, dni: e.target.value})} required/><input className="w-full input-dark p-4" placeholder="Tel√©fono" value={registerData.phone} onChange={e => setRegisterData({...registerData, phone: e.target.value})} required/></>)}
                                        {view === 'login' ? (<input className="w-full input-dark p-4" placeholder="Email o Usuario" value={loginData.identifier} onChange={e => setLoginData({...loginData, identifier: e.target.value})} required/>) : (<input className="w-full input-dark p-4" placeholder="Email" type="email" value={registerData.email} onChange={e => setRegisterData({...registerData, email: e.target.value})} required/>)}
                                        <input className="w-full input-dark p-4" type="password" placeholder="Contrase√±a" value={view === 'login' ? loginData.password : registerData.password} onChange={e => view === 'login' ? setLoginData({...loginData, password: e.target.value}) : setRegisterData({...registerData, password: e.target.value})} required/>
                                        <button className="w-full bg-cyan-600 text-white py-4 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg mt-2">{view === 'login' ? 'ENTRAR' : 'REGISTRARSE'}</button>
                                    </form>
                                    <button onClick={() => setView(view === 'login' ? 'register' : 'login')} className="w-full text-center text-slate-400 text-sm mt-6 hover:text-white transition underline underline-offset-4">{view === 'login' ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Ingresa'}</button>
                                </div>
                            </div>
                        )}
                        {view === 'guide' && (
                            <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-3xl font-bold mb-8 text-white flex items-center gap-3"><FileQuestion className="text-cyan-400 w-8 h-8"/> C√≥mo Comprar</h2>
                                <div className="space-y-6">
                                    <div className="grid md:grid-cols-2 gap-6">
                                        {[{icon: <Search className="w-8 h-8 text-white"/>, title: "1. Busca tu producto", text: "Navega por nuestro cat√°logo o usa la lupa.", color: "bg-blue-500"}, {icon: <ShoppingBag className="w-8 h-8 text-white"/>, title: "2. Agrega al carrito", text: "Selecciona el producto y presiona 'Agregar'.", color: "bg-purple-500"}, {icon: <Zap className="w-8 h-8 text-white"/>, title: "3. Confirma el pedido", text: "Ve al carrito, elige pago y confirma tus datos.", color: "bg-yellow-500"}, {icon: <Mail className="w-8 h-8 text-white"/>, title: "4. Recibe correo y mensaje", text: "Te llegar√° un email. Te escribiremos por WhatsApp para coordinar.", color: "bg-green-500"}].map((step, i) => (
                                            <div key={i} className="bg-slate-900/80 p-6 rounded-2xl border border-slate-700 flex items-start gap-4 hover:border-cyan-500/30 transition"><div className={`p-4 rounded-xl shadow-lg ${step.color}`}>{step.icon}</div><div><h3 className="text-white font-bold text-lg mb-1">{step.title}</h3><p className="text-slate-400 text-sm">{step.text}</p></div></div>
                                        ))}
                                    </div>
                                    <div className="bg-slate-800 p-8 rounded-3xl border border-cyan-500/20 mt-8 text-center"><h3 className="text-xl font-bold text-white mb-2">Resumen</h3><p className="text-slate-300">Es muy simple: Eliges, compras y coordinamos el env√≠o por WhatsApp y mail.</p><button onClick={() => setView('store')} className="mt-6 px-8 py-3 bg-cyan-600 rounded-full text-white font-bold hover:bg-cyan-500 transition">Empezar a Comprar</button></div>
                                </div>
                            </div>
                        )}
                        {view === 'about' && (<div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up"><h2 className="text-3xl font-bold mb-8 text-white flex items-center gap-3"><Info className="text-cyan-400 w-8 h-8"/> Sobre Nosotros</h2><div className="bg-slate-900/80 p-10 rounded-[3rem] border border-cyan-500/20 shadow-lg backdrop-blur-md relative overflow-hidden"><p className="text-slate-300 text-xl leading-relaxed whitespace-pre-wrap font-light relative z-10">{settings.aboutUsText}</p></div></div>)}
                        {view === 'favorites' && (
                            <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up"><h2 className="text-2xl font-bold text-white mb-8 flex items-center gap-2"><Heart className="text-red-500 fill-red-500"/> Mis Favoritos</h2>{favorites.length === 0 ? (<div className="text-center py-20 text-slate-500 border border-dashed border-slate-800 rounded-3xl">No tienes favoritos a√∫n.</div>) : (<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">{products.filter(p => favorites.includes(p.id)).map(p => (<div key={p.id} className="bg-slate-900 rounded-2xl overflow-hidden shadow-lg border border-slate-700/50 relative"><div className="h-48 overflow-hidden relative bg-slate-950"><img src={p.image} className="w-full h-full object-cover opacity-80"/><button onClick={() => toggleFavorite(p.id)} className="absolute top-2 right-2 p-2 bg-black/50 rounded-full text-white hover:text-red-500"><X className="w-4 h-4"/></button></div><div className="p-4"><h3 className="font-bold text-white truncate">{p.name}</h3><button onClick={() => manageCart(p, 1)} className="w-full mt-3 bg-cyan-600 text-white py-2 rounded-lg font-bold text-sm">Agregar</button></div></div>))}</div>)}</div>
                        )}
                        {view === 'profile' && currentUser && (
                            <div className="max-w-3xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-3xl font-bold text-white mb-8">Mi Perfil</h2>
                                <div className="bg-slate-900 p-8 rounded-3xl border border-slate-700 mb-8 flex items-center justify-between"><div><p className="text-2xl text-white font-black">{currentUser.name}</p><p className="text-slate-400">{currentUser.email}</p><p className="text-xs text-slate-600 mt-2 font-mono uppercase bg-slate-950 px-2 py-1 rounded w-fit">ID: {currentUser.id.substring(0,8)}...</p></div><button onClick={handleLogout} className="bg-red-900/20 text-red-400 border border-red-900/50 px-6 py-3 rounded-xl hover:bg-red-900/40 transition font-bold flex items-center gap-2"><LogOut className="w-4 h-4"/> Salir</button></div>
                                <button onClick={() => setView('coupons')} className="w-full mb-8 bg-purple-900/20 border border-purple-500/30 p-4 rounded-2xl flex items-center justify-between hover:bg-purple-900/40 transition group">
                                    <div className="flex items-center gap-4"><div className="p-3 bg-purple-500 rounded-xl text-white"><Ticket className="w-6 h-6"/></div><div><p className="font-bold text-white">Mis Cupones</p><p className="text-purple-300 text-sm">Ver descuentos disponibles</p></div></div>
                                    <ArrowRight className="text-purple-500 group-hover:translate-x-1 transition"/>
                                </button>
                                <h3 className="text-xl font-bold text-white mb-4">Mis Compras</h3><div className="space-y-4">{userOrders.map(o => (<div key={o.orderId} className="bg-slate-900 p-6 rounded-2xl border border-slate-800 flex justify-between items-center hover:border-slate-600 transition"><div><span className="text-cyan-400 font-bold">{o.orderId}</span><p className="text-slate-500 text-xs">{o.displayDate}</p></div><div className="text-right"><p className="text-white font-bold text-lg">${o.total.toLocaleString()}</p><span className={`text-xs px-2 py-1 rounded-full ${o.status === 'Realizado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>{o.status}</span></div></div>))}</div></div>
                        )}

                        {/* NUEVO ADMIN PANEL SUPER MEJORADO */}
                        {view === 'admin' && isAdmin(currentUser?.email) && (
                            <div className="flex h-screen bg-[#020617] text-slate-200 overflow-hidden animate-fade-up">
                                {/* SIDEBAR */}
                                <div className="w-72 bg-slate-900/90 border-r border-slate-800 flex flex-col z-20">
                                    <div className="p-6 border-b border-slate-800 bg-slate-950/30">
                                        <h2 className="text-2xl font-black bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">ADMIN SUITE</h2>
                                        <p className="text-xs text-slate-500 mt-1 font-mono tracking-wide">V3.0 CONTROL PANEL</p>
                                    </div>
                                    <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                                        <div className="text-xs font-bold text-slate-500 uppercase tracking-widest px-4 mb-2 mt-2">Principal</div>
                                        <button onClick={() => setAdminTab('dashboard')} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium admin-sidebar-link ${adminTab === 'dashboard' ? 'active bg-slate-800/50 text-cyan-400' : 'text-slate-400'}`}><LayoutDashboard className="w-5 h-5"/> Dashboard</button>
                                        <button onClick={() => setAdminTab('products')} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium admin-sidebar-link ${adminTab === 'products' ? 'active bg-slate-800/50 text-cyan-400' : 'text-slate-400'}`}><Package className="w-5 h-5"/> Productos</button>
                                        <button onClick={() => setAdminTab('orders')} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium admin-sidebar-link ${adminTab === 'orders' ? 'active bg-slate-800/50 text-cyan-400' : 'text-slate-400'}`}><ShoppingBag className="w-5 h-5"/> Pedidos</button>
                                        
                                        <div className="text-xs font-bold text-slate-500 uppercase tracking-widest px-4 mb-2 mt-6">Gesti√≥n</div>
                                        <button onClick={() => setAdminTab('coupons')} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium admin-sidebar-link ${adminTab === 'coupons' ? 'active bg-slate-800/50 text-cyan-400' : 'text-slate-400'}`}><Ticket className="w-5 h-5"/> Cupones</button>
                                        <button onClick={() => setAdminTab('settings')} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 font-medium admin-sidebar-link ${adminTab === 'settings' ? 'active bg-slate-800/50 text-cyan-400' : 'text-slate-400'}`}><Settings className="w-5 h-5"/> Configuraci√≥n</button>
                                    </nav>
                                    <div className="p-4 border-t border-slate-800 bg-slate-950/30">
                                        <button onClick={() => setView('store')} className="w-full flex items-center justify-center gap-2 p-3 bg-gradient-to-r from-red-900/20 to-slate-900 border border-red-900/30 hover:border-red-500/50 rounded-xl text-red-400 font-bold transition text-sm group">
                                            <LogOut className="w-4 h-4 group-hover:-translate-x-1 transition"/> Salir al Store
                                        </button>
                                    </div>
                                </div>

                                {/* CONTENIDO PRINCIPAL */}
                                <div className="flex-1 flex flex-col overflow-hidden bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-[#020617]">
                                    {/* Topbar Admin */}
                                    <header className="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur-sm z-10">
                                        <div className="flex items-center gap-4 text-sm text-slate-400">
                                            <span>{new Date().toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <div className="bg-slate-800 px-3 py-1.5 rounded-full flex items-center gap-2 border border-slate-700">
                                                <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                                <span className="text-xs font-bold text-slate-300">Sistema Activo</span>
                                            </div>
                                            <div className="w-8 h-8 rounded-full bg-cyan-600/20 border border-cyan-500/30 flex items-center justify-center text-cyan-400 font-bold text-xs">{currentUser?.username?.[0]}</div>
                                        </div>
                                    </header>

                                    <div className="flex-1 overflow-y-auto p-8 relative">
                                        {adminTab === 'dashboard' && (
                                            <div className="max-w-6xl mx-auto space-y-8 animate-fade-up">
                                                <div>
                                                    <h1 className="text-3xl font-bold text-white mb-2">Dashboard</h1>
                                                    <p className="text-slate-400">Resumen general de tu negocio en tiempo real.</p>
                                                </div>

                                                {/* KPI CARDS */}
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                    <div className="admin-card p-6 rounded-2xl relative overflow-hidden group">
                                                        <div className="absolute top-0 right-0 w-20 h-20 bg-cyan-500/10 rounded-full blur-2xl -mr-6 -mt-6 transition group-hover:bg-cyan-500/20"></div>
                                                        <div className="flex items-center justify-between mb-4"><div className="p-3 bg-cyan-500/10 rounded-xl text-cyan-400"><DollarSign className="w-6 h-6"/></div><span className="text-green-400 text-xs font-bold flex items-center gap-1">+12% <TrendingUp className="w-3 h-3"/></span></div>
                                                        <p className="text-slate-400 text-sm font-medium">Ingresos Totales</p>
                                                        <p className="text-3xl font-black text-white mt-1">${totalRevenue.toLocaleString()}</p>
                                                    </div>
                                                    <div className="admin-card p-6 rounded-2xl relative overflow-hidden group">
                                                        <div className="absolute top-0 right-0 w-20 h-20 bg-purple-500/10 rounded-full blur-2xl -mr-6 -mt-6 transition group-hover:bg-purple-500/20"></div>
                                                        <div className="flex items-center justify-between mb-4"><div className="p-3 bg-purple-500/10 rounded-xl text-purple-400"><ShoppingBag className="w-6 h-6"/></div></div>
                                                        <p className="text-slate-400 text-sm font-medium">Pedidos Totales</p>
                                                        <p className="text-3xl font-black text-white mt-1">{orders.length}</p>
                                                    </div>
                                                    <div className="admin-card p-6 rounded-2xl relative overflow-hidden group">
                                                        <div className="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-full blur-2xl -mr-6 -mt-6 transition group-hover:bg-blue-500/20"></div>
                                                        <div className="flex items-center justify-between mb-4"><div className="p-3 bg-blue-500/10 rounded-xl text-blue-400"><Users className="w-6 h-6"/></div></div>
                                                        <p className="text-slate-400 text-sm font-medium">Usuarios Registrados</p>
                                                        <p className="text-3xl font-black text-white mt-1">{users.length}</p>
                                                    </div>
                                                    <div className="admin-card p-6 rounded-2xl relative overflow-hidden group">
                                                        <div className="absolute top-0 right-0 w-20 h-20 bg-red-500/10 rounded-full blur-2xl -mr-6 -mt-6 transition group-hover:bg-red-500/20"></div>
                                                        <div className="flex items-center justify-between mb-4"><div className="p-3 bg-red-500/10 rounded-xl text-red-400"><AlertCircle className="w-6 h-6"/></div></div>
                                                        <p className="text-slate-400 text-sm font-medium">Stock Cr√≠tico</p>
                                                        <p className="text-3xl font-black text-white mt-1">{products.filter(p => p.stock < 3).length}</p>
                                                    </div>
                                                </div>

                                                <div className="grid lg:grid-cols-3 gap-6">
                                                    {/* GRAFICA SIMULADA */}
                                                    <div className="lg:col-span-2 admin-card p-6 rounded-2xl">
                                                        <div className="flex justify-between items-center mb-6">
                                                            <h3 className="font-bold text-white flex items-center gap-2"><BarChart3 className="w-5 h-5 text-cyan-400"/> Ventas Recientes</h3>
                                                            <button className="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded-lg text-slate-300 transition">√öltimos 7 d√≠as</button>
                                                        </div>
                                                        <div className="h-64 flex items-end justify-between gap-2 px-4 pb-2 border-b border-slate-700/50">
                                                            {[45, 70, 30, 85, 55, 65, 90].map((h, i) => (
                                                                <div key={i} className="w-full flex flex-col items-center gap-2 group cursor-pointer">
                                                                    <div className="w-full max-w-[40px] bg-gradient-to-t from-cyan-900 to-cyan-500 rounded-t-lg opacity-60 group-hover:opacity-100 transition-all duration-300 relative" style={{height: `${h}%`}}>
                                                                        <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">${h}k</div>
                                                                    </div>
                                                                    <span className="text-xs text-slate-500 font-mono">D{i+1}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    {/* ACTIVIDAD RECIENTE */}
                                                    <div className="admin-card p-6 rounded-2xl overflow-hidden flex flex-col">
                                                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><RefreshCw className="w-5 h-5 text-purple-400"/> √öltimos Pedidos</h3>
                                                        <div className="flex-1 overflow-y-auto space-y-3 pr-2">
                                                            {orders.slice(0, 5).map(o => (
                                                                <div key={o.id} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl border border-slate-800/50 hover:border-slate-700 transition">
                                                                    <div className="flex items-center gap-3">
                                                                        <div className={`w-2 h-2 rounded-full ${o.status === 'Realizado' ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
                                                                        <div>
                                                                            <p className="text-sm font-bold text-slate-200">{o.customer.name}</p>
                                                                            <p className="text-xs text-slate-500">{o.orderId}</p>
                                                                        </div>
                                                                    </div>
                                                                    <span className="text-sm font-mono font-bold text-white">${o.total.toLocaleString()}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <button onClick={() => setAdminTab('orders')} className="w-full mt-4 py-2 text-xs font-bold text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition">Ver Todos</button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {adminTab === 'products' && (
                                            <div className="max-w-6xl mx-auto space-y-6 animate-fade-up">
                                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                    <div>
                                                        <h1 className="text-3xl font-bold text-white mb-1">Inventario</h1>
                                                        <p className="text-slate-400 text-sm">{products.length} productos en total</p>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <div className="relative">
                                                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"/>
                                                            <input className="pl-10 pr-4 py-2 bg-slate-900 border border-slate-700 rounded-xl text-sm text-white focus:border-cyan-500 outline-none w-64" placeholder="Buscar producto..." value={adminSearch} onChange={e => setAdminSearch(e.target.value)}/>
                                                        </div>
                                                        <button onClick={() => { setEditingId(null); setNewProduct({name:'',basePrice:'',category:'',image:'',description:'',stock:'',discount:0}); setShowProductForm(true); }} className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-cyan-900/20 transition hover:translate-y-[-2px]"><Plus className="w-4 h-4"/> Nuevo Producto</button>
                                                    </div>
                                                </div>

                                                {/* FORMULARIO MODAL O EXPANDIBLE */}
                                                {showProductForm && (
                                                    <div className="admin-card p-6 rounded-2xl border-l-4 border-l-cyan-500 animate-fade-up">
                                                        <div className="flex justify-between items-center mb-6">
                                                            <h3 className="text-lg font-bold text-white">{editingId ? 'Editar Producto' : 'Crear Nuevo Producto'}</h3>
                                                            <button onClick={() => setShowProductForm(false)} className="text-slate-500 hover:text-white"><X className="w-5 h-5"/></button>
                                                        </div>
                                                        <div className="grid md:grid-cols-2 gap-6">
                                                            <div className="space-y-4">
                                                                <div><label className="text-xs text-slate-400 font-bold ml-1">Nombre</label><input className="w-full input-dark p-3 mt-1" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})}/></div>
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div><label className="text-xs text-slate-400 font-bold ml-1">Precio</label><input className="w-full input-dark p-3 mt-1" type="number" value={newProduct.basePrice} onChange={e => setNewProduct({...newProduct, basePrice: e.target.value})}/></div>
                                                                    <div><label className="text-xs text-slate-400 font-bold ml-1">Stock</label><input className="w-full input-dark p-3 mt-1" type="number" value={newProduct.stock} onChange={e => setNewProduct({...newProduct, stock: e.target.value})}/></div>
                                                                </div>
                                                                <div><label className="text-xs text-slate-400 font-bold ml-1">Categor√≠a</label><select className="w-full input-dark p-3 mt-1" value={newProduct.category} onChange={e => setNewProduct({...newProduct, category: e.target.value})}><option value="">Seleccionar...</option>{settings.categories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                                            </div>
                                                            <div className="space-y-4 flex flex-col">
                                                                <div><label className="text-xs text-slate-400 font-bold ml-1">Imagen</label><input className="w-full input-dark p-3 mt-1 text-xs" type="file" ref={fileInputRef} onChange={handleImage}/></div>
                                                                <div className="flex-1 bg-slate-950 rounded-xl border border-slate-800 flex items-center justify-center overflow-hidden relative group">
                                                                    {newProduct.image ? <img src={newProduct.image} className="w-full h-full object-cover"/> : <span className="text-slate-600 text-xs">Vista previa imagen</span>}
                                                                </div>
                                                                <div><label className="text-xs text-slate-400 font-bold ml-1">Descuento %</label><input className="w-full input-dark p-3 mt-1" type="number" value={newProduct.discount} onChange={e => setNewProduct({...newProduct, discount: e.target.value})}/></div>
                                                            </div>
                                                        </div>
                                                        <div className="flex justify-end gap-3 mt-6">
                                                            <button onClick={() => setShowProductForm(false)} className="px-6 py-2 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 font-bold transition">Cancelar</button>
                                                            <button onClick={saveProduct} className="px-6 py-2 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white font-bold shadow-lg transition">Guardar Producto</button>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* TABLA DE PRODUCTOS */}
                                                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-xl">
                                                    <div className="overflow-x-auto">
                                                        <table className="w-full text-left border-collapse">
                                                            <thead>
                                                                <tr className="bg-slate-950/50 border-b border-slate-800 text-xs uppercase text-slate-400 font-bold tracking-wider">
                                                                    <th className="p-4">Producto</th>
                                                                    <th className="p-4">Categor√≠a</th>
                                                                    <th className="p-4">Precio</th>
                                                                    <th className="p-4">Stock</th>
                                                                    <th className="p-4 text-right">Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-slate-800">
                                                                {products.filter(p => p.name.toLowerCase().includes(adminSearch.toLowerCase())).map(p => (
                                                                    <tr key={p.id} className="hover:bg-slate-800/30 transition group">
                                                                        <td className="p-4 flex items-center gap-3">
                                                                            <img src={p.image} className="w-10 h-10 rounded-lg object-cover bg-slate-800"/>
                                                                            <span className="font-bold text-sm text-slate-200">{p.name}</span>
                                                                        </td>
                                                                        <td className="p-4 text-sm text-slate-400">{p.category}</td>
                                                                        <td className="p-4 text-sm font-mono text-cyan-400">${p.basePrice}</td>
                                                                        <td className="p-4">
                                                                            <span className={`text-xs px-2 py-1 rounded-md font-bold ${p.stock < 3 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>{p.stock} u.</span>
                                                                        </td>
                                                                        <td className="p-4 text-right">
                                                                            <div className="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                                <button onClick={() => handleEditProduct(p)} className="p-2 bg-blue-500/10 text-blue-400 hover:bg-blue-500/20 rounded-lg"><Edit className="w-4 h-4"/></button>
                                                                                <button onClick={() => initiateDelete(p)} className="p-2 bg-red-500/10 text-red-400 hover:bg-red-500/20 rounded-lg"><Trash2 className="w-4 h-4"/></button>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        {adminTab === 'orders' && (
                                            <div className="max-w-6xl mx-auto space-y-6 animate-fade-up">
                                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                    <div>
                                                        <h1 className="text-3xl font-bold text-white mb-1">Pedidos</h1>
                                                        <p className="text-slate-400 text-sm">Gestiona y procesa las compras de los clientes.</p>
                                                    </div>
                                                    <div className="flex items-center gap-3 bg-slate-900 p-1 rounded-xl border border-slate-800">
                                                        <button onClick={() => setAdminOrderFilter('all')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${adminOrderFilter === 'all' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Todos</button>
                                                        <button onClick={() => setAdminOrderFilter('Pendiente')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${adminOrderFilter === 'Pendiente' ? 'bg-yellow-600/20 text-yellow-400 border border-yellow-600/30' : 'text-slate-400 hover:text-white'}`}>Pendientes</button>
                                                        <button onClick={() => setAdminOrderFilter('Realizado')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${adminOrderFilter === 'Realizado' ? 'bg-green-600/20 text-green-400 border border-green-600/30' : 'text-slate-400 hover:text-white'}`}>Completados</button>
                                                    </div>
                                                </div>

                                                <div className="grid gap-4">
                                                    {orders.filter(o => {
                                                        const matchSearch = adminSearch === '' || o.orderId.toLowerCase().includes(adminSearch.toLowerCase()) || o.customer.name.toLowerCase().includes(adminSearch.toLowerCase());
                                                        const matchFilter = adminOrderFilter === 'all' || o.status === adminOrderFilter;
                                                        return matchSearch && matchFilter;
                                                    }).map(o => (
                                                        <div key={o.id} onClick={() => setSelectedOrder(o)} className="admin-card p-5 rounded-2xl flex flex-col md:flex-row items-start md:items-center justify-between gap-4 hover:border-cyan-500/50 transition cursor-pointer group">
                                                            <div className="flex items-center gap-4">
                                                                <div className={`p-3 rounded-xl ${o.status === 'Realizado' ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'}`}>
                                                                    {o.status === 'Realizado' ? <CheckCircle className="w-6 h-6"/> : <Package className="w-6 h-6"/>}
                                                                </div>
                                                                <div>
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="font-mono text-cyan-400 font-bold">{o.orderId}</span>
                                                                        <span className="text-slate-500 text-xs">‚Ä¢ {new Date(o.date).toLocaleDateString()}</span>
                                                                    </div>
                                                                    <p className="font-bold text-white text-lg">{o.customer.name}</p>
                                                                    <p className="text-xs text-slate-400">{o.items.length} productos ‚Ä¢ {o.paymentMethod}</p>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                                                                <div className="text-right">
                                                                    <p className="text-xs text-slate-500 mb-1">Total</p>
                                                                    <p className="text-2xl font-black text-white">${o.total.toLocaleString()}</p>
                                                                </div>
                                                                <div className="bg-slate-800 p-2 rounded-full text-slate-400 group-hover:text-white group-hover:bg-cyan-600 transition">
                                                                    <ChevronRight className="w-5 h-5"/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* --- SECCI√ìN DE CUPONES RENOVADA --- */}
                                        {adminTab === 'coupons' && (
                                            <div className="max-w-5xl mx-auto space-y-6 animate-fade-up">
                                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                    <div>
                                                        <h1 className="text-3xl font-bold text-white mb-2">Gesti√≥n de Cupones</h1>
                                                        <p className="text-slate-400">Administra descuentos globales y recompensas para usuarios.</p>
                                                    </div>
                                                </div>

                                                {/* --- CREAR CUP√ìN --- */}
                                                <div className="admin-card p-6 rounded-2xl border-l-4 border-l-purple-500 shadow-xl">
                                                    <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                                                        <Plus className="w-5 h-5 text-purple-400"/> Generar Nuevo Cup√≥n
                                                    </h3>
                                                    <div className="grid md:grid-cols-12 gap-4">
                                                        <div className="md:col-span-3">
                                                            <label className="text-xs text-slate-500 font-bold mb-1 block">C√ìDIGO</label>
                                                            <input className="w-full input-dark p-3 uppercase font-bold tracking-wider text-purple-300" 
                                                                placeholder="EJ: SALE2024" 
                                                                value={newCoupon.code} 
                                                                onChange={e => setNewCoupon({...newCoupon, code: e.target.value.toUpperCase()})}
                                                            />
                                                        </div>
                                                        <div className="md:col-span-2">
                                                            <label className="text-xs text-slate-500 font-bold mb-1 block">% DESC</label>
                                                            <input className="w-full input-dark p-3" type="number" placeholder="10" 
                                                                value={newCoupon.discountPercentage} 
                                                                onChange={e => setNewCoupon({...newCoupon, discountPercentage: e.target.value})}
                                                            />
                                                        </div>
                                                        <div className="md:col-span-2">
                                                            <label className="text-xs text-slate-500 font-bold mb-1 block">L√çMITE USOS</label>
                                                            <input className="w-full input-dark p-3" type="number" placeholder="Ej: 100" 
                                                                value={newCoupon.usageLimit} 
                                                                onChange={e => setNewCoupon({...newCoupon, usageLimit: e.target.value})}
                                                            />
                                                        </div>
                                                        <div className="md:col-span-3">
                                                            <label className="text-xs text-slate-500 font-bold mb-1 block">EMAIL (Opcional)</label>
                                                            <input className="w-full input-dark p-3" placeholder="Para cup√≥n personal" 
                                                                value={newCoupon.targetUser} 
                                                                onChange={e => setNewCoupon({...newCoupon, targetUser: e.target.value})}
                                                            />
                                                        </div>
                                                        <div className="md:col-span-2">
                                                            <label className="text-xs text-slate-500 font-bold mb-1 block">VENCIMIENTO</label>
                                                            <input className="w-full input-dark p-3 text-xs" type="date" 
                                                                value={newCoupon.expirationDate} 
                                                                onChange={e => setNewCoupon({...newCoupon, expirationDate: e.target.value})}
                                                            />
                                                        </div>
                                                    </div>
                                                    <button onClick={saveCoupon} className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl mt-4 transition shadow-lg shadow-purple-900/20">
                                                        Crear Cup√≥n
                                                    </button>
                                                </div>

                                                {/* --- TABS Y FILTROS --- */}
                                                <div className="flex flex-col md:flex-row gap-4 items-center justify-between border-b border-slate-800 pb-4">
                                                    <div className="flex bg-slate-900 p-1 rounded-xl border border-slate-800">
                                                        <button 
                                                            onClick={() => setCouponTab('global')}
                                                            className={`px-6 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 ${couponTab === 'global' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}
                                                        >
                                                            <Ticket className="w-4 h-4"/> Globales
                                                        </button>
                                                        <button 
                                                            onClick={() => setCouponTab('individual')}
                                                            className={`px-6 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 ${couponTab === 'individual' ? 'bg-purple-900/30 text-purple-300 border border-purple-500/30' : 'text-slate-400 hover:text-white'}`}
                                                        >
                                                            <User className="w-4 h-4"/> Individuales
                                                        </button>
                                                    </div>

                                                    {couponTab === 'individual' && (
                                                        <div className="relative w-full md:w-64 animate-fade-up">
                                                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"/>
                                                            <input 
                                                                className="w-full pl-10 pr-4 py-2 bg-slate-900 border border-slate-700 rounded-xl text-sm text-white focus:border-purple-500 outline-none" 
                                                                placeholder="Buscar por usuario o email..." 
                                                                value={couponSearch} 
                                                                onChange={e => setCouponSearch(e.target.value)}
                                                            />
                                                        </div>
                                                    )}
                                                </div>

                                                {/* --- LISTA DE CUPONES --- */}
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    {coupons.filter(c => {
                                                        // Filtro por Tab
                                                        const isIndividual = c.targetUser && c.targetUser.trim() !== '';
                                                        if (couponTab === 'global' && isIndividual) return false;
                                                        if (couponTab === 'individual' && !isIndividual) return false;
                                                        
                                                        // Filtro por B√∫squeda (solo en individuales)
                                                        if (couponTab === 'individual' && couponSearch) {
                                                            return c.targetUser.toLowerCase().includes(couponSearch.toLowerCase()) || 
                                                                c.code.toLowerCase().includes(couponSearch.toLowerCase());
                                                        }
                                                        return true;
                                                    }).map(c => (
                                                        <div key={c.id} className="bg-slate-900 border border-slate-800 p-5 rounded-xl flex flex-col justify-between group hover:border-purple-500/50 transition relative overflow-hidden shadow-lg">
                                                            {/* Decoraci√≥n de fondo */}
                                                            <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-purple-500/10 to-transparent rounded-bl-full -mr-4 -mt-4"></div>
                                                            
                                                            <div className="relative z-10">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <span className="bg-purple-500/10 text-purple-400 border border-purple-500/20 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">
                                                                        {c.targetUser ? 'Personal' : 'Global'}
                                                                    </span>
                                                                    <div className="flex items-center gap-1 text-xs text-slate-500">
                                                                        <Users className="w-3 h-3"/>
                                                                        <span>{c.usedBy ? c.usedBy.length : 0} / {c.usageLimit}</span>
                                                                    </div>
                                                                </div>

                                                                <div className="flex items-center justify-between mt-2">
                                                                    <p className="font-black text-2xl text-white tracking-wider font-mono">{c.code}</p>
                                                                    <span className="text-green-400 font-bold text-lg">-{c.discountPercentage}%</span>
                                                                </div>

                                                                {c.targetUser && (
                                                                    <div className="mt-3 flex items-center gap-2 p-2 bg-slate-950 rounded-lg border border-slate-800">
                                                                        <User className="w-3 h-3 text-slate-500"/>
                                                                        <p className="text-xs text-slate-300 truncate">{c.targetUser}</p>
                                                                    </div>
                                                                )}

                                                                <div className="mt-4 pt-4 border-t border-slate-800 flex justify-between items-center">
                                                                    <p className={`text-xs font-bold ${new Date(c.expirationDate) < new Date() ? 'text-red-400' : 'text-slate-500'}`}>
                                                                        {new Date(c.expirationDate) < new Date() ? 'VENCIDO' : `Vence: ${new Date(c.expirationDate).toLocaleDateString()}`}
                                                                    </p>
                                                                    <button 
                                                                        onClick={(e) => {
                                                                            e.stopPropagation(); // Evita clics fantasma
                                                                            deleteCouponAction(c.id);
                                                                        }} 
                                                                        className="p-2 bg-slate-800 text-slate-400 hover:text-white hover:bg-red-600 rounded-lg transition shadow-md"
                                                                        title="Eliminar Cup√≥n"
                                                                    >
                                                                        <Trash2 className="w-4 h-4"/>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    
                                                    {/* Mensaje si no hay resultados */}
                                                    {coupons.filter(c => (couponTab === 'global' ? !c.targetUser : c.targetUser)).length === 0 && (
                                                        <div className="col-span-full py-12 text-center border-2 border-dashed border-slate-800 rounded-2xl">
                                                            <Ticket className="w-12 h-12 text-slate-700 mx-auto mb-3"/>
                                                            <p className="text-slate-500">No hay cupones en esta secci√≥n.</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}

                                        {adminTab === 'settings' && (
                                            <div className="max-w-4xl mx-auto space-y-6 animate-fade-up">
                                                <div>
                                                    <h1 className="text-3xl font-bold text-white mb-2">Configuraci√≥n</h1>
                                                    <p className="text-slate-400">Ajustes generales de la tienda.</p>
                                                </div>
                                                <div className="admin-card p-8 rounded-2xl border border-slate-700 space-y-6">
                                                    <div>
                                                        <h3 className="font-bold text-white mb-2">Informaci√≥n del Negocio</h3>
                                                        <p className="text-xs text-slate-500 mb-4">Este texto aparecer√° en la secci√≥n "Sobre Nosotros".</p>
                                                        <textarea className="w-full h-32 input-dark p-4 resize-none leading-relaxed" value={aboutText} onChange={e => setAboutText(e.target.value)}></textarea>
                                                    </div>
                                                    
                                                    {/* SECCI√ìN DE CATEGOR√çAS A√ëADIDA */}
                                                    <div className="pt-6 border-t border-slate-700">
                                                        <h3 className="font-bold text-white mb-4">Categor√≠as de Productos</h3>
                                                        <div className="flex gap-3 mb-4">
                                                            <input className="flex-1 input-dark p-3" placeholder="Nueva categor√≠a (ej: Tablets)" value={newCategory} onChange={e => setNewCategory(e.target.value)}/>
                                                            <button onClick={addCategory} className="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-xl font-bold transition">Agregar</button>
                                                        </div>
                                                        <div className="flex flex-wrap gap-3">
                                                            {tempSettings.categories.map((cat, i) => (
                                                                <div key={i} className="bg-slate-900 border border-slate-800 pl-4 pr-2 py-2 rounded-xl flex items-center gap-2 group hover:border-slate-600 transition">
                                                                    <span className="text-sm font-medium text-slate-300">{cat}</span>
                                                                    <button onClick={() => removeCategory(cat)} className="p-1 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition"><X className="w-4 h-4"/></button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>

                                                    <div className="pt-6 border-t border-slate-700">
                                                        <h3 className="font-bold text-white mb-4">Gesti√≥n de Administradores</h3>
                                                        <div className="flex gap-3 mb-4">
                                                            <input className="flex-1 input-dark p-3" placeholder="Email del nuevo admin" value={newAdminEmail} onChange={e => setNewAdminEmail(e.target.value)}/>
                                                            <button onClick={addAdmin} className="bg-purple-600 hover:bg-purple-500 text-white px-6 rounded-xl font-bold transition">A√±adir</button>
                                                        </div>
                                                        <div className="bg-slate-950 p-4 rounded-xl border border-slate-800">
                                                            <p className="text-xs text-slate-500 uppercase font-bold mb-2">Admins Actuales</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {settings.admins?.split(',').map((email, i) => (
                                                                    <span key={i} className="bg-slate-800 text-slate-300 text-xs px-3 py-1.5 rounded-full border border-slate-700 flex items-center gap-2">
                                                                        <Shield className="w-3 h-3 text-purple-400"/> {email.trim()}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button onClick={saveSettings} className="w-full bg-cyan-600 py-4 rounded-xl font-bold text-white text-lg hover:bg-cyan-500 shadow-lg shadow-cyan-900/20 transition mt-4">Guardar Configuraci√≥n</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* MEN√ö HAMBURGUESA MOBILE */}
                    <div className={`fixed top-0 left-0 h-full w-72 bg-slate-900/95 backdrop-blur-xl border-r border-slate-700 transform transition-transform duration-300 z-[150] flex flex-col ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 flex justify-between items-center border-b border-slate-700"><span className="font-bold text-xl text-white tracking-widest">MEN√ö</span><button onClick={() => setIsMenuOpen(false)}><X className="text-slate-400 hover:text-white"/></button></div>
                        <div className="p-4 space-y-2 flex-1 overflow-y-auto">
                            <button onClick={() => { setView('store'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition flex items-center gap-3"><Home className="w-5 h-5"/> Inicio</button>
                            <button onClick={() => { setView(currentUser ? 'profile' : 'login'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition flex items-center gap-3">{currentUser ? <><User className="w-5 h-5"/> Mi Perfil</> : <><LogIn className="w-5 h-5"/> Iniciar Sesi√≥n</>}</button>
                            <button onClick={() => { setView('coupons'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition flex items-center gap-3"><Ticket className="w-5 h-5"/> Cupones</button>
                            <button onClick={() => { setView('guide'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition flex items-center gap-3"><FileQuestion className="w-5 h-5"/> C√≥mo Comprar</button>
                            <button onClick={() => { setView('about'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 text-slate-300 hover:text-white transition flex items-center gap-3"><Info className="w-5 h-5"/> Sobre Nosotros</button>
                            {currentUser && isAdmin(currentUser.email) && <button onClick={() => { setView('admin'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl bg-purple-900/20 text-purple-400 font-bold border border-purple-900/30 mt-4 flex items-center gap-3"><Shield className="w-5 h-5"/> Admin Panel</button>}
                        </div>
                        {/* BOTONES DE CONTACTO EN MENU MOVIL */}
                        <div className="p-4 border-t border-slate-800 mt-auto bg-slate-950/30">
                            <p className="text-xs text-slate-500 font-bold uppercase mb-3 px-1">Contacto R√°pido</p>
                            <div className="flex gap-3">
                                <button onClick={goWsp} className="flex-1 py-3 bg-green-600/20 text-green-400 border border-green-600/30 rounded-xl flex items-center justify-center gap-2 font-bold hover:bg-green-600 hover:text-white transition"><MessageCircle className="w-5 h-5"/> WhatsApp</button>
                                <button onClick={goIg} className="flex-1 py-3 bg-pink-600/20 text-pink-400 border border-pink-600/30 rounded-xl flex items-center justify-center gap-2 font-bold hover:bg-pink-600 hover:text-white transition"><Instagram className="w-5 h-5"/> Instagram</button>
                            </div>
                        </div>
                    </div>
                    {isMenuOpen && <div className="fixed inset-0 bg-black/60 z-[140] backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}></div>}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
