<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustore - Tecnolog√≠a Premium</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "mercadopago": "https://sdk.mercadopago.com/js/v2"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap');
        
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

        .animate-fade-up { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-panel { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .input-dark { background-color: #1e293b; border: 1px solid #334155; color: white; border-radius: 0.75rem; transition: all 0.2s; }
        .input-dark:focus { border-color: #06b6d4; box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2); outline: none; }
        .deposit-card { background: white; color: #111827; border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ShoppingBag, X, User, Search, Zap, CheckCircle, MessageCircle, Send, Instagram, 
          Minus, ArrowRight, FileText, Menu, Home, Info, Heart, Settings, Tag, Plus, 
          Trash2, Edit, XCircle, AlertOctagon, AlertCircle, AlertTriangle, RefreshCw, 
          Brain, Share2, BarChart, Ticket, LogOut, CreditCard, Users, ShieldCheck, Lock, Gift, Copy, Save
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, getDocs, deleteDoc, where } from 'firebase/firestore';

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
          apiKey: "AIzaSyAfllte-D_I3h3TwBaiSL4KVfWrCSVh9ro",
          authDomain: "sustore-63266.firebaseapp.com",
          projectId: "sustore-63266",
          storageBucket: "sustore-63266.firebasestorage.app",
          messagingSenderId: "684651914850",
          appId: "1:684651914850:web:f3df09e5caf6e50e9e533b",
          measurementId: "G-X3K7XGYPRD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "sustore-prod-v1";
        const apiKey = ""; 
        // ¬°ATENCI√ìN! Reemplaza esto con tu KEY DE PRODUCCI√ìN real para que cobres de verdad
        const MP_PUBLIC_KEY = "TEST-e6ef7e6d-5a9d-472e-8393-27357597542d"; 

        const defaultSettings = {
            storeName: "SUSTORE",
            primaryColor: "#06b6d4",
            currency: "$",
            admins: "lautarocorazza63@gmail.com",
            sellerEmail: "sustoresf@gmail.com",
            instagramUser: "sustore_sf",
            whatsappLink: "https://wa.me/message/3MU36VTEKINKP1",
            logoUrl: "",
            heroUrl: "",
            markupPercentage: 6.50,
            categories: ["Celulares", "Accesorios", "Audio", "Computaci√≥n", "Gaming"],
            aboutUsText: "Somos una empresa dedicada a traer la mejor tecnolog√≠a al mejor precio."
        };

        // --- COMPONENTES AUXILIARES ---
        const SustoreLogo = () => (
            <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(6,182,212,0.5)] overflow-hidden border-2 border-cyan-500 relative z-50">
                <svg viewBox="0 0 100 100" className="w-6 h-6" fill="none"><path d="M20 30 H60 M20 50 H80 M20 70 H50" stroke="#0F172A" strokeWidth="8" strokeLinecap="round"/></svg>
            </div>
        );

        const Loading = ({ message }) => (
            <div className="fixed inset-0 bg-[#020617]/95 z-[100] flex flex-col items-center justify-center backdrop-blur-md">
                {message === 'MP' ? (
                    <>
                        <div className="bg-white p-4 rounded-full mb-6 animate-bounce shadow-[0_0_30px_rgba(0,158,227,0.4)]">
                            <CreditCard className="w-12 h-12 text-[#009EE3]" />
                        </div>
                        <p className="text-white text-xl font-bold tracking-widest animate-pulse">CONECTANDO CON MERCADO PAGO</p>
                        <p className="text-slate-400 text-sm mt-3 flex items-center gap-2"><Lock className="w-4 h-4"/> Entorno Seguro SSL</p>
                    </>
                ) : (
                    <>
                        <RefreshCw className="w-12 h-12 text-cyan-500 animate-spin mb-4"/>
                        <p className="text-cyan-400 text-sm font-bold tracking-[0.2em] animate-pulse">{message || 'CARGANDO...'}</p>
                    </>
                )}
            </div>
        );

        const WelcomeModal = ({ code, onClose }) => (
            <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-up">
                <div className="bg-gradient-to-br from-slate-900 to-slate-800 border border-cyan-500/50 p-8 rounded-3xl shadow-[0_0_50px_rgba(6,182,212,0.2)] max-w-md w-full text-center relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-400 to-purple-500"></div>
                    <div className="w-20 h-20 bg-cyan-500/20 rounded-full flex items-center justify-center mx-auto mb-6"><Gift className="w-10 h-10 text-cyan-400 animate-bounce" /></div>
                    <h3 className="text-3xl font-black text-white mb-2">¬°BIENVENIDO!</h3>
                    <p className="text-slate-300 mb-6 text-sm">Gracias por unirte. Aqu√≠ tienes tu regalo exclusivo:</p>
                    <div className="bg-slate-950 border border-dashed border-cyan-500/50 p-5 rounded-xl mb-6 cursor-pointer hover:bg-slate-900 transition group" onClick={() => {navigator.clipboard.writeText(code); alert('¬°Copiado!');}}>
                        <p className="text-[10px] text-slate-500 uppercase tracking-widest mb-1 font-bold">C√≥digo de Descuento</p>
                        <p className="text-4xl font-black text-cyan-400 font-mono tracking-wider">{code}</p>
                        <div className="flex justify-center items-center gap-1 mt-2 text-xs text-slate-400 group-hover:text-white transition"><Copy className="w-3 h-3"/> Clic para copiar</div>
                    </div>
                    <button onClick={onClose} className="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-xl font-bold transition shadow-lg uppercase tracking-wider">¬°Ir a Comprar!</button>
                </div>
            </div>
        );

        // --- APP PRINCIPAL ---
        function App() {
            const [view, setView] = useState('store');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState(() => { try { return JSON.parse(localStorage.getItem('nexus_cart')) || []; } catch(e) { return []; } });
            const [users, setUsers] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [favorites, setFavorites] = useState([]);
            const [orders, setOrders] = useState([]);
            const [userOrders, setUserOrders] = useState([]);
            const [settings, setSettings] = useState(defaultSettings);
            const [systemUser, setSystemUser] = useState(null);
            
            // UI & Estados
            const [isLoading, setIsLoading] = useState(true);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
            const [productToDelete, setProductToDelete] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(''); 
            const [authError, setAuthError] = useState('');
            const [pendingOrderRecover, setPendingOrderRecover] = useState(null);
            const [aiThinking, setAiThinking] = useState(false);
            const [activeTab, setActiveTab] = useState('completed');
            const [welcomeCode, setWelcomeCode] = useState(null);
            const [checkoutCoupon, setCheckoutCoupon] = useState('');
            const [appliedCoupon, setAppliedCoupon] = useState(null);
            const [editingUser, setEditingUser] = useState(null);
            const [editingId, setEditingId] = useState(null);

            // Chatbot
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([{ role: 'system', text: '¬°Hola! Soy la IA de Sustore. ¬øBuscas alg√∫n producto en especial?' }]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            // Formularios
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', dni: '', phone: '' });
            const [checkoutData, setCheckoutData] = useState({ address: '', city: '', province: 'Santa Fe', zipCode: '', references: '', transferHolder: '', paymentId: '' });
            const [tempSettings, setTempSettings] = useState(defaultSettings);
            const [newProduct, setNewProduct] = useState({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 });
            const [newCoupon, setNewCoupon] = useState({ code: '', discountPercentage: 7, expirationDate: '', userEmail: '' });
            const [newCategory, setNewCategory] = useState('');
            const [aboutText, setAboutText] = useState('');

            const fileInputRef = useRef(null);

            // --- EFECTOS ---
            useEffect(() => { localStorage.setItem('nexus_cart', JSON.stringify(cart)); }, [cart]);
            useEffect(() => { if (!currentUser) { const localFavs = localStorage.getItem('nexus_favs'); if (localFavs) setFavorites(JSON.parse(localFavs)); } }, [currentUser]);
            useEffect(() => { const initAuth = async () => { await signInAnonymously(auth); }; initAuth(); return onAuthStateChanged(auth, setSystemUser); }, []);

            useEffect(() => {
                if (!systemUser) return;
                const prodUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (s) => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const userUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const couponUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), (s) => setCoupons(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const orderUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => setOrders(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())));
                const setUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), (s) => {
                    if (!s.empty) {
                        const d = s.docs[0].data();
                        setSettings({ ...defaultSettings, ...d });
                        setTempSettings({ ...defaultSettings, ...d });
                        setAboutText(d.aboutUsText || defaultSettings.aboutUsText);
                    } else { addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), defaultSettings); }
                    setIsLoading(false);
                });
                const savedId = localStorage.getItem('nexus_user_id');
                if (savedId && !currentUser) { getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('__name__', '==', savedId))).then(s => { if (!s.empty) { const u = {id: s.docs[0].id, ...s.docs[0].data()}; setCurrentUser(u); if (u.favorites) setFavorites(u.favorites); }}); }
                return () => { prodUnsub(); userUnsub(); orderUnsub(); setUnsub(); couponUnsub(); };
            }, [systemUser]);

            useEffect(() => { if (currentUser && orders.length > 0) { setUserOrders(orders.filter(o => o.userId === currentUser.id)); const pending = orders.find(o => o.userId === currentUser.id && o.status === 'Pendiente'); setPendingOrderRecover(pending || null); } }, [currentUser, orders]);

            // --- HELPERS ---
            const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            const isAdmin = (email) => settings.admins && settings.admins.split(',').map(e => e.trim().toLowerCase()).includes(email?.toLowerCase());
            const calculatePrice = (basePrice, discount) => { const markup = Number(basePrice) * (1 + settings.markupPercentage / 100); return discount > 0 ? Math.ceil(markup * (1 - discount / 100)) : Math.ceil(markup); };
            const getRawPrice = (basePrice) => Math.ceil(Number(basePrice) * (1 + settings.markupPercentage / 100));
            
            // --- AUTH ---
            const performAuth = async (isRegister) => {
                setAuthError(''); 
                if (isRegister && (!registerData.name || !registerData.dni || !registerData.email || !registerData.password)) return setAuthError("Completa todos los campos.");
                if (!loginData.email && !isRegister) return setAuthError("Ingresa email.");
                
                setIsLoading(true); setLoadingMessage('AUTENTICANDO...');
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    if (isRegister) {
                        const qEmail = query(usersRef, where("email", "==", registerData.email));
                        const snapEmail = await getDocs(qEmail);
                        if (!snapEmail.empty) { setIsLoading(false); return setAuthError("Email ya registrado."); }

                        const newUser = { ...registerData, role: 'user', joinDate: new Date().toISOString(), favorites: [] };
                        const ref = await addDoc(usersRef, newUser);
                        
                        // L√ìGICA CUP√ìN 7%
                        const qDni = query(usersRef, where("dni", "==", registerData.dni));
                        const snapDni = await getDocs(qDni);
                        if (snapDni.empty) {
                            const code = `HOLA-${registerData.name.split(' ')[0].toUpperCase()}${Math.floor(Math.random()*100)}`;
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), { code, discountPercentage: 7, expirationDate: new Date(Date.now() + 604800000).toISOString(), userEmail: registerData.email, usedBy: [] });
                            setWelcomeCode(code);
                        }
                        setCurrentUser({ ...newUser, id: ref.id }); localStorage.setItem('nexus_user_id', ref.id);
                    } else {
                        const qLogin = query(usersRef, where("email", "==", loginData.email), where("password", "==", loginData.password));
                        const snapLogin = await getDocs(qLogin);
                        if (!snapLogin.empty) { const u = { id: snapLogin.docs[0].id, ...snapLogin.docs[0].data() }; setCurrentUser(u); localStorage.setItem('nexus_user_id', u.id); if (u.favorites) setFavorites(u.favorites); } 
                        else { setIsLoading(false); return setAuthError("Credenciales incorrectas."); }
                    }
                    setView('store'); setAuthError('');
                } catch (e) { setAuthError("Error: " + e.message); }
                setIsLoading(false); setLoadingMessage('');
            };

            const onLoginSubmit = (e) => { e.preventDefault(); performAuth(false); };
            const onRegisterSubmit = (e) => { e.preventDefault(); performAuth(true); };
            const handleLogout = () => { localStorage.removeItem('nexus_user_id'); setCurrentUser(null); setView('store'); setFavorites([]); setShowLogoutConfirm(false); setIsMenuOpen(false); };

            // --- CART & PAYMENT REAL ---
            const manageCart = (prod, delta) => {
                const idx = cart.findIndex(i => i.product.id === prod.id);
                if (idx === -1 && delta > 0) {
                    if (Number(prod.stock) < 1) return alert("Sin stock");
                    setCart([...cart, { product: prod, quantity: 1 }]);
                } else if (idx !== -1) {
                    const newCart = [...cart];
                    newCart[idx].quantity += delta;
                    if (newCart[idx].quantity <= 0) setCart(cart.filter((_, i) => i !== idx));
                    else if (newCart[idx].quantity <= Number(prod.stock)) setCart(newCart);
                    else alert("Stock insuficiente");
                }
            };
            
            const cartSubtotal = cart.reduce((acc, item) => acc + (calculatePrice(item.product.basePrice, item.product.discount) * item.quantity), 0);
            const cartTotal = appliedCoupon ? Math.ceil(cartSubtotal * (1 - appliedCoupon.discountPercentage / 100)) : cartSubtotal;

            const handleGoToMP = async () => {
                if (!checkoutData.address || !checkoutData.city || !checkoutData.zipCode || !checkoutData.transferHolder) return alert("Por favor completa todos los campos de env√≠o.");
                if (!/^\d{4}$/.test(checkoutData.zipCode)) return alert("El CP debe ser un n√∫mero de 4 d√≠gitos v√°lido.");
                
                setLoadingMessage('MP'); setIsLoading(true);

                try {
                    // 1. Crear Orden en Firestore (Pendiente)
                    const newOrder = {
                        orderId: `ORD-${Math.floor(Math.random()*100000)}`,
                        userId: currentUser?.id || 'guest', userName: currentUser?.name || checkoutData.transferHolder, 
                        userEmail: currentUser?.email || 'guest',
                        total: cartTotal, items: cart, date: new Date().toISOString(), displayDate: new Date().toLocaleString(),
                        shippingAddress: `${checkoutData.address}, ${checkoutData.city} (CP: ${checkoutData.zipCode})`,
                        paymentMethod: `Mercado Pago`, status: 'Pendiente', paymentId: '', couponCode: appliedCoupon?.code || null 
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);

                    // 2. Preparar Items para Mercado Pago
                    const discountFactor = appliedCoupon ? (1 - appliedCoupon.discountPercentage / 100) : 1;
                    const mpItems = cart.map(item => ({
                        id: item.product.id, title: item.product.name, quantity: item.quantity,
                        unit_price: Math.ceil(calculatePrice(item.product.basePrice, item.product.discount) * discountFactor),
                        currency_id: 'ARS'
                    }));

                    // 3. Fetch a Backend Real (/api/payment)
                    const response = await fetch('/api/payment', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: mpItems })
                    });

                    if (!response.ok) {
                        const txt = await response.text();
                        throw new Error(`Error del servidor de pagos (${response.status}): ${txt}`);
                    }

                    const preference = await response.json();
                    
                    if (!window.MercadoPago) throw new Error("El sistema de pagos no carg√≥ correctamente. Recarga la p√°gina.");
                    
                    const mp = new window.MercadoPago(MP_PUBLIC_KEY, { locale: 'es-AR' });
                    mp.checkout({ preference: { id: preference.id }, autoOpen: true });
                    setIsLoading(false);

                } catch (error) {
                    console.error("CRITICAL PAYMENT ERROR:", error);
                    alert("‚õî ERROR DE PAGO:\nNo se pudo conectar con el servidor de cobros.\n\nDetalle t√©cnico: " + error.message + "\n\nAseg√∫rate de que el archivo /api/payment.js existe y est√° desplegado en Vercel.");
                    setIsLoading(false);
                }
            };

            // ** L√ìGICA DE RECUPERACI√ìN MEJORADA **
            const handleRecoverYes = () => {
                if (!pendingOrderRecover) return;
                
                // Restaurar carrito
                setCart(pendingOrderRecover.items);
                
                // Intentar parsear direcci√≥n vieja si es necesario, o simplemente dejar que el usuario rellene
                // Para "hacer que funcione ya", llevamos al usuario al checkout
                // y pre-rellenamos lo que tengamos.
                // Como la direcci√≥n se guarda como un string en la DB ("Calle 123, Ciudad (CP: 1234)"), 
                // es dif√≠cil separarla perfectamente. 
                // MEJOR ESTRATEGIA: Dejar que el usuario rellene la direcci√≥n de nuevo por seguridad,
                // pero llevarlo YA a la pantalla de checkout.
                
                setView('checkout');
                setPendingOrderRecover(null); // Cierra el modal, ya estamos en checkout listos para pagar
            };

            const handleRecoverNo = async () => {
                if (!pendingOrderRecover) return;
                setIsLoading(true);
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingOrderRecover.id));
                    setPendingOrderRecover(null);
                    alert("Orden descartada.");
                } catch(err) { alert("Error: " + err.message); }
                setIsLoading(false);
            };

            const validateCoupon = () => {
                if(!checkoutCoupon) return;
                const found = coupons.find(c => c.code.toUpperCase() === checkoutCoupon.toUpperCase());
                if (!found) return alert("Cup√≥n inv√°lido");
                if (new Date(found.expirationDate) < new Date()) return alert("Vencido");
                if (found.userEmail && found.userEmail !== currentUser?.email) return alert("No es para ti");
                if (found.usedBy?.includes(currentUser?.id)) return alert("Ya usado");
                setAppliedCoupon(found); alert("¬°Aplicado!");
            };

            // --- ADMIN ---
            const saveProduct = async () => {
                if (!newProduct.name || !newProduct.basePrice) return alert("Faltan datos");
                setIsLoading(true);
                const pData = { ...newProduct, basePrice: Number(newProduct.basePrice), stock: Number(newProduct.stock), discount: Number(newProduct.discount || 0), image: newProduct.image || 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=500' };
                if (editingId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', editingId), pData);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), pData);
                setNewProduct({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 }); setEditingId(null); if(fileInputRef.current) fileInputRef.current.value = ""; setIsLoading(false);
            };
            const deleteProd = async () => { if (!productToDelete) return; setIsLoading(true); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productToDelete.id)); setProductToDelete(null); setIsLoading(false); };
            const saveCoupon = async () => { if(!newCoupon.code) return alert("Falta c√≥digo"); setIsLoading(true); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), { ...newCoupon, usedBy: [] }); setNewCoupon({ code: '', discountPercentage: 7, expirationDate: '', userEmail: '' }); setIsLoading(false); };
            const deleteCoupon = async (id) => { if(!confirm("¬øEliminar cup√≥n?")) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'coupons', id)); };
            const handleImage = (e) => { const f = e.target.files[0]; if (f && f.size < 1000000) { const r = new FileReader(); r.onload = () => setNewProduct(prev => ({...prev, image: r.result })); r.readAsDataURL(f); } else alert("Imagen muy pesada."); };
            const handleLogoUpload = (e) => { const f = e.target.files[0]; if (f && f.size < 700000) { const r = new FileReader(); r.onload = () => setTempSettings(prev => ({...prev, logoUrl: r.result})); r.readAsDataURL(f); } else alert("Logo muy pesado."); };
            const saveSettings = async () => { setIsLoading(true); try { const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'settings')); const s = await getDocs(q); const data = { ...tempSettings, aboutUsText: aboutText }; if (!s.empty) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', s.docs[0].id), data); else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), data); alert("Guardado."); } catch (err) { alert("Error: " + err.message); } setIsLoading(false); };
            const handleEditProduct = (p) => { setNewProduct({ ...p, basePrice: p.basePrice }); setEditingId(p.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const initiateDelete = (p) => setProductToDelete(p);
            const handleCancelEdit = () => { setNewProduct({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 }); setEditingId(null); if(fileInputRef.current) fileInputRef.current.value = ""; };
            const handleEditUser = (user) => setEditingUser({ ...user });
            const saveUserEdit = async () => { if (!editingUser) return; setIsLoading(true); try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUser.id), { name: editingUser.name, dni: editingUser.dni, phone: editingUser.phone }); alert("Usuario actualizado."); setEditingUser(null); } catch (e) { alert("Error: " + e.message); } setIsLoading(false); };
            const addCategory = () => { if(newCategory && !tempSettings.categories.includes(newCategory)) { setTempSettings({...tempSettings, categories:[...tempSettings.categories, newCategory]}); setNewCategory(''); } };
            const removeCategory = (c) => setTempSettings({...tempSettings, categories: tempSettings.categories.filter(x => x!==c)});
            const seedDB = async () => { setIsLoading(true); for(const p of [{ name: "iPhone 14 Pro", basePrice: 950000, category: "Celulares", stock: 10, image: "https://images.unsplash.com/photo-1664478546384-d57ffe74a797?q=80&w=500", description: "Potencia ilimitada.", discount: 0 }]) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), p); setIsLoading(false); };
            const toggleFavorite = async (productId) => { let newFavs; if (favorites.includes(productId)) newFavs = favorites.filter(id => id !== productId); else newFavs = [...favorites, productId]; setFavorites(newFavs); if (currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), { favorites: newFavs }); else localStorage.setItem('nexus_favs', JSON.stringify(newFavs)); };
            const goIg = () => window.open(`https://www.instagram.com/${settings.instagramUser}/`, '_blank');
            const goWsp = () => window.open(settings.whatsappLink, '_blank');

            const generateDescription = async () => {
                setAiThinking(true);
                const text = await callGemini(`Descripci√≥n corta para ${newProduct.name} (${newProduct.category}).`);
                if(text) setNewProduct(prev => ({...prev, description: text}));
                setAiThinking(false);
            };
            const generateSocialPost = async (p) => {
                setAiThinking(true);
                const text = await callGemini(`Post Instagram para ${p.name} a $${calculatePrice(p.basePrice, p.discount)}.`);
                setAiThinking(false);
                if(text) { navigator.clipboard.writeText(text); alert("¬°Post generado!"); }
            };
            const generateExpertOpinion = async (p) => {
                setAiThinking(true);
                const text = await callGemini(`3 razones para comprar ${p.name}.`);
                setAiThinking(false);
                alert(`üß† OPINI√ìN:\n\n${text}`);
            };
            const generateTechAnalysis = async (p) => {
                setAiThinking(true);
                const text = await callGemini(`Puntaje 1-10 Gaming/Trabajo para ${p.name}.`);
                setAiThinking(false);
                alert(`üìä AN√ÅLISIS:\n\n${text}`);
            };
            const sendChat = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                const msg = chatInput;
                setChatMessages(p => [...p, { role: 'user', text: msg }]);
                setChatInput('');
                setIsChatLoading(true);
                const ans = await callGemini(`Eres Sustore AI. Cliente: ${msg}. Corto y √∫til.`);
                setChatMessages(p => [...p, { role: 'ai', text: ans }]);
                setIsChatLoading(false);
            };

            const callGemini = async (prompt) => {
                try {
                    if (!apiKey) return "IA no configurada.";
                    const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    }
                    );
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No pude generar respuesta.";
                } catch (error) {
                    console.error("Error Gemini:", error);
                    return "Error IA.";
                }
            };

            // --- RENDER ---
            return (
                <div className="min-h-screen bg-[#020617] text-slate-100 font-sans flex flex-col">
                    {isLoading && <Loading message={loadingMessage} />}
                    {welcomeCode && <WelcomeModal code={welcomeCode} onClose={() => setWelcomeCode(null)} />}

                    {/* HEADER */}
                    <header className="fixed top-0 w-full z-40 glass-panel border-b border-slate-700/50 h-16 flex items-center justify-between px-4 lg:px-8 shadow-lg">
                        <div className="flex items-center gap-4 flex-1">
                            <div onClick={() => setView('store')} className="cursor-pointer">
                                {settings.logoUrl ? <img src={settings.logoUrl} className="h-10 w-10 rounded-full object-cover border-2 border-cyan-500/30"/> : <SustoreLogo />}
                            </div>
                            <div className="hidden md:flex items-center bg-slate-800/50 border border-slate-700 rounded-full px-4 py-2 w-full max-w-md focus-within:border-cyan-500 transition-colors">
                                <Search className="w-4 h-4 mr-2 text-slate-400" />
                                <input className="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-400" placeholder="Buscar..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={goWsp} className="text-green-400 hover:text-green-300 transition hover:scale-110"><MessageCircle className="w-6 h-6"/></button>
                            <button onClick={goIg} className="text-pink-400 hover:text-pink-300 transition hover:scale-110"><Instagram className="w-6 h-6"/></button>
                            <button onClick={() => setView('favorites')} className="text-slate-400 hover:text-red-400 transition"><Heart className={`w-6 h-6 ${favorites.length > 0 ? 'fill-red-500 text-red-500' : ''}`} /></button>
                            <button onClick={() => setView('cart')} className="relative text-slate-300 hover:text-cyan-400 transition"><ShoppingBag className="w-6 h-6" />{cart.length > 0 && <span className="absolute -top-1 -right-1 bg-cyan-500 text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center border border-slate-900 shadow-lg">{cart.length}</span>}</button>
                            {currentUser ? (
                                <div onClick={() => setView('profile')} className="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold text-xs cursor-pointer hover:bg-cyan-500 border border-cyan-400/30 shadow-[0_0_10px_rgba(6,182,212,0.3)]">{currentUser.name.charAt(0).toUpperCase()}</div>
                            ) : (
                                <button onClick={() => setView('login')} className="text-slate-300 hover:text-white"><User className="w-6 h-6"/></button>
                            )}
                            <button onClick={() => setIsMenuOpen(true)} className="text-slate-300 hover:text-white ml-2"><Menu className="w-7 h-7" /></button>
                        </div>
                    </header>
                    <div className="h-16"></div>

                    <main className="flex-grow">
                        {pendingOrderRecover && (
                            <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-up">
                                <div className="bg-slate-800 border border-yellow-500/50 p-6 rounded-2xl shadow-2xl max-w-md w-full text-center relative overflow-hidden">
                                    <div className="absolute inset-0 bg-yellow-500/5"></div>
                                    <AlertTriangle className="w-12 h-12 text-yellow-500 mx-auto mb-4 animate-bounce relative z-10"/>
                                    <h3 className="text-xl font-bold text-white mb-2 relative z-10">¬°Compra Pendiente!</h3>
                                    <p className="text-slate-400 mb-6 text-sm relative z-10">Dejaste un pago de <strong>${pendingOrderRecover.total.toLocaleString()}</strong> sin confirmar.</p>
                                    <div className="flex gap-3 relative z-10">
                                        <button onClick={handleRecoverNo} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-xl font-bold transition">No, descartar</button>
                                        <button onClick={handleRecoverYes} className="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold transition shadow-lg shadow-yellow-900/20">S√≠, continuar</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'store' && (
                            <div className="animate-fade-up">
                                <div className="relative h-[500px] flex items-center justify-center overflow-hidden bg-slate-950">
                                    <div className="absolute inset-0 bg-cover bg-center opacity-40" style={{ backgroundImage: `url('${settings.heroUrl || "https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1920&auto=format&fit=crop"}')` }}></div>
                                    <div className="absolute inset-0 bg-gradient-to-t from-[#020617] via-transparent to-transparent"></div>
                                    <div className="relative z-10 text-center px-4">
                                        <span className="bg-cyan-500/10 border border-cyan-500/30 text-cyan-300 text-xs font-bold px-6 py-2 rounded-full uppercase tracking-[0.2em] mb-6 inline-block backdrop-blur-sm shadow-[0_0_15px_rgba(6,182,212,0.1)]">Tecnolog√≠a Premium</span>
                                        <h1 className="text-5xl md:text-7xl font-black text-white mb-8 drop-shadow-2xl tracking-tight neon-text">NEXT LEVEL</h1>
                                        <button onClick={() => document.getElementById('products')?.scrollIntoView({behavior:'smooth'})} className="bg-white text-slate-950 px-10 py-4 rounded-full font-bold shadow-[0_0_30px_rgba(255,255,255,0.2)] hover:scale-105 transition duration-300 hover:shadow-[0_0_40px_rgba(255,255,255,0.4)]">EXPLORAR CAT√ÅLOGO</button>
                                    </div>
                                </div>
                                <div id="products" className="max-w-7xl mx-auto px-4 py-16">
                                    <div className="flex items-center justify-between mb-8">
                                        <div className="flex items-center gap-4">
                                            <div className="h-8 w-1.5 bg-gradient-to-b from-cyan-400 to-purple-600 rounded-full"></div>
                                            <h2 className="text-3xl font-bold text-white tracking-tight">{selectedCategory ? selectedCategory : 'Novedades'}</h2>
                                        </div>
                                        <div className="flex gap-4">
                                            {selectedCategory && <button onClick={() => setSelectedCategory('')} className="text-xs text-red-400 hover:text-red-300 flex items-center gap-1"><XCircle className="w-4 h-4"/> Borrar Filtro</button>}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                        {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase())).filter(p => !selectedCategory || p.category === selectedCategory).map(p => (
                                            <div key={p.id} className="bg-slate-900 rounded-3xl overflow-hidden shadow-2xl border border-slate-800 hover:border-cyan-500/30 transition duration-300 group relative">
                                                <div className="h-64 overflow-hidden relative bg-slate-950">
                                                    <img src={p.image} className={`w-full h-full object-cover transition duration-700 ${Number(p.stock) > 0 ? 'group-hover:scale-110' : 'grayscale opacity-50'}`}/>
                                                    <div className="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                                    <button onClick={() => toggleFavorite(p.id)} className="absolute top-4 right-4 p-2 rounded-full bg-black/40 backdrop-blur-md hover:bg-white hover:text-red-500 transition text-white z-20"><Heart className={`w-5 h-5 ${favorites.includes(p.id) ? 'fill-red-500 text-red-500' : ''}`} /></button>
                                                    {p.discount ? <div className="absolute top-4 left-4 bg-red-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg z-20">{p.discount}% OFF</div> : null}
                                                    {Number(p.stock) > 0 ? (
                                                        <button onClick={() => manageCart(p, 1)} className="absolute bottom-4 right-4 bg-white text-slate-900 p-3 rounded-full shadow-lg opacity-0 group-hover:opacity-100 translate-y-4 group-hover:translate-y-0 transition duration-300 hover:bg-cyan-400 hover:text-white z-20"><Plus className="w-6 h-6"/></button>
                                                    ) : (
                                                        <div className="absolute inset-0 bg-black/70 flex items-center justify-center backdrop-blur-sm z-10"><span className="text-white font-bold bg-red-600/80 px-4 py-2 rounded-lg border border-red-500 backdrop-blur-md">AGOTADO</span></div>
                                                    )}
                                                </div>
                                                <div className="p-6">
                                                    <p className="text-[10px] text-cyan-400 font-bold uppercase mb-2 tracking-widest">{p.category}</p>
                                                    <h3 className="font-bold text-white text-lg truncate mb-3 group-hover:text-cyan-300 transition">{p.name}</h3>
                                                    <div className="flex justify-between items-end border-t border-slate-800 pt-4">
                                                        <div className="flex flex-col">
                                                            {p.discount ? <span className="text-xs text-slate-500 line-through">${getRawPrice(p.basePrice).toLocaleString()}</span> : null}
                                                            <span className="text-2xl font-black text-white">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</span>
                                                        </div>
                                                        <span className={`text-[10px] px-2 py-1 rounded border ${Number(p.stock) > 0 ? 'bg-green-900/10 text-green-400 border-green-500/20' : 'bg-red-900/10 text-red-400 border-red-500/20'}`}>{Number(p.stock) > 0 ? 'En Stock' : 'Sin Stock'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* CHECKOUT */}
                        {view === 'checkout' && currentUser && (
                            <div className="max-w-md mx-auto px-4 py-12 animate-fade-up">
                                <button onClick={() => setView('cart')} className="mb-6 text-slate-400 hover:text-white flex items-center transition"><ArrowRight className="w-4 h-4 rotate-180 mr-2"/> Volver al Carrito</button>
                                <div className="bg-white p-8 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.3)] text-slate-900 relative overflow-hidden deposit-card">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600"></div>
                                    <h2 className="text-3xl font-black text-center mb-1 text-slate-800">Finalizar Compra</h2>
                                    <p className="text-center text-slate-500 text-sm mb-8 flex justify-center items-center gap-1"><ShieldCheck className="w-4 h-4 text-green-500"/> Pago 100% Seguro</p>
                                    
                                    <div className="flex gap-2 mb-6">
                                        <input className="flex-1 bg-slate-100 border border-slate-200 p-3 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-purple-500 uppercase" placeholder="C√ìDIGO CUP√ìN" value={checkoutCoupon} onChange={e => setCheckoutCoupon(e.target.value)}/>
                                        <button onClick={validateCoupon} className="bg-purple-600 hover:bg-purple-700 text-white px-4 rounded-xl font-bold text-xs transition shadow-lg shadow-purple-200">APLICAR</button>
                                    </div>
                                    {appliedCoupon && <div className="mb-6 text-green-700 text-sm font-bold bg-green-50 p-3 rounded-xl border border-green-200 flex justify-between items-center"><span><Ticket className="w-4 h-4 inline mr-1"/> {appliedCoupon.code}</span> <span>-{appliedCoupon.discountPercentage}% OFF</span></div>}
                                    <div className="bg-slate-50 p-6 rounded-2xl mb-8 text-center border border-slate-200 relative">
                                        <p className="text-xs text-slate-500 uppercase font-bold mb-1 tracking-widest">Total a Pagar</p>
                                        <div className="text-5xl font-black text-slate-900 tracking-tighter">${cartTotal.toLocaleString()}</div>
                                        <div className="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-full text-[10px] font-bold text-slate-400 border border-slate-200 shadow-sm">ARS</div>
                                    </div>
                                    <div className="space-y-4">
                                        <input className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-slate-800 focus:bg-white focus:border-cyan-500 outline-none transition" placeholder="Direcci√≥n de Env√≠o Completa" value={checkoutData.address} onChange={e => setCheckoutData({...checkoutData, address: e.target.value})}/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-slate-800 focus:bg-white focus:border-cyan-500 outline-none transition" placeholder="Ciudad" value={checkoutData.city} onChange={e => setCheckoutData({...checkoutData, city: e.target.value})}/>
                                            <input className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-slate-800 focus:bg-white focus:border-cyan-500 outline-none transition" placeholder="CP (4 d√≠gitos)" maxLength="4" value={checkoutData.zipCode} onChange={e => setCheckoutData({...checkoutData, zipCode: e.target.value})}/>
                                        </div>
                                        <input className="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-slate-800 focus:bg-white focus:border-cyan-500 outline-none transition" placeholder="Nombre Titular Tarjeta" value={checkoutData.transferHolder} onChange={e => setCheckoutData({...checkoutData, transferHolder: e.target.value})}/>
                                        <button onClick={handleGoToMP} className="w-full py-4 bg-[#009EE3] hover:bg-[#008ED0] text-white text-lg font-bold rounded-xl shadow-lg transition flex justify-center items-center gap-3 mt-4 group"><span>PAGAR AHORA</span><ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition"/></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* CART */}
                        {view === 'cart' && (
                            <div className="max-w-2xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-3xl font-bold text-white mb-8 flex items-center gap-3"><ShoppingBag className="text-cyan-400 w-8 h-8"/> Tu Carrito</h2>
                                {cart.length === 0 ? <p className="text-slate-500 text-center py-20 bg-slate-900/50 rounded-3xl border border-dashed border-slate-800">Tu carrito est√° vac√≠o.</p> : (
                                <div className="space-y-4">
                                    {cart.map((item, i) => (
                                        <div key={i} className="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex items-center gap-4 shadow-lg">
                                            <img src={item.product.image} className="w-20 h-20 object-cover rounded-xl bg-slate-950"/>
                                            <div className="flex-1">
                                                <h4 className="text-white font-bold text-lg">{item.product.name}</h4>
                                                <p className="text-cyan-400 font-bold text-xl">${calculatePrice(item.product.basePrice, item.product.discount).toLocaleString()}</p>
                                            </div>
                                            <div className="flex items-center gap-3 bg-slate-950 rounded-xl p-2 border border-slate-800">
                                                <button onClick={()=>manageCart(item.product, -1)} className="text-slate-400 hover:text-white p-1"><Minus className="w-4 h-4"/></button>
                                                <span className="text-white font-bold w-6 text-center">{item.quantity}</span>
                                                <button onClick={()=>manageCart(item.product, 1)} className="text-slate-400 hover:text-white p-1"><Plus className="w-4 h-4"/></button>
                                            </div>
                                        </div>
                                    ))}
                                    <div className="mt-8 p-8 bg-slate-900/80 backdrop-blur-md rounded-3xl border border-slate-700 flex flex-col md:flex-row justify-between items-center shadow-2xl sticky bottom-4">
                                        <div className="mb-4 md:mb-0 text-center md:text-left"><p className="text-slate-400 text-xs uppercase tracking-widest font-bold mb-1">Total Estimado</p><span className="text-4xl font-black text-white tracking-tight">${cartSubtotal.toLocaleString()}</span></div>
                                        <button onClick={()=>{if(!currentUser){alert("Inicia sesi√≥n para comprar");setView('login')}else setView('checkout')}} className="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white px-10 py-4 rounded-full font-bold shadow-lg shadow-cyan-900/20 transition transform hover:-translate-y-1">IR A PAGAR</button>
                                    </div>
                                </div>
                                )}
                            </div>
                        )}

                        {/* AUTH */}
                        {(view === 'login' || view === 'register') && (
                            <div className="flex items-center justify-center min-h-[80vh] px-4 animate-fade-up">
                                <div className="bg-slate-900 p-10 rounded-3xl shadow-2xl w-full max-w-md border border-slate-800 relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-cyan-500 via-purple-500 to-blue-500"></div>
                                    <h2 className="text-3xl font-bold text-center text-white mb-2">{view === 'login' ? 'Bienvenido' : 'Crear Cuenta'}</h2>
                                    {authError && <div className="bg-red-500/10 border border-red-500/50 text-red-200 p-4 rounded-xl mb-6 text-sm flex items-center gap-3"><AlertCircle className="w-5 h-5 flex-shrink-0"/> {authError}</div>}
                                    <form onSubmit={view === 'login' ? onLoginSubmit : onRegisterSubmit} className="space-y-4">
                                        {view === 'register' && (
                                            <>
                                            <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500 transition" placeholder="Nombre Completo" value={registerData.name} onChange={e => setRegisterData({...registerData, name: e.target.value})}/>
                                            <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500 transition" placeholder="DNI (Sin puntos)" value={registerData.dni} onChange={e => setRegisterData({...registerData, dni: e.target.value})}/>
                                            </>
                                        )}
                                        <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500 transition" placeholder="Email" value={view === 'login' ? loginData.email : registerData.email} onChange={e => view === 'login' ? setLoginData({...loginData, email: e.target.value}) : setRegisterData({...registerData, email: e.target.value})}/>
                                        {view === 'register' && <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500 transition" placeholder="Tel√©fono" value={registerData.phone} onChange={e => setRegisterData({...registerData, phone: e.target.value})}/>}
                                        <input className="w-full bg-slate-950 border border-slate-700 p-4 rounded-xl text-white outline-none focus:border-cyan-500 transition" type="password" placeholder="Contrase√±a" value={view === 'login' ? loginData.password : registerData.password} onChange={e => view === 'login' ? setLoginData({...loginData, password: e.target.value}) : setRegisterData({...registerData, password: e.target.value})}/>
                                        <button className="w-full bg-cyan-600 text-white py-4 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/20">{view === 'login' ? 'INGRESAR' : 'REGISTRARSE'}</button>
                                    </form>
                                    <button onClick={() => { setView(view === 'login' ? 'register' : 'login'); setAuthError(''); }} className="w-full text-center text-slate-400 text-sm mt-8 hover:text-white transition">{view === 'login' ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Ingresa'}</button>
                                </div>
                            </div>
                        )}

                        {/* ADMIN & PROFILE */}
                        {view === 'profile' && currentUser && (
                            <div className="max-w-3xl mx-auto px-4 py-12 animate-fade-up">
                                <div className="bg-slate-900 p-8 rounded-3xl border border-slate-800 mb-10 flex items-center gap-6 shadow-lg relative overflow-hidden">
                                    <div className="w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-inner relative z-10">{currentUser.name[0]}</div>
                                    <div className="relative z-10"><h2 className="text-2xl font-bold text-white">{currentUser.name}</h2><p className="text-slate-400">{currentUser.email}</p></div>
                                </div>
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><Ticket className="text-yellow-400"/> Mis Cupones</h3>
                                <div className="grid sm:grid-cols-2 gap-4 mb-8">
                                    {coupons.filter(c => (c.userEmail === currentUser.email) && !c.usedBy.includes(currentUser.id)).map(c => (
                                        <div key={c.id} className="bg-slate-900 border border-yellow-500/30 p-4 rounded-xl flex justify-between items-center relative overflow-hidden group cursor-pointer" onClick={() => {navigator.clipboard.writeText(c.code); alert("Cup√≥n copiado");}}>
                                            <div className="absolute top-0 left-0 w-1 h-full bg-yellow-500"></div>
                                            <div><p className="font-bold text-yellow-400 text-lg">{c.code}</p><p className="text-[10px] text-slate-500 uppercase">Vence: {new Date(c.expirationDate).toLocaleDateString()}</p></div>
                                            <span className="text-2xl font-black text-white">{c.discountPercentage}%</span>
                                        </div>
                                    ))}
                                </div>
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><ShoppingBag className="text-purple-400"/> Historial de Compras</h3>
                                <div className="space-y-4">
                                {userOrders.map(o => (
                                    <div key={o.orderId} className="bg-slate-900 p-6 rounded-2xl border border-slate-800 hover:border-slate-700 transition">
                                        <div className="flex justify-between items-center mb-4 border-b border-slate-800 pb-4">
                                            <div><span className="bg-slate-800 text-white text-xs px-2 py-1 rounded mr-2 font-mono">#{o.orderId}</span><span className="text-xs text-slate-400">{o.displayDate}</span></div>
                                            <span className={`text-xs px-3 py-1 rounded-full font-bold ${o.status === 'Pagado' ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'}`}>{o.status}</span>
                                        </div>
                                        <div className="text-right border-t border-slate-800 pt-3"><p className="text-lg font-black text-white">Total: ${o.total.toLocaleString()}</p></div>
                                    </div>
                                ))}
                                </div>
                            </div>
                        )}

                        {view === 'admin' && isAdmin(currentUser?.email) && (
                            <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                                <div className="flex justify-between items-end mb-8 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                                    <div><h2 className="text-3xl font-bold text-white mb-1">Panel de Control</h2><p className="text-slate-400 text-sm">Gesti√≥n Total</p></div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setView('users_list')} className="bg-blue-900/30 border border-blue-500/30 text-blue-300 px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-900/50 transition flex items-center gap-2"><Users className="w-4 h-4"/> Usuarios</button>
                                        <button onClick={() => setView('sales_report')} className="bg-purple-900/30 border border-purple-500/30 text-purple-300 px-4 py-2 rounded-lg font-bold text-sm hover:bg-purple-900/50 transition flex items-center gap-2"><BarChart className="w-4 h-4"/> Ventas</button>
                                        <button onClick={() => setView('store')} className="bg-slate-800 text-slate-200 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-700 transition">Salir</button>
                                    </div>
                                </div>
                                <div className="grid lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2 space-y-8">
                                        <div className="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800">
                                            <h3 className="font-bold text-white mb-6 flex gap-2 items-center text-lg">{editingId ? 'Editar' : 'Nuevo'} Producto</h3>
                                            <div className="grid md:grid-cols-2 gap-5">
                                                <div className="md:col-span-2"><label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Nombre</label><input className="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})}/></div>
                                                <div><label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Precio Base</label><input type="number" className="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.basePrice} onChange={e => setNewProduct({...newProduct, basePrice: e.target.value})}/></div>
                                                <div><label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Stock</label><input type="number" className="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.stock} onChange={e => setNewProduct({...newProduct, stock: e.target.value})}/></div>
                                                <div className="md:col-span-2"><label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Categor√≠a</label><select className="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.category} onChange={(e) => setNewProduct({...newProduct, category: e.target.value})}><option value="">Seleccionar...</option>{settings.categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div>
                                                <div className="col-span-2"><label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Imagen</label><input type="file" onChange={handleImage} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-slate-800 file:text-white hover:file:bg-cyan-600 cursor-pointer"/></div>
                                            </div>
                                            <div className="flex gap-2 mt-6">
                                                {editingId && <button onClick={handleCancelEdit} className="flex-1 py-3 rounded-xl font-bold text-slate-400 border border-slate-700 hover:bg-slate-800">Cancelar</button>}
                                                <button onClick={saveProduct} className="flex-1 py-3 rounded-xl font-bold text-white bg-cyan-600 hover:bg-cyan-500 shadow-lg transition">{editingId ? 'Actualizar' : 'Publicar'}</button>
                                            </div>
                                        </div>
                                        
                                        {/* GESTI√ìN CUPONES */}
                                        <div className="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800">
                                            <h3 className="font-bold text-white mb-6 flex gap-2 items-center text-lg"><Ticket className="text-yellow-400"/> Crear Cup√≥n</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <input className="bg-slate-950 border border-slate-700 p-3 rounded-lg text-white" placeholder="C√ìDIGO" value={newCoupon.code} onChange={e => setNewCoupon({...newCoupon, code: e.target.value.toUpperCase()})}/>
                                                <input className="bg-slate-950 border border-slate-700 p-3 rounded-lg text-white" type="number" placeholder="%" value={newCoupon.discountPercentage} onChange={e => setNewCoupon({...newCoupon, discountPercentage: Number(e.target.value)})}/>
                                                <input className="bg-slate-950 border border-slate-700 p-3 rounded-lg text-white text-xs" type="date" value={newCoupon.expirationDate} onChange={e => setNewCoupon({...newCoupon, expirationDate: e.target.value})}/>
                                                <input className="bg-slate-950 border border-slate-700 p-3 rounded-lg text-white text-xs" placeholder="Email (Opcional)" value={newCoupon.userEmail} onChange={e => setNewCoupon({...newCoupon, userEmail: e.target.value})}/>
                                            </div>
                                            <button onClick={saveCoupon} className="w-full mt-4 bg-yellow-600 text-white font-bold py-2 rounded-lg hover:bg-yellow-500">Crear Cup√≥n</button>
                                            <div className="mt-6 border-t border-slate-800 pt-4"><p className="text-xs text-slate-400 uppercase font-bold mb-2">Cupones Activos</p><div className="space-y-2 max-h-40 overflow-y-auto">{coupons.map(c => (<div key={c.id} className="flex justify-between items-center text-xs bg-slate-950 p-2 rounded border border-slate-800"><span><strong className="text-yellow-400">{c.code}</strong> ({c.discountPercentage}%)</span><button onClick={() => deleteCoupon(c.id)} className="text-red-400"><Trash2 className="w-3 h-3"/></button></div>))}</div></div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800 h-fit sticky top-24">
                                        <h3 className="font-bold text-white mb-6 flex items-center gap-2 text-lg"><Settings className="w-5 h-5 text-purple-400"/> Ajustes</h3>
                                        <div className="space-y-5">
                                            <div className="pt-4 border-t border-slate-800"><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Texto "Sobre Nosotros"</label><textarea className="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl outline-none text-white transition h-24 text-xs" value={aboutText} onChange={(e) => setAboutText(e.target.value)} /></div>
                                            <div className="pt-4 border-t border-slate-800"><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Markup (%)</label><input type="number" className="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl outline-none text-green-400 font-bold transition" value={settings.markupPercentage} onChange={(e) => setTempSettings({...tempSettings, markupPercentage: Number(e.target.value)})} /></div>
                                            <div className="pt-4 border-t border-slate-800"><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Logo Tienda</label><input type="file" accept="image/*" className="text-xs text-slate-500" onChange={handleLogoUpload} /></div>
                                            <div><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Categor√≠as</label><div className="flex gap-2 mb-2"><input className="w-full bg-slate-950 border border-slate-700 p-2 rounded-lg outline-none text-white text-xs" placeholder="Nueva..." value={newCategory} onChange={(e) => setNewCategory(e.target.value)}/><button onClick={addCategory} className="bg-green-600 text-white p-2 rounded-lg hover:bg-green-500"><Plus className="w-4 h-4"/></button></div><div className="flex flex-wrap gap-2">{settings.categories.map(cat => (<span key={cat} className="text-xs bg-slate-900 text-slate-300 px-2 py-1 rounded border border-slate-700 flex items-center gap-1">{cat}<button onClick={() => removeCategory(cat)} className="hover:text-red-400"><X className="w-3 h-3"/></button></span>))}</div></div>
                                            <div className="pt-4 border-t border-slate-800"><label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Gestionar Productos</label><div className="max-h-60 overflow-y-auto rounded-lg border border-slate-700"><table className="w-full text-left text-xs text-slate-400"><thead className="bg-slate-900 text-slate-300 sticky top-0"><tr><th className="p-2">Nombre</th><th className="p-2 text-right">Acci√≥n</th></tr></thead><tbody className="divide-y divide-slate-700">{products.map(p => (<tr key={p.id} className="hover:bg-slate-700/50"><td className="p-2 text-white">{p.name}</td><td className="p-2 text-right flex justify-end gap-1"><button onClick={() => handleEditProduct(p)} className="p-1 bg-blue-900/30 text-blue-400 rounded"><Edit className="w-3 h-3"/></button><button onClick={() => initiateDelete(p)} className="p-1 bg-red-900/30 text-red-400 rounded"><Trash2 className="w-3 h-3"/></button></td></tr>))}</tbody></table></div></div>
                                            <button onClick={saveSettings} className="bg-purple-600 text-white px-4 py-3 rounded-xl font-bold w-full hover:bg-purple-500 shadow-lg transition">Guardar Cambios</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* USERS LIST & EDIT */}
                        {view === 'users_list' && isAdmin(currentUser?.email) && (
                            <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-4"><button onClick={() => setView('admin')} className="bg-slate-800 p-2 rounded-full hover:bg-slate-700 transition text-slate-300 hover:text-white"><ArrowRight className="w-5 h-5 rotate-180"/></button><h2 className="text-3xl font-bold text-white">Usuarios</h2></div>
                                    <div className="bg-slate-800 p-2 rounded-lg border border-slate-700 text-slate-400 text-sm">Total: <span className="text-white font-bold">{users.length}</span></div>
                                </div>
                                <div className="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                                    <table className="w-full text-left text-sm"><thead className="bg-slate-900 text-cyan-400 uppercase text-xs font-bold tracking-wider"><tr><th className="p-5">Nombre</th><th className="p-5">Email</th><th className="p-5">DNI</th><th className="p-5">Tel√©fono</th><th className="p-5">Acci√≥n</th></tr></thead><tbody className="divide-y divide-slate-700/50">{users.map(u => (<tr key={u.id} className="hover:bg-slate-700/30 transition"><td className="p-5 font-bold text-white">{u.name}</td><td className="p-5 text-cyan-300">{u.email}</td><td className="p-5 text-slate-300">{u.dni}</td><td className="p-5 text-slate-300">{u.phone}</td><td className="p-5"><button onClick={() => handleEditUser(u)} className="text-blue-400 hover:text-blue-200 p-2 bg-blue-900/20 rounded"><Edit className="w-4 h-4"/></button></td></tr>))}</tbody></table>
                                </div>
                                {editingUser && (
                                    <div className="fixed inset-0 bg-black/80 z-[90] flex items-center justify-center p-4">
                                        <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-full max-w-md">
                                            <h3 className="text-xl font-bold text-white mb-4">Editar Usuario</h3>
                                            <div className="space-y-3">
                                                <input className="w-full bg-slate-950 border border-slate-700 p-3 rounded-lg text-white" value={editingUser.name} onChange={e => setEditingUser({...editingUser, name: e.target.value})} placeholder="Nombre"/>
                                                <input className="w-full bg-slate-950 border border-slate-700 p-3 rounded-lg text-white" value={editingUser.dni} onChange={e => setEditingUser({...editingUser, dni: e.target.value})} placeholder="DNI"/>
                                                <input className="w-full bg-slate-950 border border-slate-700 p-3 rounded-lg text-white" value={editingUser.phone} onChange={e => setEditingUser({...editingUser, phone: e.target.value})} placeholder="Tel√©fono"/>
                                            </div>
                                            <div className="flex gap-2 mt-6"><button onClick={() => setEditingUser(null)} className="flex-1 py-2 bg-slate-800 text-slate-300 rounded-lg">Cancelar</button><button onClick={saveUserEdit} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Guardar</button></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* SALES REPORT */}
                        {view === 'sales_report' && isAdmin(currentUser?.email) && (
                            <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                                <div className="flex items-center justify-between mb-8">
                                    <div className="flex items-center gap-4"><button onClick={() => setView('admin')} className="bg-slate-800 p-2 rounded-full hover:bg-slate-700 transition text-slate-300 hover:text-white"><ArrowRight className="w-5 h-5 rotate-180"/></button><h2 className="text-3xl font-bold text-white">Ventas</h2></div>
                                    <div className="flex gap-2 bg-slate-800 p-1 rounded-lg border border-white/10"><button onClick={() => setActiveTab('completed')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${activeTab === 'completed' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white'}`}>COMPLETADAS</button><button onClick={() => setActiveTab('pending')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${activeTab === 'pending' ? 'bg-yellow-600 text-white' : 'text-slate-400 hover:text-white'}`}>PENDIENTES</button></div>
                                </div>
                                <div className="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                                    <table className="w-full text-left text-sm"><thead className="bg-slate-900 text-cyan-400 uppercase text-xs font-bold tracking-wider"><tr><th className="p-5">ID</th><th className="p-5">Cliente</th><th className="p-5">Total</th><th className="p-5">Estado</th><th className="p-5">Acci√≥n</th></tr></thead><tbody className="divide-y divide-slate-700/50">{orders.filter(o => activeTab === 'pending' ? o.status === 'Pendiente' : o.status === 'Pagado').map(o => (<tr key={o.id} className="hover:bg-slate-700/30 transition"><td className="p-5 font-bold text-white">{o.orderId}</td><td className="p-5"><p className="text-white font-bold">{o.userName}</p><p className="text-xs text-slate-400">{o.userEmail}</p></td><td className="p-5"><span className="text-green-400 font-bold">${o.total.toLocaleString()}</span></td><td className="p-5"><span className={`text-xs px-2 py-1 rounded font-bold ${o.status==='Pagado'?'bg-green-900/30 text-green-400':'bg-yellow-900/30 text-yellow-400'}`}>{o.status}</span></td><td className="p-5"><button onClick={() => { if(confirm("¬øBorrar?")) deleteDoc(doc(db,'artifacts',appId,'public','data','orders',o.id)); }} className="text-red-400 p-2 bg-red-900/20 rounded"><Trash2 className="w-4 h-4"/></button></td></tr>))}</tbody></table>
                                </div>
                            </div>
                        )}

                        {isMenuOpen && (
                            <div className="fixed inset-0 z-[60] flex justify-end animate-fade-up">
                                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}></div>
                                <div className="relative bg-slate-900 w-72 h-full shadow-2xl flex flex-col border-l border-slate-800">
                                    <div className="p-6 border-b border-slate-800 flex justify-between items-center"><span className="font-bold text-lg text-white tracking-widest">MEN√ö</span><button onClick={() => setIsMenuOpen(false)}><X className="text-slate-400 hover:text-white"/></button></div>
                                    <div className="p-4 space-y-2 overflow-y-auto flex-1">
                                        <button onClick={() => { setView('store'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 flex gap-3 text-slate-300 hover:text-white font-medium transition"><Home className="w-5 h-5"/> Inicio</button>
                                        <button onClick={() => { setView('about'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl hover:bg-slate-800 flex gap-3 text-slate-300 hover:text-white font-medium transition"><Info className="w-5 h-5"/> Sobre Nosotros</button>
                                        {currentUser && isAdmin(currentUser.email) && <button onClick={() => { setView('admin'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded-xl bg-purple-500/10 text-purple-300 font-bold flex gap-3 border border-purple-500/20 mt-4 hover:bg-purple-500/20 transition"><Zap className="w-5 h-5"/> PANEL ADMIN</button>}
                                    </div>
                                    {currentUser && <div className="p-6 border-t border-slate-800"><button onClick={() => setShowLogoutConfirm(true)} className="w-full py-3 border border-red-500/20 text-red-400 rounded-xl text-sm font-bold hover:bg-red-500/10 flex items-center justify-center gap-2 transition"><LogOut className="w-4 h-4" /> Cerrar Sesi√≥n</button></div>}
                                </div>
                            </div>
                        )}

                        {showLogoutConfirm && (
                            <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 p-4 animate-fade-up">
                                <div className="bg-slate-900 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-700 text-center">
                                    <h3 className="font-bold text-lg mb-4 text-white">¬øCerrar Sesi√≥n?</h3>
                                    <div className="flex gap-3"><button onClick={() => setShowLogoutConfirm(false)} className="flex-1 py-2 bg-slate-800 rounded-lg text-slate-200 font-bold">Cancelar</button><button onClick={handleLogout} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Salir</button></div>
                                </div>
                            </div>
                        )}

                        <footer className="bg-slate-950 py-8 border-t border-slate-800 mt-auto">
                            <div className="max-w-7xl mx-auto px-4 text-center">
                                <div className="flex justify-center gap-6 mb-4">
                                    <button onClick={goIg} className="text-slate-400 hover:text-pink-500 transition"><Instagram className="w-6 h-6"/></button>
                                    <button onClick={goWsp} className="text-slate-400 hover:text-green-500 transition"><MessageCircle className="w-6 h-6"/></button>
                                </div>
                                <p className="text-slate-600 text-sm">¬© 2024 Sustore Technology. Todos los derechos reservados.</p>
                            </div>
                        </footer>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
