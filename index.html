<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustore - Tecnología Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
        .glass-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .input-dark { background-color: #1e293b; border: 1px solid #334155; color: white; border-radius: 0.75rem; transition: all 0.2s; outline: none; }
        .input-dark:focus { border-color: #06b6d4; box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2); }
        .animate-fade-up { animation: fadeUp 0.5s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animaciones para Toasts */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-enter { animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .toast-exit { animation: fadeOut 0.4s ease forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ShoppingBag, X, User, Search, Zap, CheckCircle, MessageCircle, Instagram, Minus, Heart, Tag, Plus, Trash2, Edit, AlertTriangle, RefreshCw, Brain, Ticket, LogOut, Mail, Lock, Gift, Copy, Save, AlertCircle, Menu, Home, Info, FileText, UserPlus, Shield, Smartphone, ArrowRight, ArrowLeft } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, getDocs, deleteDoc, where, writeBatch } from 'firebase/firestore';

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAfllte-D_I3h3TwBaiSL4KVfWrCSVh9ro",
          authDomain: "sustore-63266.firebaseapp.com",
          projectId: "sustore-63266",
          storageBucket: "sustore-63266.firebasestorage.app",
          messagingSenderId: "684651914850",
          appId: "1:684651914850:web:f3df09e5caf6e50e9e533b",
          measurementId: "G-X3K7XGYPRD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "sustore-prod-v3";

        const defaultSettings = {
            storeName: "SUSTORE", primaryColor: "#06b6d4", currency: "$", admins: "lautarocorazza63@gmail.com", sellerEmail: "sustoresf@gmail.com", instagramUser: "sustore_sf", whatsappLink: "https://wa.me/message/3MU36VTEKINKP1", logoUrl: "", heroUrl: "", markupPercentage: 6.50, categories: ["Celulares", "Accesorios", "Audio", "Computación", "Gaming"], aboutUsText: "Somos una empresa dedicada a traer la mejor tecnología al mejor precio."
        };

        // --- COMPONENTES UI MEJORADOS ---
        
        // Componente Toast (Notificación)
        const Toast = ({ message, type, onClose }) => {
            const bgColors = {
                success: 'bg-slate-800 border-green-500',
                error: 'bg-slate-800 border-red-500',
                info: 'bg-slate-800 border-cyan-500',
                warning: 'bg-slate-800 border-yellow-500'
            };
            const icons = {
                success: <CheckCircle className="w-5 h-5 text-green-400" />,
                error: <AlertCircle className="w-5 h-5 text-red-400" />,
                info: <Info className="w-5 h-5 text-cyan-400" />,
                warning: <AlertTriangle className="w-5 h-5 text-yellow-400" />
            };

            useEffect(() => {
                const timer = setTimeout(() => { onClose(); }, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`toast-enter flex items-center gap-3 p-4 rounded-xl border-l-4 shadow-2xl mb-3 max-w-sm w-full backdrop-blur-md ${bgColors[type] || bgColors.info} border border-slate-700/50 text-white relative overflow-hidden group`}>
                    <div className="flex-shrink-0">{icons[type] || icons.info}</div>
                    <p className="text-sm font-medium pr-6">{message}</p>
                    <button onClick={onClose} className="absolute top-2 right-2 text-slate-500 hover:text-white opacity-0 group-hover:opacity-100 transition"><X className="w-4 h-4" /></button>
                </div>
            );
        };

        // Modal de Confirmación Personalizado
        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-up">
                    <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <p className="text-slate-400 mb-6 text-sm">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg font-bold transition">Cancelar</button>
                            <button onClick={onConfirm} className="flex-1 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold transition">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Loading = ({ message }) => (<div className="fixed inset-0 bg-[#020617]/95 z-[200] flex flex-col items-center justify-center backdrop-blur-md">{message === 'EMAIL' ? (<><div className="bg-white p-4 rounded-full mb-6 animate-bounce shadow-lg"><Mail className="w-12 h-12 text-[#009EE3]" /></div><p className="text-white text-xl font-bold tracking-widest animate-pulse">ENVIANDO PEDIDO...</p><p className="text-slate-400 text-sm mt-3">Revisa tu correo en breve</p></>) : (<><RefreshCw className="w-12 h-12 text-cyan-500 animate-spin mb-4"/><p className="text-cyan-400 text-sm font-bold tracking-widest animate-pulse">{message || 'CARGANDO...'}</p></>)}</div>);

        function App() {
            // ... estados existentes ...
            const [view, setView] = useState('store');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState(() => { try { return JSON.parse(localStorage.getItem('nexus_cart')) || []; } catch(e) { return []; } });
            const [users, setUsers] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [favorites, setFavorites] = useState([]);
            const [orders, setOrders] = useState([]);
            const [userOrders, setUserOrders] = useState([]);
            const [settings, setSettings] = useState(defaultSettings);
            const [systemUser, setSystemUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [productToDelete, setProductToDelete] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(''); 
            const [authError, setAuthError] = useState('');
            const [checkoutCoupon, setCheckoutCoupon] = useState('');
            const [appliedCoupon, setAppliedCoupon] = useState(null);
            const [pendingOrderRecover, setPendingOrderRecover] = useState(null);
            
            // --- NUEVOS ESTADOS PARA UI ---
            const [toasts, setToasts] = useState([]);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
            // ------------------------------
            
            const [loginData, setLoginData] = useState({ identifier: '', password: '' }); 
            const [registerData, setRegisterData] = useState({ name: '', username: '', email: '', password: '', dni: '', phone: '' });
            const [checkoutData, setCheckoutData] = useState({ address: '', city: '', province: 'Santa Fe', zipCode: '', references: '', paymentChoice: '' });
            const [tempSettings, setTempSettings] = useState(defaultSettings);
            const [newProduct, setNewProduct] = useState({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 });
            const [newCoupon, setNewCoupon] = useState({ code: '', discountPercentage: 10, expirationDate: '', targetUser: '', usageLimit: '' });
            const [editingId, setEditingId] = useState(null);
            const [newCategory, setNewCategory] = useState('');
            const [editingUser, setEditingUser] = useState(null);
            const [aboutText, setAboutText] = useState('');
            const [newAdminEmail, setNewAdminEmail] = useState('');

            const fileInputRef = useRef(null);

            // --- HELPER PARA TOASTS ---
            const showToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };
            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            // --- HELPER PARA CONFIRM MODAL ---
            const confirmAction = (title, message, action) => {
                setModalConfig({
                    isOpen: true,
                    title,
                    message,
                    onConfirm: () => { action(); setModalConfig({ ...modalConfig, isOpen: false }); }
                });
            };

            // --- SYNC ---
            useEffect(() => { localStorage.setItem('nexus_cart', JSON.stringify(cart)); }, [cart]);
            useEffect(() => { const initAuth = async () => { await signInAnonymously(auth); }; initAuth(); return onAuthStateChanged(auth, setSystemUser); }, []);

            useEffect(() => {
                if (!systemUser) return;
                const prodUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (s) => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const userUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const couponUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), (s) => setCoupons(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const orderUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => setOrders(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date))));
                const setUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), (s) => {
                    if (!s.empty) { const d = s.docs[0].data(); setSettings({ ...defaultSettings, ...d }); setTempSettings({ ...defaultSettings, ...d }); setAboutText(d.aboutUsText || defaultSettings.aboutUsText); } 
                    else { addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), defaultSettings); }
                    setIsLoading(false);
                });
                
                const savedId = localStorage.getItem('nexus_user_id');
                if (savedId && !currentUser) { 
                    getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('__name__', '==', savedId))).then(s => { 
                        if (!s.empty) { const u = {id: s.docs[0].id, ...s.docs[0].data()}; setCurrentUser(u); if (u.favorites) setFavorites(u.favorites); }
                    }); 
                }
                return () => { prodUnsub(); userUnsub(); orderUnsub(); setUnsub(); couponUnsub(); };
            }, [systemUser]);

            useEffect(() => { if (currentUser && orders.length > 0) setUserOrders(orders.filter(o => o.userId === currentUser.id)); }, [currentUser, orders]);

            const isAdmin = (email) => settings.admins && settings.admins.split(',').map(e => e.trim().toLowerCase()).includes(email?.toLowerCase());
            const calculatePrice = (basePrice, discount) => { const markup = Number(basePrice) * (1 + settings.markupPercentage / 100); return discount > 0 ? Math.ceil(markup * (1 - discount / 100)) : Math.ceil(markup); };
            
            // --- AUTH ---
            const performAuth = async (isRegister) => {
                setAuthError(''); setIsLoading(true); setLoadingMessage('VERIFICANDO...');
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    if (isRegister) {
                        if (!registerData.name || !registerData.username || !registerData.email || !registerData.password || !registerData.dni) { setIsLoading(false); return setAuthError("Todos los campos son obligatorios."); }
                        
                        const qEmail = query(usersRef, where("email", "==", registerData.email));
                        const qUser = query(usersRef, where("username", "==", registerData.username));
                        const [snapEmail, snapUser] = await Promise.all([getDocs(qEmail), getDocs(qUser)]);
                        
                        if (!snapEmail.empty) { setIsLoading(false); return setAuthError("El correo ya está registrado."); }
                        if (!snapUser.empty) { setIsLoading(false); return setAuthError("El nombre de usuario ya existe."); }

                        const newUser = { ...registerData, role: 'user', joinDate: new Date().toISOString(), favorites: [] };
                        const ref = await addDoc(usersRef, newUser);
                        
                        const qDni = query(usersRef, where("dni", "==", registerData.dni));
                        const snapDni = await getDocs(qDni);
                        
                        if (snapDni.size <= 1) {
                            const code = `WELCOME-${registerData.username.toUpperCase()}`;
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), { 
                                code, discountPercentage: 7, expirationDate: new Date(Date.now() + 86400000*30).toISOString(), 
                                userEmail: registerData.email, usageLimit: 1, usedBy: [] 
                            });
                            showToast(`¡Bienvenido! Te hemos regalado un cupón: ${code}`, 'success');
                        } else {
                            showToast("Cuenta creada con éxito", 'success');
                        }

                        setCurrentUser({ ...newUser, id: ref.id }); localStorage.setItem('nexus_user_id', ref.id);
                    } else {
                        if (!loginData.identifier || !loginData.password) { setIsLoading(false); return setAuthError("Ingresa usuario/email y contraseña."); }
                        let qLogin = query(usersRef, where("email", "==", loginData.identifier), where("password", "==", loginData.password));
                        let snapLogin = await getDocs(qLogin);
                        if (snapLogin.empty) {
                            qLogin = query(usersRef, where("username", "==", loginData.identifier), where("password", "==", loginData.password));
                            snapLogin = await getDocs(qLogin);
                        }
                        if (!snapLogin.empty) { const u = { id: snapLogin.docs[0].id, ...snapLogin.docs[0].data() }; setCurrentUser(u); localStorage.setItem('nexus_user_id', u.id); if (u.favorites) setFavorites(u.favorites); } else { setIsLoading(false); return setAuthError("Credenciales incorrectas."); }
                    }
                    setView('store'); setAuthError('');
                } catch (e) { setAuthError("Error: " + e.message); }
                setIsLoading(false);
            };

            const onLoginSubmit = (e) => { e.preventDefault(); performAuth(false); };
            const onRegisterSubmit = (e) => { e.preventDefault(); performAuth(true); };
            const handleLogout = () => { localStorage.removeItem('nexus_user_id'); localStorage.removeItem('nexus_cart'); setCurrentUser(null); setView('store'); setCart([]); setFavorites([]); setIsMenuOpen(false); showToast("Sesión cerrada", 'info'); };

            const manageCart = (prod, delta) => {
                const idx = cart.findIndex(i => i.product.id === prod.id);
                if (idx === -1 && delta > 0) { 
                    if (Number(prod.stock) < 1) return showToast("Sin stock disponible", 'error'); 
                    setCart([...cart, { product: prod, quantity: 1 }]); 
                    showToast("Agregado al carrito", 'success');
                } else if (idx !== -1) { 
                    const newCart = [...cart]; newCart[idx].quantity += delta; 
                    if (newCart[idx].quantity <= 0) setCart(cart.filter((_, i) => i !== idx)); 
                    else if (newCart[idx].quantity <= Number(prod.stock)) setCart(newCart); 
                    else showToast("Stock insuficiente para agregar más", 'warning'); 
                }
            };

            const cartSubtotal = cart.reduce((acc, item) => acc + (calculatePrice(item.product.basePrice, item.product.discount) * item.quantity), 0);
            const cartTotal = appliedCoupon ? Math.ceil(cartSubtotal * (1 - appliedCoupon.discountPercentage / 100)) : cartSubtotal;

            const handleConfirmOrder = async () => {
                if (!checkoutData.address || !checkoutData.city || !checkoutData.zipCode || !checkoutData.paymentChoice) return showToast("Por favor completa los datos de envío y pago.", 'warning');
                
                setLoadingMessage('EMAIL'); 
                setIsLoading(true);
                
                try {
                    const newOrder = {
                        orderId: `ORD-${Math.floor(Math.random()*100000)}`,
                        userId: currentUser.id, 
                        customer: { name: currentUser.name, username: currentUser.username, email: currentUser.email, dni: currentUser.dni, phone: currentUser.phone },
                        total: cartTotal, 
                        items: cart.map(i => ({ title: i.product.name, quantity: i.quantity, unit_price: calculatePrice(i.product.basePrice, i.product.discount) })), 
                        date: new Date().toISOString(), displayDate: new Date().toLocaleString(),
                        shippingAddress: `${checkoutData.address}, ${checkoutData.city} (CP: ${checkoutData.zipCode})`,
                        paymentMethod: checkoutData.paymentChoice, 
                        status: 'Pendiente'
                    };
                    
                    // 1. Guardar en Firestore primero
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);

                    // 2. Actualizar stock
                    for (const item of cart) {
                         const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.product.id);
                         const newStock = Math.max(0, item.product.stock - item.quantity);
                         await updateDoc(pRef, { stock: newStock });
                    }

                    // 3. Actualizar cupón si existe
                    if (appliedCoupon) {
                        const cRef = doc(db, 'artifacts', appId, 'public', 'data', 'coupons', appliedCoupon.id);
                        await updateDoc(cRef, { usedBy: [...(appliedCoupon.usedBy || []), currentUser.id] });
                    }

                    // 4. Enviar email (CORREGIDO: Ruta /api/payment y validación de respuesta)
                    const emailResponse = await fetch('/api/payment', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ ...newOrder, shipping: newOrder.shippingAddress }) 
                    });

                    if (!emailResponse.ok) {
                        const errorData = await emailResponse.json();
                        throw new Error(errorData.error || 'Error al enviar el correo');
                    }

                    showToast(`¡Pedido confirmado! Revisa tu correo ${currentUser.email}`, 'success');
                    setCart([]); localStorage.removeItem('nexus_cart'); setView('store');
                } catch (error) { 
                    console.error("Error Order:", error); 
                    showToast(`Error: ${error.message}. El pedido se guardó pero el correo falló.`, 'error');
                }
                setIsLoading(false);
            };

            const validateCoupon = () => {
                if(!checkoutCoupon) return;
                const found = coupons.find(c => c.code.toUpperCase() === checkoutCoupon.toUpperCase());
                if (!found) return showToast("Cupón inválido", 'error');
                if (new Date(found.expirationDate) < new Date()) return showToast("Cupón vencido", 'warning');
                if (found.targetUser && found.targetUser !== currentUser.email) return showToast("Este cupón no es para ti", 'error');
                if (found.usageLimit && found.usedBy && found.usedBy.length >= Number(found.usageLimit)) return showToast("Cupón agotado", 'warning');
                if (found.usedBy && found.usedBy.includes(currentUser.id)) return showToast("Ya usaste este cupón", 'warning');
                setAppliedCoupon(found); showToast("¡Descuento aplicado!", 'success');
            };

            const saveCoupon = async () => {
                if(!newCoupon.code) return showToast("Código requerido", 'warning');
                setIsLoading(true);
                await addDoc(collection(db,'artifacts',appId,'public','data','coupons'), {
                    code: newCoupon.code.toUpperCase(), 
                    discountPercentage: Number(newCoupon.discountPercentage), 
                    expirationDate: newCoupon.expirationDate,
                    targetUser: newCoupon.targetUser || '', 
                    usageLimit: newCoupon.usageLimit || 9999,
                    usedBy: [] 
                });
                setNewCoupon({code:'', discountPercentage:10, expirationDate:'', targetUser: '', usageLimit: ''});
                setIsLoading(false);
                showToast("Cupón creado", 'success');
            };

            const deleteCouponAction = (id) => { 
                confirmAction("Eliminar Cupón", "¿Estás seguro de que quieres eliminar este cupón?", async () => {
                    await deleteDoc(doc(db,'artifacts',appId,'public','data','coupons',id));
                    showToast("Cupón eliminado", 'info');
                });
            };

            const saveProduct = async () => { 
                if(!newProduct.name) return showToast("Faltan datos del producto", 'warning'); 
                setIsLoading(true); 
                const pData={...newProduct, basePrice:Number(newProduct.basePrice), stock:Number(newProduct.stock), discount:Number(newProduct.discount||0), image:newProduct.image||'https://via.placeholder.com/150'}; 
                if(editingId) await updateDoc(doc(db,'artifacts',appId,'public','data','products',editingId), pData); 
                else await addDoc(collection(db,'artifacts',appId,'public','data','products'), pData); 
                setNewProduct({name:'',basePrice:'',category:'',image:'',description:'',stock:'',discount:0}); setEditingId(null); 
                if(fileInputRef.current) fileInputRef.current.value = "";
                setIsLoading(false); 
                showToast(editingId ? "Producto actualizado" : "Producto creado", 'success');
            };
            
            const deleteProd = async () => { 
                if(!productToDelete) return; 
                await deleteDoc(doc(db,'artifacts',appId,'public','data','products',productToDelete.id)); 
                setProductToDelete(null); 
                setIsLoading(false);
                showToast("Producto eliminado", 'info');
            };
            
            const handleImage = (e) => { const f=e.target.files[0]; if(f&&f.size<1000000){const r=new FileReader();r.onload=()=>setNewProduct(p=>({...p,image:r.result}));r.readAsDataURL(f);}else showToast("La imagen es muy pesada (Max 1MB)", 'error'); };
            const saveSettings = async () => { setIsLoading(true); const q=query(collection(db,'artifacts',appId,'public','data','settings')); const s=await getDocs(q); const d={...tempSettings, aboutUsText: aboutText}; if(!s.empty) await updateDoc(doc(db,'artifacts',appId,'public','data','settings',s.docs[0].id), d); else await addDoc(collection(db,'artifacts',appId,'public','data','settings'), d); showToast("Configuración guardada", 'success'); setIsLoading(false); };
            const handleEditProduct = (p) => { setNewProduct({...p, basePrice: p.basePrice}); setEditingId(p.id); window.scrollTo({top:0, behavior:'smooth'}); };
            const initiateDelete = (p) => confirmAction("Eliminar Producto", `¿Eliminar ${p.name}?`, async () => {
                await deleteDoc(doc(db,'artifacts',appId,'public','data','products',p.id));
                showToast("Producto eliminado", 'info');
            });
            const handleCancelEdit = () => { setNewProduct({name:'',basePrice:'',category:'',image:'',description:'',stock:'',discount:0}); setEditingId(null); if(fileInputRef.current) fileInputRef.current.value=""; };
            const addCategory = () => { if(newCategory && !tempSettings.categories.includes(newCategory)) { setTempSettings({...tempSettings, categories:[...tempSettings.categories, newCategory]}); setNewCategory(''); } };
            const removeCategory = (c) => setTempSettings({...tempSettings, categories: tempSettings.categories.filter(x => x!==c)});
            
            const toggleOrder = async (o) => {
                const newStatus = o.status === 'Pendiente' ? 'Realizado' : 'Pendiente';
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', o.id), { status: newStatus });
                showToast(`Orden actualizada a: ${newStatus}`, 'info');
            };
            const addAdmin = () => {
                if(!newAdminEmail) return;
                const current = settings.admins || "";
                setTempSettings({...tempSettings, admins: current + "," + newAdminEmail });
                setNewAdminEmail('');
            };

            const toggleFavorite = async (pid) => { 
                let n; 
                let isAdding = !favorites.includes(pid);
                if(favorites.includes(pid)) n=favorites.filter(id=>id!==pid); else n=[...favorites, pid]; 
                setFavorites(n); 
                if(currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), {favorites:n}); 
                else localStorage.setItem('nexus_favs', JSON.stringify(n)); 
                showToast(isAdding ? "Añadido a favoritos" : "Eliminado de favoritos", 'info');
            };
            const goIg = () => window.open(`https://www.instagram.com/${settings.instagramUser}/`, '_blank');
            const goWsp = () => window.open(settings.whatsappLink, '_blank');
            const handleLogoUpload = (e) => { const f=e.target.files[0]; if(f){const r=new FileReader();r.onload=()=>setTempSettings(p=>({...p,logoUrl:r.result}));r.readAsDataURL(f);} };
            
            const handleEditUser = (user) => setEditingUser({ ...user });
            const saveUserEdit = async () => { 
                if (!editingUser) return; setIsLoading(true); 
                try { 
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUser.id), { 
                        name: editingUser.name, username: editingUser.username, email: editingUser.email, dni: editingUser.dni, phone: editingUser.phone, password: editingUser.password 
                    }); 
                    showToast("Usuario actualizado", 'success'); setEditingUser(null); 
                } catch (e) { showToast("Error: " + e.message, 'error'); } 
                setIsLoading(false); 
            };

            const handleRecoverYes = () => { if (!pendingOrderRecover) return; setCart(pendingOrderRecover.items); setView('checkout'); setPendingOrderRecover(null); };
            const handleRecoverNo = async () => { if (!pendingOrderRecover) return; setIsLoading(true); try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingOrderRecover.id)); setPendingOrderRecover(null); showToast("Orden pendiente descartada", 'info'); } catch(err) { showToast("Error: " + err.message, 'error'); } setIsLoading(false); };
            const closeRecoveryModal = () => { setPendingOrderRecover(null); };

            return (
                <div className="min-h-screen bg-[#020617] text-slate-100 font-sans flex flex-col relative overflow-hidden">
                    {/* CONTAINER DE TOASTS (NOTIFICACIONES) */}
                    <div className="fixed top-20 right-4 z-[300] flex flex-col items-end pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className="pointer-events-auto">
                                <Toast message={t.message} type={t.type} onClose={() => removeToast(t.id)} />
                            </div>
                        ))}
                    </div>

                    {/* MODAL CONFIRMACION CUSTOM */}
                    <ConfirmModal 
                        isOpen={modalConfig.isOpen} 
                        title={modalConfig.title} 
                        message={modalConfig.message} 
                        onConfirm={modalConfig.onConfirm} 
                        onCancel={() => setModalConfig({ ...modalConfig, isOpen: false })} 
                    />

                    {isLoading && <Loading message={loadingMessage} />}

                    <header className="fixed top-0 w-full z-40 glass-panel h-16 flex items-center justify-between px-4 lg:px-8 shadow-lg">
                        <div className="flex items-center gap-4 flex-1">
                            <div onClick={() => setView('store')} className="cursor-pointer font-bold text-2xl tracking-tighter text-cyan-400">SUSTORE</div>
                            <div className="hidden md:flex items-center bg-slate-800/50 border border-slate-700 rounded-full px-4 py-2 w-full max-w-md"><Search className="w-4 h-4 mr-2 text-slate-400" /><input className="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-400" placeholder="Buscar..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/></div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={goWsp} className="text-green-400 hover:scale-110 transition"><MessageCircle className="w-6 h-6"/></button>
                            <button onClick={goIg} className="text-pink-400 hover:scale-110 transition"><Instagram className="w-6 h-6"/></button>
                            <button onClick={() => setView('favorites')} className="text-slate-400 hover:text-red-400 transition"><Heart className={`w-6 h-6 ${favorites.length > 0 ? 'fill-red-500 text-red-500' : ''}`} /></button>
                            <button onClick={() => setView('cart')} className="relative text-slate-300 hover:text-cyan-400 transition"><ShoppingBag className="w-6 h-6" />{cart.length > 0 && <span className="absolute -top-1 -right-1 bg-cyan-500 text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center border border-slate-900 shadow-lg">{cart.length}</span>}</button>
                            {currentUser ? <div onClick={() => setView('profile')} className="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold text-xs cursor-pointer hover:bg-cyan-500 border border-cyan-400/30">{(currentUser.username || "U")[0].toUpperCase()}</div> : <button onClick={() => setView('login')} className="text-slate-300 hover:text-white"><User className="w-6 h-6"/></button>}
                            <button onClick={() => setIsMenuOpen(true)} className="text-slate-300 hover:text-white ml-2"><Menu className="w-7 h-7" /></button>
                        </div>
                    </header>
                    <div className="h-16"></div>

                    <main className="flex-grow p-4">
                        {/* ALERT RECUPERACIÓN */}
                        {pendingOrderRecover && (
                            <div className="fixed inset-0 z-[120] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-up">
                                <div className="bg-slate-800 border border-yellow-500/50 p-6 rounded-2xl shadow-2xl max-w-md w-full text-center relative overflow-hidden">
                                    <button onClick={closeRecoveryModal} className="absolute top-2 right-2 text-slate-400 hover:text-white"><X className="w-5 h-5"/></button>
                                    <AlertTriangle className="w-12 h-12 text-yellow-500 mx-auto mb-4 animate-bounce"/>
                                    <h3 className="text-xl font-bold text-white mb-2">¡Pedido Pendiente!</h3>
                                    <p className="text-slate-400 mb-6 text-sm">Tienes un pedido de <strong>${pendingOrderRecover.total.toLocaleString()}</strong> sin confirmar.</p>
                                    <div className="flex gap-3">
                                        <button onClick={handleRecoverNo} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-xl font-bold transition">Cancelar</button>
                                        <button onClick={handleRecoverYes} className="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold transition">Continuar</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STORE */}
                        {view === 'store' && (
                             <div className="animate-fade-up max-w-7xl mx-auto">
                                 {/* FILTROS DE CATEGORIA */}
                                 <div className="flex gap-2 overflow-x-auto pb-4 mb-4">
                                     <button onClick={() => setSelectedCategory('')} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${selectedCategory === '' ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'}`}>Todos</button>
                                     {settings.categories.map(cat => (
                                         <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${selectedCategory === cat ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400'}`}>{cat}</button>
                                     ))}
                                 </div>

                                 <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                     {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) && (selectedCategory === '' || p.category === selectedCategory)).map(p => (
                                         <div key={p.id} className="bg-slate-900 rounded-2xl overflow-hidden border border-slate-800 hover:border-cyan-500/50 transition group">
                                             <div className="h-48 overflow-hidden relative">
                                                 <img src={p.image} className="w-full h-full object-cover"/>
                                                 <button onClick={() => toggleFavorite(p.id)} className="absolute top-2 right-2 p-2 bg-black/50 rounded-full text-white hover:text-red-500"><Heart className={`w-4 h-4 ${favorites.includes(p.id) ? 'fill-red-500 text-red-500' : ''}`}/></button>
                                             </div>
                                             <div className="p-4">
                                                 <p className="text-xs text-cyan-400 font-bold uppercase mb-1">{p.category}</p>
                                                 <h3 className="font-bold text-white text-lg mb-2 truncate">{p.name}</h3>
                                                 <div className="flex justify-between items-center">
                                                     <span className="text-xl font-bold text-white">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</span>
                                                     <button onClick={() => manageCart(p, 1)} className="bg-white text-slate-900 p-2 rounded-lg hover:bg-cyan-400 transition"><Plus className="w-4 h-4"/></button>
                                                 </div>
                                             </div>
                                         </div>
                                     ))}
                                 </div>
                             </div>
                        )}

                        {/* CART VIEW */}
                        {view === 'cart' && (
                            <div className="max-w-4xl mx-auto animate-fade-up">
                                <h2 className="text-2xl font-bold mb-6 text-white flex items-center gap-2">
                                    <ShoppingBag className="text-cyan-400"/> Tu Carrito
                                </h2>
                                {cart.length === 0 ? (
                                    <div className="text-center py-20 bg-slate-800/50 rounded-3xl border border-slate-700 border-dashed">
                                        <ShoppingBag className="w-16 h-16 text-slate-600 mx-auto mb-4"/>
                                        <p className="text-slate-400 text-lg mb-6">Tu carrito está vacío</p>
                                        <button onClick={() => setView('store')} className="bg-cyan-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-cyan-500 transition">
                                            Ir a la Tienda
                                        </button>
                                    </div>
                                ) : (
                                    <div className="grid gap-8 lg:grid-cols-3">
                                        <div className="lg:col-span-2 space-y-4">
                                            {cart.map((item) => (
                                                <div key={item.product.id} className="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex gap-4 items-center">
                                                    <img src={item.product.image} className="w-20 h-20 rounded-xl object-cover bg-slate-900"/>
                                                    <div className="flex-1 min-w-0">
                                                        <h3 className="font-bold text-white truncate">{item.product.name}</h3>
                                                        <p className="text-cyan-400 font-bold">${calculatePrice(item.product.basePrice, item.product.discount).toLocaleString()}</p>
                                                    </div>
                                                    <div className="flex items-center gap-3 bg-slate-900 rounded-lg p-1">
                                                        <button onClick={() => manageCart(item.product, -1)} className="p-2 hover:text-cyan-400"><Minus className="w-4 h-4"/></button>
                                                        <span className="font-bold w-4 text-center text-sm">{item.quantity}</span>
                                                        <button onClick={() => manageCart(item.product, 1)} className="p-2 hover:text-cyan-400"><Plus className="w-4 h-4"/></button>
                                                    </div>
                                                    <button onClick={() => manageCart(item.product, -item.quantity)} className="p-2 text-red-400 hover:bg-slate-900 rounded-lg"><Trash2 className="w-5 h-5"/></button>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 h-fit">
                                            <h3 className="font-bold text-white mb-4 text-lg">Resumen</h3>
                                            <div className="flex justify-between text-slate-300 mb-2">
                                                <span>Subtotal</span>
                                                <span>${cartSubtotal.toLocaleString()}</span>
                                            </div>
                                            <div className="border-t border-slate-700 mt-4 pt-4 flex justify-between font-bold text-xl text-white mb-6">
                                                <span>Total</span>
                                                <span>${cartTotal.toLocaleString()}</span>
                                            </div>
                                            <button onClick={() => setView('checkout')} className="w-full bg-cyan-600 py-4 rounded-xl font-bold text-white hover:bg-cyan-500 shadow-lg shadow-cyan-500/20 transition mb-3 flex items-center justify-center gap-2">
                                                Finalizar Compra <ArrowRight className="w-4 h-4"/>
                                            </button>
                                            <button onClick={() => setView('store')} className="w-full py-3 text-slate-400 hover:text-white transition text-sm">
                                                Seguir Mirando
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* CHECKOUT */}
                        {view === 'checkout' && (
                            <div className="max-w-md mx-auto animate-fade-up">
                                <div className="flex items-center gap-2 mb-6">
                                    <button onClick={() => setView('cart')} className="p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-white"><ArrowLeft className="w-5 h-5"/></button>
                                    <h2 className="text-2xl font-bold text-white">Confirmar Pedido</h2>
                                </div>
                                
                                <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 mb-6 relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-blue-500"></div>
                                    <h3 className="font-bold mb-4 text-slate-300 text-sm uppercase flex items-center gap-2"><ShoppingBag className="w-4 h-4"/> Resumen</h3>
                                    {cart.map((item, i) => (
                                        <div key={i} className="flex justify-between text-sm mb-2 pb-2 border-b border-slate-700/50 last:border-0 last:mb-0 last:pb-0">
                                            <span className="text-slate-300">{item.quantity}x {item.product.name}</span>
                                            <span className="font-bold text-white">${(calculatePrice(item.product.basePrice, item.product.discount) * item.quantity).toLocaleString()}</span>
                                        </div>
                                    ))}
                                    <div className="border-t border-slate-700 mt-4 pt-4 flex justify-between font-bold text-lg text-white">
                                        <span>Total Final</span>
                                        <span className="text-cyan-400 text-2xl">${cartTotal.toLocaleString()}</span>
                                    </div>
                                    {appliedCoupon && <div className="text-xs text-green-400 text-right mt-1">Cupón {appliedCoupon.code} aplicado ({appliedCoupon.discountPercentage}%)</div>}
                                </div>
                                
                                <div className="flex gap-2 mb-4">
                                    <input className="flex-1 input-dark p-3 uppercase" placeholder="CÓDIGO CUPÓN" value={checkoutCoupon} onChange={e => setCheckoutCoupon(e.target.value)}/>
                                    <button onClick={validateCoupon} className="bg-purple-600 hover:bg-purple-500 text-white px-4 rounded-xl font-bold text-xs transition"><Tag className="w-4 h-4"/></button>
                                </div>

                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => setCheckoutData({...checkoutData, paymentChoice: 'Transferencia'})} className={`p-3 rounded-xl border transition flex flex-col items-center gap-2 ${checkoutData.paymentChoice === 'Transferencia' ? 'border-cyan-500 bg-cyan-900/20 text-white' : 'border-slate-700 text-slate-400 hover:bg-slate-800'}`}>
                                            <RefreshCw className="w-6 h-6"/> <span className="text-xs font-bold">Transferencia</span>
                                        </button>
                                        <button onClick={() => setCheckoutData({...checkoutData, paymentChoice: 'Efectivo'})} className={`p-3 rounded-xl border transition flex flex-col items-center gap-2 ${checkoutData.paymentChoice === 'Efectivo' ? 'border-cyan-500 bg-cyan-900/20 text-white' : 'border-slate-700 text-slate-400 hover:bg-slate-800'}`}>
                                            <Zap className="w-6 h-6"/> <span className="text-xs font-bold">Efectivo</span>
                                        </button>
                                    </div>
                                    <input className="w-full input-dark p-3" placeholder="Dirección de Envío" value={checkoutData.address} onChange={e => setCheckoutData({...checkoutData, address: e.target.value})}/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="w-full input-dark p-3" placeholder="Ciudad" value={checkoutData.city} onChange={e => setCheckoutData({...checkoutData, city: e.target.value})}/>
                                        <input className="w-full input-dark p-3" placeholder="CP" value={checkoutData.zipCode} onChange={e => setCheckoutData({...checkoutData, zipCode: e.target.value})}/>
                                    </div>
                                    <button onClick={handleConfirmOrder} className="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-lg mt-4 flex items-center justify-center gap-2">
                                        <CheckCircle className="w-5 h-5"/> CONFIRMAR PEDIDO
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* LOGIN / REGISTER */}
                        {(view === 'login' || view === 'register') && (
                            <div className="flex items-center justify-center min-h-[80vh] animate-fade-up">
                                <div className="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-700">
                                    <h2 className="text-2xl font-bold text-center text-white mb-6">{view === 'login' ? 'Acceder' : 'Crear Cuenta'}</h2>
                                    {authError && <div className="bg-red-500/20 text-red-200 p-3 rounded-lg mb-4 text-sm text-center">{authError}</div>}
                                    
                                    <form onSubmit={view === 'login' ? onLoginSubmit : onRegisterSubmit} className="space-y-4">
                                        {view === 'register' && (
                                            <>
                                                <input className="w-full input-dark p-3" placeholder="Nombre Real" value={registerData.name} onChange={e => setRegisterData({...registerData, name: e.target.value})} required/>
                                                <input className="w-full input-dark p-3" placeholder="Nombre de Usuario" value={registerData.username} onChange={e => setRegisterData({...registerData, username: e.target.value})} required/>
                                                <input className="w-full input-dark p-3" placeholder="DNI" value={registerData.dni} onChange={e => setRegisterData({...registerData, dni: e.target.value})} required/>
                                                <input className="w-full input-dark p-3" placeholder="Teléfono" value={registerData.phone} onChange={e => setRegisterData({...registerData, phone: e.target.value})} required/>
                                            </>
                                        )}
                                        {view === 'login' ? (
                                            <input className="w-full input-dark p-3" placeholder="Email o Usuario" value={loginData.identifier} onChange={e => setLoginData({...loginData, identifier: e.target.value})} required/>
                                        ) : (
                                            <input className="w-full input-dark p-3" placeholder="Email" type="email" value={registerData.email} onChange={e => setRegisterData({...registerData, email: e.target.value})} required/>
                                        )}
                                        <input className="w-full input-dark p-3" type="password" placeholder="Contraseña" value={view === 'login' ? loginData.password : registerData.password} onChange={e => view === 'login' ? setLoginData({...loginData, password: e.target.value}) : setRegisterData({...registerData, password: e.target.value})} required/>
                                        <button className="w-full bg-cyan-600 text-white py-3 rounded-xl font-bold hover:bg-cyan-500 transition">{view === 'login' ? 'ENTRAR' : 'REGISTRARSE'}</button>
                                    </form>
                                    <button onClick={() => setView(view === 'login' ? 'register' : 'login')} className="w-full text-center text-slate-400 text-sm mt-4 hover:text-white">
                                        {view === 'login' ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Ingresa'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* ADMIN PANEL */}
                        {view === 'admin' && isAdmin(currentUser?.email) && (
                            <div className="max-w-4xl mx-auto animate-fade-up">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-bold text-white">Panel de Administración</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setView('store')} className="bg-slate-700 px-4 py-2 rounded-lg text-sm">Salir</button>
                                    </div>
                                </div>

                                <div className="grid gap-6 lg:grid-cols-2">
                                    {/* SETTINGS */}
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                        <h3 className="font-bold text-white mb-4">Configuración General</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">Categorías</label>
                                                <div className="flex flex-wrap gap-2 mb-2">
                                                    {settings.categories.map(cat => (
                                                        <span key={cat} className="bg-slate-900 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-slate-700">
                                                            {cat} <button onClick={() => removeCategory(cat)} className="text-red-400 hover:text-white"><X className="w-3 h-3"/></button>
                                                        </span>
                                                    ))}
                                                </div>
                                                <div className="flex gap-2">
                                                    <input className="flex-1 input-dark p-2 text-sm" placeholder="Nueva categoría..." value={newCategory} onChange={e => setNewCategory(e.target.value)}/>
                                                    <button onClick={addCategory} className="bg-green-600 px-4 rounded-lg"><Plus className="w-4 h-4 text-white"/></button>
                                                </div>
                                            </div>
                                            
                                            <div className="border-t border-slate-700 pt-4">
                                                <label className="text-xs text-slate-400 block mb-1">Agregar Admin (Email)</label>
                                                <div className="flex gap-2">
                                                    <input className="flex-1 input-dark p-2 text-sm" placeholder="email@admin.com" value={newAdminEmail} onChange={e => setNewAdminEmail(e.target.value)}/>
                                                    <button onClick={addAdmin} className="bg-purple-600 px-4 rounded-lg"><UserPlus className="w-4 h-4 text-white"/></button>
                                                </div>
                                            </div>

                                            <button onClick={saveSettings} className="w-full bg-cyan-600 py-2 rounded-lg font-bold text-sm">Guardar Configuración</button>
                                        </div>
                                    </div>

                                    {/* PEDIDOS */}
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 max-h-96 overflow-y-auto">
                                        <h3 className="font-bold text-white mb-4">Gestión de Pedidos</h3>
                                        <div className="space-y-3">
                                            {orders.map(o => (
                                                <div key={o.id} className="bg-slate-900 p-3 rounded-lg border border-slate-700 text-sm">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="font-bold text-cyan-400">{o.orderId}</span>
                                                        <span className="text-slate-500 text-xs">{new Date(o.date).toLocaleDateString()}</span>
                                                    </div>
                                                    <p className="text-white mb-1">{o.customer?.name} ({o.userEmail})</p>
                                                    <div className="flex justify-between items-center mt-2">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${o.status === 'Realizado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>{o.status}</span>
                                                        <button onClick={() => toggleOrder(o)} className="text-xs bg-slate-700 px-3 py-1 rounded hover:bg-slate-600">{o.status === 'Pendiente' ? 'Marcar Realizado' : 'Marcar Pendiente'}</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* PRODUCTS */}
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700 lg:col-span-2">
                                        <h3 className="font-bold text-white mb-4">Productos</h3>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <input className="input-dark p-2" placeholder="Nombre" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})}/>
                                            <input className="input-dark p-2" type="number" placeholder="Precio Base" value={newProduct.basePrice} onChange={e => setNewProduct({...newProduct, basePrice: e.target.value})}/>
                                            <input className="input-dark p-2" type="number" placeholder="Stock" value={newProduct.stock} onChange={e => setNewProduct({...newProduct, stock: e.target.value})}/>
                                            <select className="input-dark p-2" value={newProduct.category} onChange={e => setNewProduct({...newProduct, category: e.target.value})}>
                                                <option value="">Categoría...</option>
                                                {settings.categories.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                            <input className="input-dark p-2 col-span-2" type="file" ref={fileInputRef} onChange={handleImage}/>
                                        </div>
                                        <button onClick={saveProduct} className="w-full bg-green-600 py-2 rounded-lg font-bold text-sm mb-4">{editingId ? 'Actualizar' : 'Crear'} Producto</button>
                                        
                                        <div className="space-y-2 max-h-60 overflow-y-auto">
                                            {products.map(p => (
                                                <div key={p.id} className="flex justify-between items-center bg-slate-900 p-3 rounded-lg border border-slate-700">
                                                    <div className="flex items-center gap-3">
                                                        <img src={p.image} className="w-10 h-10 rounded object-cover"/>
                                                        <span className="text-sm font-bold">{p.name}</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleEditProduct(p)} className="text-blue-400 p-2 hover:bg-slate-800 rounded"><Edit className="w-4 h-4"/></button>
                                                        <button onClick={() => initiateDelete(p)} className="text-red-400 p-2 hover:bg-slate-800 rounded"><Trash2 className="w-4 h-4"/></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* COUPONS & USERS */}
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                        <h3 className="font-bold text-white mb-4">Cupones</h3>
                                        <div className="flex flex-col gap-2 mb-4">
                                            <input className="input-dark p-2" placeholder="CÓDIGO" value={newCoupon.code} onChange={e => setNewCoupon({...newCoupon, code: e.target.value.toUpperCase()})}/>
                                            <div className="flex gap-2">
                                                <input className="input-dark p-2 w-1/2" type="number" placeholder="%" value={newCoupon.discountPercentage} onChange={e => setNewCoupon({...newCoupon, discountPercentage: e.target.value})}/>
                                                <input className="input-dark p-2 w-1/2" type="number" placeholder="Límite Usos" value={newCoupon.usageLimit} onChange={e => setNewCoupon({...newCoupon, usageLimit: e.target.value})}/>
                                            </div>
                                            <input className="input-dark p-2" placeholder="Email Objetivo (Opcional)" value={newCoupon.targetUser} onChange={e => setNewCoupon({...newCoupon, targetUser: e.target.value})}/>
                                            <input className="input-dark p-2" type="date" value={newCoupon.expirationDate} onChange={e => setNewCoupon({...newCoupon, expirationDate: e.target.value})}/>
                                            <button onClick={saveCoupon} className="bg-yellow-600 py-2 rounded-lg font-bold text-sm">Crear Cupón</button>
                                        </div>
                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                            {coupons.map(c => (
                                                <div key={c.id} className="flex justify-between bg-slate-900 p-2 rounded text-xs px-3 border border-slate-700">
                                                    <div>
                                                        <span className="text-yellow-400 font-bold">{c.code}</span>
                                                        <span className="text-slate-400 ml-2">({c.discountPercentage}%)</span>
                                                        <div className="text-[10px] text-slate-500">{c.targetUser ? `Para: ${c.targetUser}` : 'Global'} | Usos: {c.usedBy?.length || 0}/{c.usageLimit || '∞'}</div>
                                                    </div>
                                                    <button onClick={() => deleteCouponAction(c.id)} className="text-red-400"><Trash2 className="w-3 h-3"/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* USERS EDIT */}
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                        <h3 className="font-bold text-white mb-4">Editar Usuarios</h3>
                                        <div className="space-y-2 max-h-60 overflow-y-auto">
                                            {users.map(u => (
                                                <div key={u.id} className="flex justify-between items-center bg-slate-900 p-3 rounded border border-slate-700">
                                                    <div className="overflow-hidden">
                                                        <p className="text-sm font-bold text-white truncate">{u.name}</p>
                                                        <p className="text-xs text-slate-500 truncate">{u.email}</p>
                                                    </div>
                                                    <button onClick={() => handleEditUser(u)} className="bg-blue-900/30 text-blue-400 p-2 rounded hover:bg-blue-900/50"><Edit className="w-4 h-4"/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* EDIT USER MODAL */}
                                {editingUser && (
                                    <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                                        <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-full max-w-md">
                                            <h3 className="text-xl font-bold text-white mb-4">Editar Usuario: {editingUser.username}</h3>
                                            <div className="space-y-3">
                                                <input className="w-full input-dark p-3" value={editingUser.name} onChange={e => setEditingUser({...editingUser, name: e.target.value})} placeholder="Nombre Real"/>
                                                <input className="w-full input-dark p-3" value={editingUser.username} onChange={e => setEditingUser({...editingUser, username: e.target.value})} placeholder="Usuario"/>
                                                <input className="w-full input-dark p-3" value={editingUser.email} onChange={e => setEditingUser({...editingUser, email: e.target.value})} placeholder="Email"/>
                                                <input className="w-full input-dark p-3" value={editingUser.dni} onChange={e => setEditingUser({...editingUser, dni: e.target.value})} placeholder="DNI"/>
                                                <input className="w-full input-dark p-3" value={editingUser.phone} onChange={e => setEditingUser({...editingUser, phone: e.target.value})} placeholder="Teléfono"/>
                                                <input className="w-full input-dark p-3" value={editingUser.password} onChange={e => setEditingUser({...editingUser, password: e.target.value})} placeholder="Contraseña"/>
                                            </div>
                                            <div className="flex gap-2 mt-6"><button onClick={() => setEditingUser(null)} className="flex-1 py-2 bg-slate-800 text-slate-300 rounded-lg">Cancelar</button><button onClick={saveUserEdit} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Guardar</button></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* VIEW: SOBRE NOSOTROS */}
                        {view === 'about' && (
                            <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-3xl font-bold mb-6 text-white flex items-center gap-3"><Info className="text-cyan-400"/> Sobre Nosotros</h2>
                                <div className="bg-slate-800 p-8 rounded-3xl border border-cyan-500/20 shadow-2xl">
                                    <p className="text-slate-300 text-lg leading-relaxed whitespace-pre-wrap">{settings.aboutUsText}</p>
                                </div>
                            </div>
                        )}

                        {/* VIEW: FAVORITOS */}
                        {view === 'favorites' && (
                            <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-2xl font-bold text-white mb-8 flex items-center gap-2"><Heart className="text-red-500 fill-red-500"/> Mis Favoritos</h2>
                                {favorites.length === 0 ? (
                                    <p className="text-slate-500 text-center py-10 border border-dashed border-slate-700 rounded-xl">No tienes productos en favoritos.</p>
                                ) : (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {products.filter(p => favorites.includes(p.id)).map(p => (
                                            <div key={p.id} className="bg-slate-800 rounded-2xl overflow-hidden shadow-lg border border-slate-700/50 relative">
                                                <div className="h-48 overflow-hidden relative bg-slate-900">
                                                    <img src={p.image} className="w-full h-full object-cover"/>
                                                    <button onClick={() => toggleFavorite(p.id)} className="absolute top-2 right-2 p-2 bg-black/50 rounded-full text-red-500 hover:bg-white hover:text-red-600 transition"><X className="w-4 h-4"/></button>
                                                </div>
                                                <div className="p-4">
                                                    <h3 className="font-bold text-white truncate">{p.name}</h3>
                                                    <p className="text-cyan-400 font-bold mt-1">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</p>
                                                    <button onClick={() => manageCart(p, 1)} className="w-full mt-3 bg-slate-700 text-white py-2 rounded-lg hover:bg-cyan-600 transition text-sm font-bold">Agregar al Carrito</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* PROFILE */}
                        {view === 'profile' && currentUser && (
                            <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up">
                                <h2 className="text-3xl font-bold text-white mb-8">Mi Perfil</h2>
                                <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 mb-8">
                                    <p className="text-xl text-white font-bold">{currentUser.name}</p>
                                    <p className="text-slate-400">{currentUser.email}</p>
                                    <button onClick={handleLogout} className="mt-4 text-red-400 border border-red-500/30 px-4 py-2 rounded hover:bg-red-500/10">Cerrar Sesión</button>
                                </div>
                                
                                <h3 className="text-xl font-bold text-white mb-4">Mis Cupones</h3>
                                <div className="grid sm:grid-cols-2 gap-4 mb-8">
                                    {coupons.filter(c => (c.userEmail === currentUser.email) && !c.usedBy.includes(currentUser.id)).map(c => (
                                        <div key={c.id} className="bg-slate-900 border border-yellow-500/30 p-4 rounded-xl flex justify-between items-center cursor-pointer hover:bg-slate-800 transition" onClick={() => {navigator.clipboard.writeText(c.code); showToast("Cupón copiado al portapapeles", 'success');}}>
                                            <div><p className="font-bold text-yellow-400 text-lg">{c.code}</p><p className="text-[10px] text-slate-500 uppercase">Vence: {new Date(c.expirationDate).toLocaleDateString()}</p></div>
                                            <span className="text-2xl font-black text-white">{c.discountPercentage}%</span>
                                        </div>
                                    ))}
                                </div>

                                <h3 className="text-xl font-bold text-white mb-4">Historial de Compras</h3>
                                <div className="space-y-4">
                                {userOrders.map(o => (
                                    <div key={o.orderId} className="bg-slate-900 p-6 rounded-2xl border border-slate-800 hover:border-slate-700 transition">
                                        <div className="flex justify-between items-center mb-4 border-b border-slate-800 pb-4">
                                            <div><span className="bg-slate-800 text-white text-xs px-2 py-1 rounded mr-2 font-mono">#{o.orderId}</span><span className="text-xs text-slate-400">{o.displayDate}</span></div>
                                            <span className={`text-xs px-3 py-1 rounded-full font-bold ${o.status === 'Realizado' ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'}`}>{o.status}</span>
                                        </div>
                                        <div className="text-right border-t border-slate-800 pt-3"><p className="text-lg font-black text-white">Total: ${o.total.toLocaleString()}</p></div>
                                    </div>
                                ))}
                                </div>
                            </div>
                        )}

                    </main>

                    {/* MENÚ FLOTANTE */}
                    <div className={`fixed top-0 left-0 h-full w-64 bg-slate-900/95 backdrop-blur-xl border-r border-slate-700 transform transition-transform duration-300 z-50 ${isMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 flex justify-between items-center border-b border-slate-700">
                            <span className="font-bold text-lg text-cyan-400">MENÚ</span>
                            <button onClick={() => setIsMenuOpen(false)}><X className="text-slate-400 hover:text-white"/></button>
                        </div>
                        <div className="p-4 space-y-4">
                            <button onClick={() => { setView('store'); setIsMenuOpen(false); }} className="w-full text-left flex gap-3 text-slate-300 hover:text-white"><Home className="w-5 h-5"/> Inicio</button>
                            <button onClick={() => { setView('profile'); setIsMenuOpen(false); }} className="w-full text-left flex gap-3 text-slate-300 hover:text-white"><User className="w-5 h-5"/> Mi Perfil</button>
                            <button onClick={() => { setView('about'); setIsMenuOpen(false); }} className="w-full text-left flex gap-3 text-slate-300 hover:text-white"><Info className="w-5 h-5"/> Sobre Nosotros</button>
                            {currentUser && isAdmin(currentUser.email) && <button onClick={() => { setView('admin'); setIsMenuOpen(false); }} className="w-full text-left flex gap-3 text-purple-400 font-bold"><Shield className="w-5 h-5"/> Admin</button>}
                            {currentUser && <button onClick={handleLogout} className="w-full text-left flex gap-3 text-red-400 mt-8 pt-8 border-t border-slate-700"><LogOut className="w-5 h-5"/> Cerrar Sesión</button>}
                        </div>
                    </div>
                    {isMenuOpen && <div className="fixed inset-0 bg-black/50 z-40 backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}></div>}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
