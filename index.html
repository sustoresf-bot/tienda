<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustore - Next Level Technology</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
    "@google/genai": "https://esm.sh/@google/genai@0.1.2",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/",
    "mercadopago": "https://aistudiocdn.com/mercadopago@^2.11.0"
  }
}
</script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .animate-fade-up { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .deposit-card { background: white; color: #111827; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ShoppingBag, X, User, Search, Zap, CheckCircle, 
          MessageCircle, Send, Instagram, Minus, ArrowRight, 
          FileText, Menu, Home, Info, Heart, Settings, 
          Tag, Plus, Trash2, Edit, XCircle, AlertOctagon,
          AlertCircle, AlertTriangle, RefreshCw, Brain, 
          Share2, BarChart, Ticket, Percent, Gift, Grid
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, getDocs, deleteDoc, where } from 'firebase/firestore';
        import { GoogleGenAI } from "@google/genai";

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAfllte-D_I3h3TwBaiSL4KVfWrCSVh9ro",
          authDomain: "sustore-63266.firebaseapp.com",
          projectId: "sustore-63266",
          storageBucket: "sustore-63266.firebasestorage.app",
          messagingSenderId: "684651914850",
          appId: "1:684651914850:web:f3df09e5caf6e50e9e533b",
          measurementId: "G-X3K7XGYPRD"
        };

        // Inicializar Servicios
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "sustore-prod-v1";
        
        // Inicializar Gemini AI (Reemplaza la API KEY aqu√≠ si es necesario, 
        // aunque idealmente usa variables de entorno en Vercel)
        // Nota: En este HTML directo, process.env no existe nativamente, 
        // as√≠ que aseg√∫rate de que tu clave est√© configurada o sea p√∫blica (con restricciones)
        const ai = new GoogleGenAI({ apiKey: "" }); // Pon tu API Key aqu√≠ si 'process.env' falla en local

        const SustoreLogo = () => (
            <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg overflow-hidden border-2 border-cyan-500">
                <svg viewBox="0 0 100 100" className="w-6 h-6" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 30 H60 M20 50 H80 M20 70 H50" stroke="#0F172A" strokeWidth="8" strokeLinecap="round"/>
                </svg>
            </div>
        );

        const defaultSettings = {
            storeName: "SUSTORE",
            primaryColor: "#06b6d4",
            currency: "$",
            mpLink: "", 
            admins: "lautarocorazza63@gmail.com",
            sellerEmail: "sustoresf@gmail.com",
            instagramUser: "sustore_sf",
            whatsappLink: "https://wa.me/message/3MU36VTEKINKP1",
            logoUrl: "",
            heroUrl: "",
            markupPercentage: 6.50,
            categories: ["Celulares", "Accesorios", "Audio", "Computaci√≥n", "Gaming"],
            aboutUsText: "Somos una empresa dedicada a traer la mejor tecnolog√≠a al mejor precio."
        };

        const defaultProducts = [
            { name: "iPhone 14 Pro", basePrice: 950000, category: "Celulares", stock: 10, image: "https://images.unsplash.com/photo-1664478546384-d57ffe74a797?q=80&w=500", description: "Potencia ilimitada." },
            { name: "Samsung S23 Ultra", basePrice: 890000, category: "Celulares", stock: 15, image: "https://images.unsplash.com/photo-1678911820864-e526120b4143?q=80&w=500", description: "Zoom espacial." },
            { name: "Sony WH-1000XM5", basePrice: 350000, category: "Audio", stock: 20, image: "https://images.unsplash.com/photo-1610427351608-2510255c46e0?q=80&w=500", description: "Silencio total." },
            { name: "MacBook Air M2", basePrice: 1200000, category: "Computaci√≥n", stock: 5, image: "https://images.unsplash.com/photo-1517336714731-489689fd1ca4?q=80&w=500", description: "Ligera y veloz." },
        ];

        const Loading = () => (
            <div className="fixed inset-0 bg-slate-900/90 z-[100] flex flex-col items-center justify-center backdrop-blur-sm">
                <RefreshCw className="w-12 h-12 text-cyan-500 animate-spin mb-4"/>
                <p className="text-cyan-400 text-sm font-bold tracking-[0.2em] animate-pulse">CARGANDO SISTEMA...</p>
            </div>
        );

        function App() {
            const [view, setView] = useState('store');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState(() => {
                try {
                const savedCart = localStorage.getItem('nexus_cart');
                return savedCart ? JSON.parse(savedCart) : [];
                } catch(e) { return []; }
            });
            const [users, setUsers] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [favorites, setFavorites] = useState([]);
            const [orders, setOrders] = useState([]);
            const [userOrders, setUserOrders] = useState([]);
            const [settings, setSettings] = useState(defaultSettings);
            const [systemUser, setSystemUser] = useState(null);
            const [isSyncing, setIsSyncing] = useState(true);

            // UI States
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
            const [productToDelete, setProductToDelete] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(''); 
            const [activeTab, setActiveTab] = useState('completed'); 
            const [authError, setAuthError] = useState('');
            const [pendingOrderRecover, setPendingOrderRecover] = useState(null);
            const [aiThinking, setAiThinking] = useState(false);

            // Coupons & Checkout
            const [checkoutCoupon, setCheckoutCoupon] = useState('');
            const [appliedCoupon, setAppliedCoupon] = useState(null);

            // Chatbot
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([{ role: 'system', text: '¬°Hola! Soy la IA de Sustore. ¬øBuscas alg√∫n producto en especial?' }]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            // Forms
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', dni: '', phone: '' });
            const [checkoutData, setCheckoutData] = useState({ address: '', city: '', province: 'Santa Fe', zipCode: '', references: '', transferHolder: '', paymentId: '' });
            const [lastOrder, setLastOrder] = useState(null);
            const [tempSettings, setTempSettings] = useState(defaultSettings);
            const [newProduct, setNewProduct] = useState({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 });
            const [newCoupon, setNewCoupon] = useState({ code: '', discountPercentage: 10, expirationDate: '', userEmail: '' });
            const [editingId, setEditingId] = useState(null);
            const [newCategory, setNewCategory] = useState('');
            const [aboutText, setAboutText] = useState('');

            const fileInputRef = useRef(null);

            // --- PERSISTENCIA ---
            useEffect(() => { localStorage.setItem('nexus_cart', JSON.stringify(cart)); }, [cart]);
            
            useEffect(() => {
                if (!currentUser) {
                    const localFavs = localStorage.getItem('nexus_favs');
                    if (localFavs) setFavorites(JSON.parse(localFavs));
                }
            }, [currentUser]);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const status = urlParams.get('status');
                if (status === 'approved') {
                    setView('receipt');
                    setCart([]);
                    localStorage.removeItem('nexus_cart');
                    alert("¬°Pago aprobado por Mercado Pago!");
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            // --- AUTH & SYNC ---
            useEffect(() => {
                const initAuth = async () => {
                try {
                    await signInAnonymously(auth);
                } catch (err) { console.error(err); }
                };
                initAuth();
                return onAuthStateChanged(auth, setSystemUser);
            }, []);

            useEffect(() => {
                if (!systemUser) return;

                const prodUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (s) => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                
                const userUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => setUsers(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const couponUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), (s) => setCoupons(s.docs.map(d => ({ id: d.id, ...d.data() }))));

                const orderUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => {
                const ordersList = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                setOrders(ordersList);
                });

                const setUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), (s) => {
                if (!s.empty) {
                    const d = s.docs[0].data();
                    const merged = { ...defaultSettings, ...d };
                    if (!merged.categories || !Array.isArray(merged.categories)) merged.categories = defaultSettings.categories;
                    setSettings(merged);
                    setTempSettings(merged);
                    setAboutText(merged.aboutUsText);
                } else {
                    addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), defaultSettings);
                }
                setIsSyncing(false);
                });

                // Auto Login
                const savedId = localStorage.getItem('nexus_user_id');
                if (savedId && !currentUser) {
                    getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('__name__', '==', savedId)))
                    .then(s => {
                        if (!s.empty) {
                            const userData = {id: s.docs[0].id, ...s.docs[0].data()};
                            setCurrentUser(userData);
                            if (userData.favorites) setFavorites(userData.favorites);
                        }
                    });
                }
                return () => { prodUnsub(); userUnsub(); orderUnsub(); setUnsub(); couponUnsub(); };
            }, [systemUser]);

            useEffect(() => {
                if (currentUser && orders.length > 0) {
                setUserOrders(orders.filter(o => o.userId === currentUser.id));
                const pending = orders.find(o => o.userId === currentUser.id && o.status === 'Pendiente');
                setPendingOrderRecover(pending || null);
                }
            }, [currentUser, orders]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatMessages, isChatOpen]);

            // --- HELPERS ---
            const isValidDNI = (dni) => /^\d{7,8}$/.test(dni);
            const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            const isValidPhone = (phone) => /^\d{10,}$/.test(phone); 

            const isAdmin = (email) => {
                if (!email) return false;
                const adminList = settings.admins ? settings.admins.split(',').map(e => e.trim().toLowerCase()) : [];
                return adminList.includes(email.toLowerCase());
            };
            
            const calculatePrice = (basePrice, discount) => {
                const withMarkup = Number(basePrice) * (1 + settings.markupPercentage / 100);
                if (discount && discount > 0) {
                    return Math.ceil(withMarkup * (1 - discount / 100));
                }
                return Math.ceil(withMarkup);
            };

            const getRawPrice = (basePrice) => Math.ceil(Number(basePrice) * (1 + settings.markupPercentage / 100));

            // --- AUTH ---
            const performAuth = async (isRegister) => {
                setAuthError(''); 
                if (isRegister) {
                    if (!registerData.name || !registerData.dni || !registerData.email || !registerData.password || !registerData.phone) return setAuthError("Completa todos los campos.");
                    if (!isValidDNI(registerData.dni)) return setAuthError("DNI inv√°lido (debe ser un n√∫mero de 7 u 8 d√≠gitos).");
                    if (!isValidEmail(registerData.email)) return setAuthError("Email inv√°lido.");
                    if (!isValidPhone(registerData.phone)) return setAuthError("Tel√©fono inv√°lido (solo n√∫meros, m√≠n 10 d√≠gitos).");
                    if (registerData.password.length < 8) return setAuthError("La contrase√±a debe tener al menos 8 caracteres.");
                } else {
                    if (!loginData.email || !loginData.password) return setAuthError("Ingresa email y contrase√±a.");
                }

                setIsSyncing(true);
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    
                    if (isRegister) {
                        const qEmail = query(usersRef, where("email", "==", registerData.email));
                        const snapEmail = await getDocs(qEmail);
                        if (!snapEmail.empty) {
                            setIsSyncing(false);
                            return setAuthError("Este email ya est√° registrado. Intenta iniciar sesi√≥n.");
                        }

                        const qDni = query(usersRef, where("dni", "==", registerData.dni));
                        const snapDni = await getDocs(qDni);
                        
                        const newUser = { ...registerData, role: 'user', joinDate: new Date().toISOString(), favorites: [] };
                        const ref = await addDoc(usersRef, newUser);
                        
                        if (snapDni.empty) {
                            const welcomeCode = `HOLA-${registerData.name.split(' ')[0].toUpperCase()}${Math.floor(Math.random()*100)}`;
                            const coupon = {
                                code: welcomeCode,
                                discountPercentage: 15, 
                                expirationDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                                userEmail: registerData.email,
                                usedBy: []
                            };
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), coupon);
                            alert(`¬°Bienvenido! Te regalamos un cup√≥n de 15% OFF: ${welcomeCode}`);
                        }

                        setCurrentUser({ ...newUser, id: ref.id });
                        localStorage.setItem('nexus_user_id', ref.id);
                    } else {
                        const qLogin = query(usersRef, where("email", "==", loginData.email), where("password", "==", loginData.password));
                        const snapLogin = await getDocs(qLogin);
                        
                        if (!snapLogin.empty) {
                            const uData = { id: snapLogin.docs[0].id, ...snapLogin.docs[0].data() };
                            setCurrentUser(uData);
                            localStorage.setItem('nexus_user_id', uData.id);
                            if (uData.favorites) setFavorites(uData.favorites);
                        } else {
                            setAuthError("Usuario no encontrado o contrase√±a incorrecta.");
                            setIsSyncing(false);
                            return;
                        }
                    }
                    setView('store');
                    setIsMenuOpen(false);
                    setAuthError('');
                } catch (e) { setAuthError("Error de conexi√≥n: " + e.message); }
                setIsSyncing(false);
            };

            const onLoginSubmit = (e) => { e.preventDefault(); performAuth(false); };
            const onRegisterSubmit = (e) => { e.preventDefault(); performAuth(true); };

            const handleLogout = () => {
                localStorage.removeItem('nexus_user_id');
                localStorage.removeItem('nexus_cart'); 
                setCurrentUser(null);
                setView('store');
                setCart([]); 
                setFavorites([]);
                setShowLogoutConfirm(false);
                setIsMenuOpen(false);
            };

            // --- CART ---
            const manageCart = (prod, delta) => {
                const idx = cart.findIndex(i => i.product.id === prod.id);
                const currentStock = Number(prod.stock);
                if (idx === -1 && delta > 0) {
                if (currentStock < 1) return alert("Sin stock");
                setCart([...cart, { product: prod, quantity: 1 }]);
                } else if (idx !== -1) {
                const newCart = [...cart];
                const newQty = newCart[idx].quantity + delta;
                if (newQty <= 0) setCart(cart.filter((_, i) => i !== idx));
                else if (newQty <= currentStock) {
                    newCart[idx].quantity = newQty;
                    setCart(newCart);
                } else alert("Stock insuficiente");
                }
            };
            
            const cartSubtotal = cart.reduce((acc, item) => acc + (calculatePrice(item.product.basePrice, item.product.discount) * item.quantity), 0);
            const cartTotal = appliedCoupon ? Math.ceil(cartSubtotal * (1 - appliedCoupon.discountPercentage / 100)) : cartSubtotal;

            // --- MERCADO PAGO ---
            const handleGoToMP = async () => {
                if (!checkoutData.address || !checkoutData.city || !checkoutData.zipCode || !checkoutData.transferHolder) return alert("Completa los datos de env√≠o.");
                
                setIsSyncing(true);

                try {
                    // Check SDK
                    if (!window.MercadoPago) throw new Error("MercadoPago no carg√≥.");

                    const globalDiscountFactor = appliedCoupon ? (1 - appliedCoupon.discountPercentage / 100) : 1;
                    
                    const mpItems = cart.map(item => ({
                        ...item,
                        price: Math.ceil(calculatePrice(item.product.basePrice, item.product.discount) * globalDiscountFactor)
                    }));

                    // CALL TO VERCEL BACKEND
                    // IMPORTANT: This fetch requires the api/payment.ts file to be deployed on Vercel
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    const response = await fetch('/api/payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: mpItems, userEmail: currentUser?.email }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                         const errorData = await response.json().catch(() => ({}));
                         if(response.status === 404) throw new Error("API de pagos no encontrada. Si est√°s en local (tu PC), esto es normal. Sube a Vercel.");
                         throw new Error(errorData.error || `Error servidor: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // SAVE ORDER
                    const newOrder = {
                        orderId: `ORD-${Math.floor(Math.random()*100000)}`,
                        userId: currentUser?.id || 'guest', 
                        userName: currentUser?.name || checkoutData.transferHolder, 
                        userEmail: currentUser?.email || 'guest',
                        total: cartTotal, items: cart,
                        date: new Date().toISOString(), displayDate: new Date().toLocaleString(),
                        shippingAddress: `${checkoutData.address}, ${checkoutData.city}, ${checkoutData.province}`,
                        zipCode: checkoutData.zipCode, references: checkoutData.references || '',
                        paymentMethod: `Mercado Pago (Checkout Pro)`, transferHolder: checkoutData.transferHolder,
                        status: 'Pendiente', paymentId: '',
                        couponCode: appliedCoupon?.code
                    };
                    
                    if (appliedCoupon && currentUser) {
                         await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'coupons', appliedCoupon.id), { usedBy: [...appliedCoupon.usedBy, currentUser.id] });
                    }

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);

                    // OPEN CHECKOUT
                    const mp = new window.MercadoPago('APP_USR-1fed61e0-7d4a-4280-8c57-a4103b3c32b6', { locale: 'es-AR' });
                    mp.checkout({ preference: { id: data.id }, autoOpen: true });

                } catch(err) {
                    alert("Error: " + err.message);
                } finally {
                    setIsSyncing(false);
                }
            };

            // --- AI FEATURES ---
            const callGemini = async (prompt) => {
                try {
                    const response = await ai.models.generateContent({ model: 'gemini-2.5-flash', contents: prompt });
                    return response.text;
                } catch (error) { console.error(error); return "Error IA"; }
            };

            const generateDescription = async () => {
                if (!newProduct.name || !newProduct.category) return alert("Ingresa Nombre y Categor√≠a primero");
                setAiThinking(true);
                const text = await callGemini(`Escribe una descripci√≥n corta (30 palabras) para producto "${newProduct.name}" categor√≠a "${newProduct.category}".`);
                if(text) setNewProduct(prev => ({...prev, description: text}));
                setAiThinking(false);
            };

            const generateSocialPost = async (p) => {
                setAiThinking(true);
                const text = await callGemini(`Crea post Instagram para "${p.name}". Precio: $${calculatePrice(p.basePrice, p.discount)}. Tono oferta viral.`);
                setAiThinking(false);
                if(text) { navigator.clipboard.writeText(text); alert("¬°Post copiado!\n\n" + text); }
            };

            const generateExpertOpinion = async (p) => {
                setAiThinking(true);
                const text = await callGemini(`Dame 3 razones cortas para comprar "${p.name}". Act√∫a como experto.`);
                setAiThinking(false);
                alert(`üß† OPINI√ìN:\n\n${text}`);
            };

            const generateTechAnalysis = async (p) => {
                setAiThinking(true);
                const text = await callGemini(`Puntaje 1-10 en Gaming, Trabajo, Multimedia para "${p.name}".`);
                setAiThinking(false);
                alert(`üìä AN√ÅLISIS:\n\n${text}`);
            };

            const sendChat = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                const msg = chatInput;
                setChatMessages(p => [...p, { role: 'user', text: msg }]);
                setChatInput('');
                setIsChatLoading(true);
                
                const productCtx = products.map(p => `${p.name} ($${calculatePrice(p.basePrice, p.discount)})`).join(', ');
                const text = await callGemini(`Eres Sustore AI. Inventario: ${productCtx}. Cliente dice: "${msg}". Si compra, di "||ADD: NOMBRE||".`);
                
                let finalText = text;
                const addMatch = text.match(/\|\|ADD: (.*?)\|\|/);
                if (addMatch) {
                    const prodName = addMatch[1];
                    const prod = products.find(p => p.name.includes(prodName));
                    if (prod) { manageCart(prod, 1); finalText = text.replace(addMatch[0], "\n(‚úÖ Agregado al carrito)"); }
                }
                
                setChatMessages(p => [...p, { role: 'ai', text: finalText }]);
                setIsChatLoading(false);
            };

            // --- COUPON ---
            const saveCoupon = async () => {
                if(!newCoupon.code || !newCoupon.expirationDate) return alert("Datos incompletos");
                setIsSyncing(true);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), { ...newCoupon, usedBy: [] });
                setNewCoupon({ code: '', discountPercentage: 10, expirationDate: '', userEmail: '' });
                setIsSyncing(false);
            };

            const validateCoupon = () => {
                if(!checkoutCoupon) return;
                const found = coupons.find(c => c.code.toUpperCase() === checkoutCoupon.toUpperCase());
                if (!found) return alert("Cup√≥n no existe.");
                if (new Date(found.expirationDate) < new Date()) return alert("Cup√≥n vencido.");
                if (found.userEmail && found.userEmail !== currentUser?.email) return alert("Este cup√≥n no es para ti.");
                if (found.usedBy.includes(currentUser?.id || '')) return alert("Ya usaste este cup√≥n.");
                setAppliedCoupon(found);
                alert(`¬°Aplicado! ${found.discountPercentage}% OFF`);
            };

            // --- ADMIN ---
            const handleImage = (e) => {
                const f = e.target.files?.[0];
                if (f && f.size < 1000000) {
                    const r = new FileReader();
                    r.onload = () => setNewProduct(prev => ({...prev, image: r.result}));
                    r.readAsDataURL(f);
                } else alert("Imagen muy pesada (<1MB)");
            };

            const handleLogoUpload = (e) => {
                const f = e.target.files?.[0];
                if (f && f.size < 700000) {
                    const r = new FileReader();
                    r.onload = () => setTempSettings(prev => ({...prev, logoUrl: r.result}));
                    r.readAsDataURL(f);
                } else alert("Logo muy pesado (<700kb)");
            };

            const saveProduct = async () => {
                if (!newProduct.name || !newProduct.basePrice) return alert("Faltan datos");
                setIsSyncing(true);
                const pData = { 
                    ...newProduct, 
                    basePrice: Number(newProduct.basePrice), 
                    stock: Number(newProduct.stock),
                    discount: Number(newProduct.discount || 0),
                    image: newProduct.image || 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=500'
                };
                if (editingId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', editingId), pData);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), pData);
                setNewProduct({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 });
                setEditingId(null);
                if (fileInputRef.current) fileInputRef.current.value = "";
                setIsSyncing(false);
            };

            const deleteProd = async () => {
                if (!productToDelete) return;
                setIsSyncing(true);
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productToDelete.id));
                setProductToDelete(null);
                setIsSyncing(false);
            };

            const saveSettings = async () => {
                setIsSyncing(true);
                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'settings'));
                    const s = await getDocs(q);
                    const data = { ...tempSettings, aboutUsText: aboutText };
                    if (!s.empty) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', s.docs[0].id), data);
                    else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), data);
                    alert("Configuraci√≥n guardada.");
                } catch (err) { alert("Error: " + err.message); }
                setIsSyncing(false);
            };

            const toggleFavorite = async (productId) => {
                let newFavs;
                if (favorites.includes(productId)) newFavs = favorites.filter(id => id !== productId);
                else newFavs = [...favorites, productId];
                setFavorites(newFavs);
                if (currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), { favorites: newFavs });
                else localStorage.setItem('nexus_favs', JSON.stringify(newFavs));
            };

            const goIg = () => window.open(`https://www.instagram.com/${settings.instagramUser}/`, '_blank');
            const goWsp = () => window.open(settings.whatsappLink, '_blank');
            
            const handleRecoverYes = () => {
                if (!pendingOrderRecover) return;
                setCart(pendingOrderRecover.items);
                setLastOrder(pendingOrderRecover);
                const addrParts = pendingOrderRecover.shippingAddress.split(', ');
                setCheckoutData({ ...checkoutData, address: addrParts[0]||'', city: addrParts[1]||'', province: addrParts[2]||'Santa Fe', zipCode: pendingOrderRecover.zipCode, transferHolder: pendingOrderRecover.transferHolder });
                setView('checkout');
                setPendingOrderRecover(null); 
            };

            const handleRecoverNo = async () => {
                if (!pendingOrderRecover) return;
                setIsSyncing(true);
                try {
                    if (pendingOrderRecover.id) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingOrderRecover.id));
                    setPendingOrderRecover(null);
                    alert("Orden cancelada.");
                } catch(err) { alert("Error: " + err.message); }
                setIsSyncing(false);
            };

            const seedDB = async () => {
                setIsSyncing(true);
                for(const p of defaultProducts) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), p);
                setIsSyncing(false);
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 font-sans overflow-x-hidden pb-24">
                    {isSyncing && <Loading />}

                    {/* HEADER */}
                    <header className="fixed top-0 w-full z-40 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 h-16 flex items-center justify-between px-4 lg:px-8 shadow-lg">
                        <div className="flex items-center gap-4 flex-1">
                        <div onClick={() => setView('store')} className="cursor-pointer">
                            {settings.logoUrl ? <img src={settings.logoUrl} className="h-10 w-10 rounded-full object-cover border-2 border-cyan-500/30"/> : <SustoreLogo />}
                        </div>
                        <div className="hidden md:flex items-center bg-slate-800 border border-slate-700 rounded-full px-4 py-2 w-full max-w-md focus-within:border-cyan-500 transition-colors">
                            <Search className="w-4 h-4 mr-2 text-slate-400" />
                            <input className="bg-transparent border-none outline-none text-sm w-full text-white placeholder-slate-400" placeholder="Buscar productos..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                        </div>
                        </div>

                        <div className="flex items-center gap-3 sm:gap-5">
                        <button onClick={goWsp} className="text-green-400 hover:text-green-300 transition hover:scale-110"><MessageCircle className="w-6 h-6"/></button>
                        <button onClick={goIg} className="text-pink-400 hover:text-pink-300 transition hover:scale-110"><Instagram className="w-6 h-6"/></button>
                        
                        <button onClick={() => setView('favorites')} className="text-slate-400 hover:text-red-400 transition relative">
                            <Heart className={`w-6 h-6 ${favorites.length > 0 ? 'fill-red-500 text-red-500' : ''}`} />
                        </button>
                        
                        <button onClick={() => setView('cart')} className="relative text-slate-300 hover:text-cyan-400 transition">
                            <ShoppingBag className="w-6 h-6" />
                            {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-green-500 text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center border border-slate-900">{cart.length}</span>}
                        </button>

                        {currentUser ? (
                            <div onClick={() => setView('profile')} className="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold text-xs cursor-pointer hover:bg-cyan-500 relative border border-cyan-400/30">
                                {currentUser.name.charAt(0).toUpperCase()}
                            </div>
                        ) : (
                            <button onClick={() => setView('login')} className="text-slate-300 hover:text-white"><User className="w-6 h-6"/></button>
                        )}

                        <button onClick={() => setIsMenuOpen(true)} className="text-slate-300 hover:text-white ml-2">
                            <Menu className="w-7 h-7" />
                        </button>
                        </div>
                    </header>
                    <div className="h-16"></div>

                    {/* ALERT RECOVER */}
                    {pendingOrderRecover && (
                        <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-up">
                            <div className="bg-slate-800 border border-yellow-500/50 p-6 rounded-2xl shadow-2xl max-w-md w-full text-center">
                                <AlertTriangle className="w-12 h-12 text-yellow-500 mx-auto mb-4 animate-bounce"/>
                                <h3 className="text-xl font-bold text-white mb-2">¬°Compra Pendiente!</h3>
                                <p className="text-slate-400 mb-6 text-sm">Dejaste un pago de <strong>${pendingOrderRecover.total.toLocaleString()}</strong> sin confirmar. ¬øDeseas retomarlo?</p>
                                <div className="flex gap-3">
                                    <button onClick={handleRecoverNo} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-xl font-bold transition">No, descartar</button>
                                    <button onClick={handleRecoverYes} className="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold transition">S√≠, continuar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MENU LATERAL */}
                    {isMenuOpen && (
                        <div className="fixed inset-0 z-[60] flex justify-end animate-fade-up">
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}></div>
                        <div className="relative bg-slate-800 w-72 h-full shadow-2xl flex flex-col border-l border-slate-700">
                            <div className="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-900">
                            <span className="font-bold text-lg text-white tracking-widest">MEN√ö</span>
                            <button onClick={() => setIsMenuOpen(false)}><X className="text-slate-400 hover:text-white"/></button>
                            </div>
                            
                            <div className="p-4 space-y-2 overflow-y-auto flex-1">
                            <button onClick={() => { setView('store'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><Home className="w-5 h-5"/> Inicio</button>
                            <button onClick={() => { setView('about'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><Info className="w-5 h-5"/> Sobre Nosotros</button>
                            <button onClick={() => { setView('favorites'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><Heart className="w-5 h-5"/> Favoritos</button>
                            
                            <div className="pt-2 pb-2 border-t border-slate-700 mt-2">
                                <p className="text-xs text-slate-500 uppercase font-bold px-3 mb-2">Categor√≠as</p>
                                {settings.categories.map(cat => (
                                    <button key={cat} onClick={() => { setSearchQuery(''); setSelectedCategory(cat); setView('store'); setIsMenuOpen(false); }} className="w-full text-left px-3 py-2 rounded hover:bg-white/5 text-sm text-slate-400 hover:text-cyan-400 flex items-center gap-2 transition">
                                        <Tag className="w-3 h-3"/> {cat}
                                    </button>
                                ))}
                            </div>

                            {currentUser && <button onClick={() => { setView('profile'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><ShoppingBag className="w-5 h-5"/> Mis Compras</button>}
                            {currentUser && isAdmin(currentUser.email) && <button onClick={() => { setView('admin'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded bg-purple-900/20 text-purple-300 font-bold flex gap-3 border border-purple-500/30 mt-2"><Zap className="w-5 h-5"/> PANEL ADMIN</button>}
                            </div>
                            {currentUser && (
                            <div className="p-5 border-t border-slate-700 bg-slate-900">
                                <button onClick={() => setShowLogoutConfirm(true)} className="w-full py-2 border border-red-500/30 text-red-400 rounded-lg text-sm font-bold hover:bg-red-500/10">Cerrar Sesi√≥n</button>
                            </div>
                            )}
                        </div>
                        </div>
                    )}

                    {/* LOGOUT CONFIRM */}
                    {showLogoutConfirm && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 p-4 animate-fade-up">
                        <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-700 text-center">
                            <h3 className="font-bold text-lg mb-4 text-white">¬øCerrar Sesi√≥n?</h3>
                            <div className="flex gap-3">
                            <button onClick={() => setShowLogoutConfirm(false)} className="flex-1 py-2 bg-slate-700 rounded-lg text-slate-200 font-bold">Cancelar</button>
                            <button onClick={handleLogout} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Salir</button>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* VIEWS */}
                    {view === 'store' && (
                        <main className="animate-fade-up">
                        {/* HERO */}
                        <div className="relative h-[500px] flex items-center justify-center overflow-hidden bg-slate-900">
                            <div className="absolute inset-0 bg-cover bg-center opacity-60" style={{ backgroundImage: `url('${settings.heroUrl || "https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1920&auto=format&fit=crop"}')` }}></div>
                            <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                            <div className="relative z-10 text-center px-4">
                            <span className="bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 text-xs font-bold px-4 py-1 rounded-full uppercase tracking-widest mb-4 inline-block backdrop-blur-sm">Tecnolog√≠a</span>
                            <h1 className="text-5xl md:text-7xl font-extrabold text-white mb-6 drop-shadow-lg tracking-tight">NEXT LEVEL</h1>
                            <button onClick={() => document.getElementById('products')?.scrollIntoView({behavior:'smooth'})} className="bg-white text-slate-900 px-8 py-3 rounded-full font-bold shadow-xl hover:scale-105 transition">VER CAT√ÅLOGO</button>
                            </div>
                        </div>
                        
                        <div id="products" className="max-w-7xl mx-auto px-4 py-16">
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-4">
                                    <div className="h-8 w-1 bg-cyan-500 rounded-full"></div>
                                    <h2 className="text-2xl font-bold text-white">
                                        {selectedCategory ? `Categor√≠a: ${selectedCategory}` : 'Novedades'}
                                    </h2>
                                </div>
                                <div className="flex gap-4">
                                    {isAdmin(currentUser?.email) && products.length === 0 && <button onClick={seedDB} className="text-cyan-400 text-xs font-bold border border-cyan-500/50 px-3 py-1 rounded">Restaurar Productos</button>}
                                    {selectedCategory && (
                                        <button onClick={() => setSelectedCategory('')} className="text-xs text-red-400 hover:text-red-300 flex items-center gap-1"><XCircle className="w-4 h-4"/> Borrar Filtro</button>
                                    )}
                                </div>
                            </div>
                            
                            {products.length === 0 ? (
                                <div className="text-center py-20 text-slate-500 border border-dashed border-slate-700 rounded-2xl">
                                    <p>No hay productos cargados a√∫n.</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                {products
                                    .filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()))
                                    .filter(p => !selectedCategory || p.category === selectedCategory)
                                    .map(p => (
                                    <div key={p.id} className="bg-slate-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-cyan-500/10 transition group border border-slate-700/50 relative">
                                    <div className="h-64 overflow-hidden relative bg-slate-900">
                                        <img src={p.image} className={`w-full h-full object-cover transition duration-500 ${Number(p.stock) > 0 ? 'group-hover:scale-110' : 'grayscale opacity-50'}`}/>
                                        
                                        <button 
                                            onClick={() => toggleFavorite(p.id)} 
                                            className="absolute top-3 right-3 p-2 rounded-full bg-slate-900/50 backdrop-blur-sm hover:bg-white/20 transition z-20"
                                        >
                                            <Heart className={`w-5 h-5 ${favorites.includes(p.id) ? 'fill-red-500 text-red-500' : 'text-white'}`} />
                                        </button>
                                        
                                        {/* AI BUTTONS */}
                                        <div className="absolute top-3 left-3 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            <button onClick={() => generateExpertOpinion(p)} className="p-2 rounded-full bg-cyan-600 text-white shadow-lg hover:scale-110 transition" title="Opini√≥n Experta IA"><Brain className="w-4 h-4"/></button>
                                            <button onClick={() => generateTechAnalysis(p)} className="p-2 rounded-full bg-purple-600 text-white shadow-lg hover:scale-110 transition" title="An√°lisis T√©cnico"><BarChart className="w-4 h-4"/></button>
                                        </div>

                                        {p.discount ? (
                                            <div className="absolute bottom-3 left-3 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg animate-pulse">{p.discount}% OFF</div>
                                        ) : null}

                                        {Number(p.stock) <= 0 && <div className="absolute inset-0 bg-black/70 flex items-center justify-center"><span className="text-white font-bold bg-red-600 px-3 py-1 rounded uppercase text-xs tracking-wider">AGOTADO</span></div>}
                                        {Number(p.stock) > 0 && <button onClick={() => manageCart(p, 1)} className="absolute bottom-3 right-3 bg-white text-slate-900 p-3 rounded-full shadow-lg opacity-0 group-hover:opacity-100 translate-y-2 group-hover:translate-y-0 transition hover:bg-cyan-400"><Plus className="w-5 h-5"/></button>}
                                    </div>
                                    <div className="p-5">
                                        <p className="text-[10px] text-cyan-400 font-bold uppercase mb-1 tracking-wider">{p.category}</p>
                                        <h3 className="font-bold text-white text-lg truncate mb-2">{p.name}</h3>
                                        <div className="flex justify-between items-end">
                                        <div className="flex flex-col">
                                            {p.discount ? <span className="text-xs text-slate-500 line-through">${getRawPrice(p.basePrice).toLocaleString()}</span> : null}
                                            <span className="text-xl font-bold text-white">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</span>
                                        </div>
                                        <span className={`text-[10px] px-2 py-1 rounded ${Number(p.stock) > 0 ? 'bg-green-900/30 text-green-400 border border-green-900' : 'bg-red-900/30 text-red-400 border border-red-900'}`}>{Number(p.stock) > 0 ? 'Stock Disponible' : 'Sin Stock'}</span>
                                        </div>
                                    </div>
                                    </div>
                                ))}
                                </div>
                            )}
                        </div>
                        </main>
                    )}

                    {/* CHECKOUT */}
                    {view === 'checkout' && currentUser && (
                        <div className="max-w-md mx-auto px-4 py-12 animate-fade-up">
                            <button onClick={() => setView('cart')} className="mb-6 text-slate-400 hover:text-white flex items-center"><ArrowRight className="w-4 h-4 rotate-180 mr-1"/> Volver</button>
                            
                            <div className="bg-white p-6 rounded-2xl shadow-xl text-slate-900 deposit-card relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-cyan-500 to-green-500"></div>
                                <h2 className="text-2xl font-bold text-center mb-1 mt-2">Pagar Compra</h2>
                                <p className="text-center text-slate-500 text-sm mb-6">Checkout Pro - Mercado Pago</p>
                                
                                {/* SUMMARY */}
                                <div className="mb-4 text-xs text-slate-500 border-b pb-2 border-slate-100 max-h-32 overflow-y-auto">
                                    {cart.map((i, idx) => (
                                        <div key={idx} className="flex items-center gap-3 mb-2">
                                            <img src={i.product.image} className="w-8 h-8 rounded object-cover border border-slate-200"/>
                                            <div className="flex-1">
                                                <p className="font-bold text-slate-800 truncate">{i.product.name}</p>
                                                <p className="text-xs text-slate-500">{i.quantity} x ${calculatePrice(i.product.basePrice, i.product.discount).toLocaleString()}</p>
                                            </div>
                                            <span className="font-bold text-slate-900">${(calculatePrice(i.product.basePrice, i.product.discount) * i.quantity).toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>

                                {/* COUPON INPUT */}
                                <div className="flex gap-2 mb-4">
                                    <input className="flex-1 bg-slate-50 border border-slate-200 p-2 rounded text-sm uppercase font-bold text-slate-700" placeholder="C√ìDIGO CUP√ìN" value={checkoutCoupon} onChange={e => setCheckoutCoupon(e.target.value)}/>
                                    <button onClick={validateCoupon} className="bg-purple-600 text-white px-3 rounded font-bold text-xs">APLICAR</button>
                                </div>
                                {appliedCoupon && <div className="mb-4 text-green-600 text-sm font-bold bg-green-50 p-2 rounded border border-green-200 flex justify-between items-center"><span>{appliedCoupon.code} Aplicado!</span> <span>-{appliedCoupon.discountPercentage}%</span></div>}

                                <div className="bg-slate-50 p-4 rounded-xl mb-6 text-center border border-slate-200">
                                    {appliedCoupon && <p className="text-xs text-slate-400 line-through mb-1">${cartSubtotal.toLocaleString()}</p>}
                                    <p className="text-xs text-slate-500 uppercase font-bold mb-1 tracking-wide">Total a Pagar</p>
                                    <div className="text-4xl font-extrabold text-slate-900">${cartTotal.toLocaleString()}</div>
                                </div>

                                <form className="space-y-3">
                                <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg text-slate-900" placeholder="Direcci√≥n de Env√≠o" value={checkoutData.address} onChange={e => setCheckoutData({...checkoutData, address: e.target.value})} required/>
                                <div className="grid grid-cols-2 gap-3">
                                    <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg text-slate-900" placeholder="Ciudad" value={checkoutData.city} onChange={e => setCheckoutData({...checkoutData, city: e.target.value})} required/>
                                    <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg text-slate-900" placeholder="CP" value={checkoutData.zipCode} onChange={e => setCheckoutData({...checkoutData, zipCode: e.target.value})} required/>
                                </div>
                                <input className="w-full bg-slate-50 border border-slate-200 p-3 rounded-lg text-slate-900" placeholder="Titular (Nombre Completo)" value={checkoutData.transferHolder} onChange={e => setCheckoutData({...checkoutData, transferHolder: e.target.value})} required/>

                                <button type="button" onClick={handleGoToMP} disabled={!checkoutData.address} className={`w-full py-3.5 text-lg font-bold rounded-xl shadow-lg transition flex justify-center items-center gap-2 ${checkoutData.address ? 'bg-[#009EE3] hover:brightness-110 text-white' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}>
                                    IR A MERCADO PAGO
                                </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* RECEIPT */}
                    {view === 'receipt' && (
                        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-up">
                        <div className="bg-slate-800 text-slate-100 p-8 rounded-3xl shadow-2xl relative max-w-md w-full font-mono border border-slate-700">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-green-500 to-cyan-500"></div>
                            <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-2 border-green-500/50"><CheckCircle className="text-green-400 w-10 h-10" /></div>
                            <h2 className="text-2xl font-bold uppercase tracking-widest text-white mb-2">¬°Pago Exitoso!</h2>
                            <p className="text-sm text-slate-400">Tu orden ha sido procesada correctamente.</p>
                            </div>
                            <button onClick={() => { setView('store'); setLastOrder(null); }} className="w-full bg-cyan-600 text-white py-4 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg uppercase tracking-wider flex items-center justify-center gap-2">
                            <ShoppingBag className="w-5 h-5"/> Volver a la Tienda
                            </button>
                        </div>
                        </div>
                    )}

                    {/* LOGIN/REGISTER */}
                    {(view === 'login' || view === 'register') && (
                        <div className="flex items-center justify-center min-h-[80vh] px-4 animate-fade-up">
                        <div className="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-700 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-cyan-500 to-blue-500"></div>
                            <h2 className="text-2xl font-bold text-center text-white mb-6">{view === 'login' ? 'Bienvenido' : 'Crear Cuenta'}</h2>
                            
                            {authError && <div className="bg-red-500/10 border border-red-500/50 text-red-200 p-3 rounded-lg mb-4 text-sm flex items-center gap-2"><AlertCircle className="w-4 h-4"/> {authError}</div>}
                            
                            <form onSubmit={view === 'login' ? onLoginSubmit : onRegisterSubmit} className="space-y-4">
                                {view === 'register' && (
                                    <>
                                    <input className="w-full bg-white text-slate-900 p-3 rounded-lg" placeholder="Nombre Completo" value={registerData.name} onChange={e => setRegisterData({...registerData, name: e.target.value})}/>
                                    <input className="w-full bg-white text-slate-900 p-3 rounded-lg" placeholder="DNI (Sin puntos)" value={registerData.dni} onChange={e => setRegisterData({...registerData, dni: e.target.value})}/>
                                    </>
                                )}
                                <input className="w-full bg-white text-slate-900 p-3 rounded-lg" placeholder="Email" value={view === 'login' ? loginData.email : registerData.email} onChange={e => view === 'login' ? setLoginData({...loginData, email: e.target.value}) : setRegisterData({...registerData, email: e.target.value})}/>
                                {view === 'register' && <input className="w-full bg-white text-slate-900 p-3 rounded-lg" placeholder="Tel√©fono" value={registerData.phone} onChange={e => setRegisterData({...registerData, phone: e.target.value})}/>}
                                <input className="w-full bg-white text-slate-900 p-3 rounded-lg" type="password" placeholder="Contrase√±a" value={view === 'login' ? loginData.password : registerData.password} onChange={e => view === 'login' ? setLoginData({...loginData, password: e.target.value}) : setRegisterData({...registerData, password: e.target.value})}/>
                                
                                <button className="w-full bg-cyan-600 text-white py-3.5 rounded-lg font-bold hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/20">{view === 'login' ? 'INGRESAR' : 'REGISTRARSE'}</button>
                            </form>
                            
                            <button onClick={() => { setView(view === 'login' ? 'register' : 'login'); setAuthError(''); }} className="w-full text-center text-slate-400 text-sm mt-6 hover:text-white transition">
                                {view === 'login' ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Ingresa'}
                            </button>
                        </div>
                        </div>
                    )}
                    
                    {/* CART VIEW */}
                    {view === 'cart' && (
                        <div className="max-w-2xl mx-auto px-4 py-12 animate-fade-up">
                            <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><ShoppingBag className="text-cyan-400"/> Carrito</h2>
                            {cart.length === 0 ? <p className="text-slate-500 text-center py-10 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">Tu carrito est√° vac√≠o.</p> : (
                            <div className="space-y-4">
                                {cart.map((item, i) => (
                                    <div key={i} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-4">
                                        <img src={item.product.image} className="w-16 h-16 object-cover rounded-lg"/>
                                        <div className="flex-1">
                                        <h4 className="text-white font-bold">{item.product.name}</h4>
                                        <div className="flex gap-2 items-end">
                                            <p className="text-cyan-400 font-bold">${calculatePrice(item.product.basePrice, item.product.discount).toLocaleString()}</p>
                                            {item.product.discount ? <span className="text-xs text-slate-500 line-through">${getRawPrice(item.product.basePrice).toLocaleString()}</span> : null}
                                        </div>
                                        </div>
                                        <div className="flex items-center gap-3 bg-slate-900 rounded-lg p-1.5 border border-slate-700">
                                        <button onClick={()=>manageCart(item.product, -1)} className="text-slate-400 hover:text-white"><Minus className="w-4 h-4"/></button>
                                        <span className="text-white font-bold w-4 text-center">{item.quantity}</span>
                                        <button onClick={()=>manageCart(item.product, 1)} className="text-slate-400 hover:text-white"><Plus className="w-4 h-4"/></button>
                                        </div>
                                    </div>
                                ))}
                                <div className="mt-8 p-6 bg-slate-800 rounded-2xl border border-slate-700 flex justify-between items-center shadow-lg">
                                    <div><p className="text-slate-400 text-xs uppercase">Total Estimado</p><span className="text-2xl font-bold text-white">${cartSubtotal.toLocaleString()}</span></div>
                                    <button onClick={()=>{if(!currentUser){alert("Inicia sesi√≥n para comprar");setView('login')}else setView('checkout')}} className="bg-cyan-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/20">PAGAR</button>
                                </div>
                            </div>
                            )}
                        </div>
                    )}

                    {/* PROFILE / MY COUPONS */}
                    {view === 'profile' && currentUser && (
                        <div className="max-w-3xl mx-auto px-4 py-12 animate-fade-up">
                            <div className="bg-slate-800 p-8 rounded-3xl border border-slate-700 mb-10 flex items-center gap-6 shadow-lg">
                                <div className="w-20 h-20 bg-cyan-600 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-inner">{currentUser.name[0]}</div>
                                <div><h2 className="text-2xl font-bold text-white">{currentUser.name}</h2><p className="text-slate-400">{currentUser.email}</p></div>
                            </div>
                            
                            <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><Ticket className="text-yellow-400"/> Mis Cupones</h3>
                            <div className="grid sm:grid-cols-2 gap-4 mb-10">
                                {coupons.filter(c => (c.userEmail === currentUser.email || !c.userEmail) && !c.usedBy.includes(currentUser.id)).map(c => (
                                    <div key={c.id} className="bg-yellow-900/20 border border-yellow-500/30 p-4 rounded-xl flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-yellow-400 text-lg">{c.code}</p>
                                            <p className="text-xs text-slate-400">Vence: {new Date(c.expirationDate).toLocaleDateString()}</p>
                                        </div>
                                        <span className="text-2xl font-bold text-white">{c.discountPercentage}% OFF</span>
                                    </div>
                                ))}
                                {coupons.filter(c => (c.userEmail === currentUser.email || !c.userEmail) && !c.usedBy.includes(currentUser.id)).length === 0 && <p className="text-slate-500 text-sm">No tienes cupones disponibles.</p>}
                            </div>

                            <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><ShoppingBag className="text-purple-400"/> Mis Compras</h3>
                            <div className="space-y-3">
                                {userOrders.map(o => (
                                    <div key={o.orderId} className="bg-slate-800 p-5 rounded-2xl border border-slate-700">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-xs text-slate-400">{o.displayDate}</span>
                                            <span className={`text-xs px-2 py-1 rounded ${o.status==='Pagado'?'bg-green-900 text-green-300':'bg-yellow-900 text-yellow-300'}`}>{o.status}</span>
                                        </div>
                                        <p className="font-bold text-white">Total: ${o.total.toLocaleString()}</p>
                                        <p className="text-xs text-slate-500 mt-1">{o.items.length} productos</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* FAVORITES VIEW */}
                    {view === 'favorites' && (
                        <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                            <h2 className="text-2xl font-bold text-white mb-8 flex items-center gap-2"><Heart className="text-red-500 fill-red-500"/> Mis Favoritos</h2>
                            {favorites.length === 0 ? (
                                <p className="text-slate-500 text-center py-10 border border-dashed border-slate-700 rounded-xl">No tienes productos en favoritos.</p>
                            ) : (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                    {products.filter(p => favorites.includes(p.id)).map(p => (
                                        <div key={p.id} className="bg-slate-800 rounded-2xl overflow-hidden shadow-lg border border-slate-700/50 relative">
                                            <div className="h-48 overflow-hidden relative bg-slate-900">
                                                <img src={p.image} className="w-full h-full object-cover"/>
                                                <button onClick={() => toggleFavorite(p.id)} className="absolute top-2 right-2 p-2 bg-black/50 rounded-full text-red-500 hover:bg-white hover:text-red-600 transition"><X className="w-4 h-4"/></button>
                                            </div>
                                            <div className="p-4">
                                                <h3 className="font-bold text-white truncate">{p.name}</h3>
                                                <p className="text-cyan-400 font-bold mt-1">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</p>
                                                <button onClick={() => manageCart(p, 1)} className="w-full mt-3 bg-slate-700 text-white py-2 rounded-lg hover:bg-cyan-600 transition text-sm font-bold">Agregar al Carrito</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* ABOUT VIEW */}
                    {view === 'about' && (
                        <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up">
                            <h2 className="text-3xl font-bold mb-6 text-white flex items-center gap-3"><Info className="text-cyan-400"/> Sobre Nosotros</h2>
                            <div className="bg-slate-800 p-8 rounded-3xl border border-cyan-500/20 shadow-2xl">
                                <p className="text-slate-300 text-lg leading-relaxed whitespace-pre-wrap">{settings.aboutUsText}</p>
                            </div>
                        </div>
                    )}

                    {/* ADMIN VIEW */}
                    {view === 'admin' && isAdmin(currentUser?.email) && (
                        <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                            <div className="flex justify-between items-end mb-8 bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                <div><h2 className="text-3xl font-bold text-white mb-1">Panel de Control</h2><p className="text-slate-400 text-sm">Gesti√≥n de Sustore</p></div>
                                <div className="flex gap-3">
                                    <button onClick={() => setView('store')} className="bg-slate-700 text-slate-200 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-600 transition">Salir</button>
                                </div>
                            </div>
                            <div className="grid lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-2 space-y-8">
                                    {/* PRODUCT EDITOR */}
                                    <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 relative overflow-hidden">
                                        <h3 className="font-bold text-white mb-6 flex gap-2 items-center text-lg">{editingId ? 'Editar Producto' : 'Nuevo Producto'}</h3>
                                        <div className="grid md:grid-cols-2 gap-5">
                                            <div className="md:col-span-2">
                                            <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Nombre</label>
                                            <input className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})}/>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Costo Base</label>
                                                <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.basePrice} onChange={e => setNewProduct({...newProduct, basePrice: e.target.value})}/>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Stock</label>
                                                <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.stock} onChange={e => setNewProduct({...newProduct, stock: e.target.value})}/>
                                            </div>
                                            <div className="md:col-span-2">
                                            <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Categor√≠a</label>
                                            <select className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.category} onChange={(e) => setNewProduct({...newProduct, category: e.target.value})}>
                                                <option value="">Seleccionar...</option>
                                                {settings.categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                            </select>
                                            </div>
                                            
                                            {/* OFFER FIELD */}
                                            <div>
                                                <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Oferta (% OFF)</label>
                                                <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-red-400 focus:border-red-500 transition" value={newProduct.discount} onChange={e => setNewProduct({...newProduct, discount: Number(e.target.value)})}/>
                                            </div>
                                            {newProduct.basePrice && (
                                                <div className="flex items-center">
                                                    <p className="text-sm text-slate-400">Precio Final: <span className="font-bold text-white">${calculatePrice(newProduct.basePrice, newProduct.discount).toLocaleString()}</span></p>
                                                </div>
                                            )}

                                            <div className="col-span-2">
                                                <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Descripci√≥n</label>
                                                <div className="flex gap-2">
                                                    <textarea className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white transition h-20 text-xs" value={newProduct.description} onChange={e => setNewProduct({...newProduct, description: e.target.value})}/>
                                                    <button onClick={generateDescription} disabled={aiThinking} className="bg-cyan-600 text-white p-2 rounded-xl hover:bg-cyan-500 flex items-center justify-center min-w-[50px]"><Zap className={`w-5 h-5 ${aiThinking ? 'animate-spin' : ''}`}/></button>
                                                </div>
                                            </div>

                                            <div className="col-span-2">
                                                <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Imagen</label>
                                                <input type="file" ref={fileInputRef} onChange={handleImage} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-slate-700 file:text-white hover:file:bg-cyan-600 cursor-pointer"/>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 mt-6">
                                            {editingId && <button onClick={() => { setEditingId(null); setNewProduct({ name: '', basePrice: '', category: '', image: '', description: '', stock: '', discount: 0 }); }} className="flex-1 py-3 rounded-xl font-bold text-slate-400 border border-slate-600 hover:bg-slate-700">Cancelar</button>}
                                            <button onClick={saveProduct} className="flex-1 py-3 rounded-xl font-bold text-white bg-cyan-600 hover:bg-cyan-500 shadow-lg transition">{editingId ? 'Actualizar' : 'Publicar'}</button>
                                        </div>
                                    </div>
                                    
                                    {/* COUPON MANAGER */}
                                    <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                                        <h3 className="font-bold text-white mb-6 flex gap-2 items-center text-lg"><Ticket className="text-yellow-400"/> Crear Cup√≥n</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input className="bg-slate-900 border border-slate-600 p-3 rounded-lg text-white" placeholder="C√ìDIGO (Ej: PROMO10)" value={newCoupon.code} onChange={e => setNewCoupon({...newCoupon, code: e.target.value.toUpperCase()})}/>
                                            <input className="bg-slate-900 border border-slate-600 p-3 rounded-lg text-white" type="number" placeholder="% Descuento" value={newCoupon.discountPercentage} onChange={e => setNewCoupon({...newCoupon, discountPercentage: Number(e.target.value)})}/>
                                            <input className="bg-slate-900 border border-slate-600 p-3 rounded-lg text-white text-xs" type="date" value={newCoupon.expirationDate} onChange={e => setNewCoupon({...newCoupon, expirationDate: e.target.value})}/>
                                            <input className="bg-slate-900 border border-slate-600 p-3 rounded-lg text-white text-xs" placeholder="Email Usuario (Opcional)" value={newCoupon.userEmail} onChange={e => setNewCoupon({...newCoupon, userEmail: e.target.value})}/>
                                        </div>
                                        <button onClick={saveCoupon} className="w-full mt-4 bg-yellow-600 text-white font-bold py-2 rounded-lg hover:bg-yellow-500">Crear Cup√≥n</button>

                                        <div className="mt-6 border-t border-slate-700 pt-4">
                                            <p className="text-xs text-slate-400 uppercase font-bold mb-2">Cupones Activos</p>
                                            <div className="space-y-2">
                                                {coupons.map(c => (
                                                    <div key={c.id} className="flex justify-between items-center text-xs bg-slate-900 p-2 rounded border border-slate-700">
                                                        <span><strong className="text-yellow-400">{c.code}</strong> ({c.discountPercentage}%)</span>
                                                        <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'coupons', c.id))} className="text-red-400"><Trash2 className="w-3 h-3"/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* SIDEBAR SETTINGS */}
                                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 h-fit sticky top-24">
                                    <h3 className="font-bold text-white mb-6 flex items-center gap-2 text-lg"><Settings className="w-5 h-5 text-purple-400"/> Configuraci√≥n</h3>
                                    <div className="space-y-5">
                                    <div className="pt-4 border-t border-slate-700">
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Texto "Sobre Nosotros"</label>
                                        <textarea className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white transition h-24 text-xs" value={aboutText} onChange={(e) => setAboutText(e.target.value)} />
                                    </div>
                                    <div className="pt-4 border-t border-slate-700">
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Porcentaje Ganancia (%)</label>
                                        <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-green-400 font-bold transition" value={settings.markupPercentage} onChange={(e) => setTempSettings({...tempSettings, markupPercentage: Number(e.target.value)})} />
                                    </div>
                                    <div className="pt-4 border-t border-slate-700">
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Logo Tienda</label>
                                        <input type="file" accept="image/*" className="text-xs text-slate-500" onChange={handleLogoUpload} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Categor√≠as</label>
                                        <div className="flex gap-2 mb-2">
                                            <input className="w-full bg-slate-900 border border-slate-600 p-2 rounded-lg outline-none text-white text-xs" placeholder="Nueva categor√≠a..." value={newCategory} onChange={(e) => setNewCategory(e.target.value)}/>
                                            <button onClick={() => {
                                                if(newCategory && !tempSettings.categories.includes(newCategory)) {
                                                    setTempSettings({...tempSettings, categories: [...tempSettings.categories, newCategory]});
                                                    setNewCategory('');
                                                }
                                            }} className="bg-green-600 text-white p-2 rounded-lg hover:bg-green-500"><Plus className="w-4 h-4"/></button>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {settings.categories.map(cat => (
                                                <span key={cat} className="text-xs bg-slate-900 text-slate-300 px-2 py-1 rounded border border-slate-700 flex items-center gap-1">
                                                    {cat}
                                                    <button onClick={() => setTempSettings({...tempSettings, categories: tempSettings.categories.filter(c => c !== cat)})} className="hover:text-red-400"><X className="w-3 h-3"/></button>
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div className="pt-4 border-t border-slate-700">
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Gestionar Productos</label>
                                        <div className="max-h-60 overflow-y-auto rounded-lg border border-slate-700">
                                            <table className="w-full text-left text-xs text-slate-400">
                                                <thead className="bg-slate-900 text-slate-300 sticky top-0">
                                                    <tr>
                                                        <th className="p-2">Img</th>
                                                        <th className="p-2">Nombre</th>
                                                        <th className="p-2">$$</th>
                                                        <th className="p-2 text-right">Acci√≥n</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-700">
                                                    {products.map(p => (
                                                        <tr key={p.id} className="hover:bg-slate-700/50">
                                                            <td className="p-2"><img src={p.image} className="w-8 h-8 rounded object-cover"/></td>
                                                            <td className="p-2 text-white">{p.name}</td>
                                                            <td className="p-2 text-green-400">${calculatePrice(p.basePrice, p.discount).toLocaleString()}</td>
                                                            <td className="p-2 text-right flex justify-end gap-1">
                                                                <button onClick={() => generateSocialPost(p)} className="p-1 bg-pink-900/30 text-pink-400 rounded" title="Crear Post"><Share2 className="w-3 h-3"/></button>
                                                                <button onClick={() => { setNewProduct({ ...p, basePrice: p.basePrice }); setEditingId(p.id); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="p-1 bg-blue-900/30 text-blue-400 rounded"><Edit className="w-3 h-3"/></button>
                                                                <button onClick={() => setProductToDelete(p)} className="p-1 bg-red-900/30 text-red-400 rounded"><Trash2 className="w-3 h-3"/></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <button onClick={saveSettings} className="bg-purple-600 text-white px-4 py-3 rounded-xl font-bold w-full hover:bg-purple-500 shadow-lg transition">Guardar Configuraci√≥n</button>
                                </div>
                                </div>
                        </div>
                    </div>
                    )}

                    {/* PRODUCT DELETE CONFIRM */}
                    {productToDelete && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 p-4 animate-fade-up">
                        <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-red-500/50 text-center">
                            <AlertOctagon className="w-12 h-12 text-red-500 mx-auto mb-4"/>
                            <h3 className="font-bold text-lg mb-2 text-white">Eliminar Producto</h3>
                            <p className="text-slate-400 mb-6 text-sm">¬øEst√°s seguro? "{productToDelete.name}" se borrar√° para siempre.</p>
                            <div className="flex gap-3">
                            <button onClick={() => setProductToDelete(null)} className="flex-1 py-2 bg-slate-700 rounded-lg text-slate-200 font-bold">Cancelar</button>
                            <button onClick={deleteProd} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Eliminar</button>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* CHATBOT */}
                    <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
                        {isChatOpen && (
                        <div className="bg-slate-800 border border-cyan-500/30 rounded-2xl shadow-2xl w-80 h-96 mb-4 flex flex-col overflow-hidden animate-fade-up">
                            <div className="bg-cyan-600 p-3 flex justify-between items-center text-white">
                            <span className="font-bold flex gap-2 items-center"><Zap className="w-4 h-4 text-yellow-300 animate-pulse"/> Asistente IA</span>
                            <button onClick={() => setIsChatOpen(false)}><X className="w-4 h-4 hover:text-slate-200"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-900/50">
                            {chatMessages.map((m, i) => (
                                <div key={i} className={`p-3 rounded-lg text-sm max-w-[85%] shadow-sm whitespace-pre-wrap ${m.role==='user'?'bg-cyan-600/20 ml-auto text-cyan-200 border border-cyan-500/30':'bg-slate-700 mr-auto text-slate-200 border border-slate-600'}`}>{m.text}</div>
                            ))}
                            {isChatLoading && <div className="text-xs text-cyan-400 italic animate-pulse">Escribiendo...</div>}
                            <div ref={chatEndRef}/>
                            </div>
                            <form onSubmit={sendChat} className="p-2 border-t border-cyan-500/20 flex gap-2 bg-slate-800">
                            <input className="flex-1 bg-slate-900 border border-slate-600 rounded px-3 text-sm p-2 text-white outline-none" value={chatInput} onChange={e=>setChatInput(e.target.value)} placeholder="Escribe aqu√≠..."/>
                            <button className="p-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded transition"><Send className="w-4 h-4"/></button>
                            </form>
                        </div>
                        )}
                        <button onClick={() => setIsChatOpen(!isChatOpen)} className="bg-cyan-500 hover:bg-cyan-400 text-white p-4 rounded-full shadow-lg hover:scale-110 transition"><MessageCircle className="w-6 h-6"/></button>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
