<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustore - Next Level Technology</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Scrollbar personalizada oscura */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ShoppingBag, X, User, LogIn, Lock, Database, Search, Zap, CheckCircle, 
          MapPin, LogOut, Copy, ExternalLink, AlertTriangle, Cloud, RefreshCw, 
          Plus, Trash2, Package, Key, MessageCircle, Send, Instagram, Minus, 
          ArrowRight, Truck, FileText, Menu, Home, Phone, Edit, XCircle, AlertOctagon, 
          Heart, Image as ImageIcon, CreditCard, Settings, Tag, Info, Clock, AlertCircle, Bell, ThumbsUp, Grid, Smartphone
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, setDoc, getDocs, deleteDoc, where } from 'firebase/firestore';

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAfllte-D_I3h3TwBaiSL4KVfWrCSVh9ro",
          authDomain: "sustore-63266.firebaseapp.com",
          projectId: "sustore-63266",
          storageBucket: "sustore-63266.firebasestorage.app",
          messagingSenderId: "684651914850",
          appId: "1:684651914850:web:f3df09e5caf6e50e9e533b",
          measurementId: "G-X3K7XGYPRD"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "sustore-prod-v1";

        // API Key para IA (Opcional)
        const apiKey = ""; 

        const callGemini = async (prompt) => {
            try {
                const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                }
                );
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar tu solicitud.";
            } catch (error) {
                console.error("Error Gemini:", error);
                return "El asistente no está disponible en este momento.";
            }
        };

        const SustoreLogo = () => (
            <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg overflow-hidden border-2 border-cyan-500">
                <svg viewBox="0 0 100 100" className="w-6 h-6" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 30 H60 M20 50 H80 M20 70 H50" stroke="#0F172A" strokeWidth="8" strokeLinecap="round"/>
                </svg>
            </div>
        );

        const defaultSettings = {
            storeName: "SUSTORE",
            primaryColor: "#06b6d4",
            currency: "$",
            mpLink: "https://link.mercadopago.com.ar/sustoresf", 
            admins: "lautarocorazza63@gmail.com",
            sellerEmail: "sustoresf@gmail.com",
            instagramUser: "sustore_sf",
            whatsappLink: "https://wa.me/message/3MU36VTEKINKP1",
            logoUrl: "",
            heroUrl: "",
            markupPercentage: 6.50,
            categories: ["Celulares", "Accesorios", "Audio", "Computación", "Gaming"],
            aboutUsText: "Somos una empresa dedicada a traer la mejor tecnología al mejor precio. Nuestro compromiso es con la calidad y la satisfacción del cliente."
        };

        const PROVINCIAS_ARG = [
            "Santa Fe", "Buenos Aires", "CABA", "Catamarca", "Chaco", "Chubut", "Córdoba", "Corrientes", 
            "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La Rioja", "Mendoza", "Misiones", 
            "Neuquén", "Río Negro", "Salta", "San Juan", "San Luis", "Santa Cruz", 
            "Santiago del Estero", "Tierra del Fuego", "Tucumán"
        ];

        const customStyles = `
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
            body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
            
            .header-dark { background-color: #111827; border-bottom: 1px solid #1f2937; }
            .search-bar-dark { background-color: #1f2937; border: 1px solid #374151; color: #9ca3af; transition: all 0.3s; }
            .search-bar-dark:focus-within { border-color: #06b6d4; color: white; }
            .search-input { color: white; }
            .search-input::placeholder { color: #9ca3af; }

            .input-white { background-color: #ffffff; border: 1px solid #e2e8f0; color: #0f172a; border-radius: 0.5rem; transition: all 0.2s; }
            .input-white:focus { border-color: #06b6d4; box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2); outline: none; }
            .input-white::placeholder { color: #94a3b8; }

            .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
            .animate-fade-up { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
            @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
            
            .deposit-card { background: white; color: #111827; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
            .btn-deposit { background-color: #22c55e; color: white; font-weight: bold; border-radius: 8px; transition: background-color 0.2s; }
            .btn-deposit:hover { background-color: #16a34a; }
            .btn-deposit:disabled { background-color: #cbd5e1; color: #94a3b8; cursor: not-allowed; }
            
            .neon-border { border: 1px solid rgba(6, 182, 212, 0.2); transition: all 0.3s; }
            .neon-border:hover { border-color: rgba(6, 182, 212, 0.6); box-shadow: 0 0 20px rgba(6, 182, 212, 0.15); }
            .logo-circle { border-radius: 50%; object-fit: cover; aspect-ratio: 1/1; }
            .neon-input { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); color: white; transition: all 0.3s; }
            .neon-input:focus { border-color: #06b6d4; box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2); background: rgba(30, 41, 59, 0.8); outline: none; }
        `;

        // Eliminé "export default" porque estamos en un script dentro del HTML
        function App() {
            const [view, setView] = useState('store');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState(() => {
                try {
                const savedCart = localStorage.getItem('nexus_cart');
                return savedCart ? JSON.parse(savedCart) : [];
                } catch(e) { return []; }
            });
            const [users, setUsers] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [favorites, setFavorites] = useState([]);
            const [orders, setOrders] = useState([]);
            const [userOrders, setUserOrders] = useState([]);
            const [settings, setSettings] = useState(defaultSettings);
            const [systemUser, setSystemUser] = useState(null);
            const [isSyncing, setIsSyncing] = useState(true);

            // UI States
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
            const [productToDelete, setProductToDelete] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(''); 
            const [activeTab, setActiveTab] = useState('completed'); 
            const [authError, setAuthError] = useState('');
            const [pendingOrderRecover, setPendingOrderRecover] = useState(null);

            // Chatbot
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([{ role: 'system', text: '¡Hola! Soy la IA de Sustore. ¿Buscas algún producto en especial?' }]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            // Forms
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', dni: '', phone: '' });
            const [checkoutData, setCheckoutData] = useState({ address: '', city: '', province: 'Santa Fe', zipCode: '', references: '', transferHolder: '', paymentId: '' });
            const [lastOrder, setLastOrder] = useState(null);
            const [tempSettings, setTempSettings] = useState(defaultSettings);
            const [newProduct, setNewProduct] = useState({ name: '', basePrice: '', category: '', image: '', description: '', stock: '' });
            const [editingId, setEditingId] = useState(null);
            const [newCategory, setNewCategory] = useState('');
            const [aboutText, setAboutText] = useState('');

            const fileInputRef = useRef(null);
            const logoInputRef = useRef(null);
            const heroInputRef = useRef(null);

            // --- PERSISTENCIA ---
            useEffect(() => { localStorage.setItem('nexus_cart', JSON.stringify(cart)); }, [cart]);
            
            useEffect(() => {
                if (currentUser) {
                    // Los favs se cargan del usuario
                } else {
                    const localFavs = localStorage.getItem('nexus_favs');
                    if (localFavs) setFavorites(JSON.parse(localFavs));
                }
            }, [currentUser]);

            // --- AUTH & SYNC ---
            useEffect(() => {
                const initAuth = async () => {
                try {
                    await signInAnonymously(auth);
                } catch (err) { console.error(err); }
                };
                initAuth();
                return onAuthStateChanged(auth, setSystemUser);
            }, []);

            useEffect(() => {
                if (!systemUser) return;

                const prodUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (s) => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                
                const userUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => {
                const uList = s.docs.map(d => ({ id: d.id, ...d.data() }));
                setUsers(uList);
                const savedId = localStorage.getItem('nexus_user_id');
                if (savedId && !currentUser) {
                    const found = uList.find(u => u.id === savedId);
                    if (found) {
                        setCurrentUser(found);
                        if (found.favorites) setFavorites(found.favorites);
                    }
                }
                });

                const orderUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => {
                const ordersList = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                setOrders(ordersList);
                });

                const setUnsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), (s) => {
                if (!s.empty) {
                    const d = s.docs[0].data();
                    const merged = { ...defaultSettings, ...d };
                    if (!merged.categories || !Array.isArray(merged.categories)) merged.categories = defaultSettings.categories;
                    if (!merged.aboutUsText) merged.aboutUsText = defaultSettings.aboutUsText;
                    if (!merged.markupPercentage) merged.markupPercentage = 6.50;
                    setSettings(merged);
                    setTempSettings(merged);
                    setAboutText(merged.aboutUsText);
                } else {
                    addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), defaultSettings);
                }
                setIsSyncing(false);
                });
                return () => { prodUnsub(); userUnsub(); orderUnsub(); setUnsub(); };
            }, [systemUser]);

            useEffect(() => {
                if (currentUser && orders.length > 0) {
                setUserOrders(orders.filter(o => o.userId === currentUser.id));
                const pending = orders.find(o => o.userId === currentUser.id && o.status === 'Pendiente');
                setPendingOrderRecover(pending || null);
                }
            }, [currentUser, orders]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatMessages, isChatOpen]);

            // --- HELPERS ---
            const isValidDNI = (dni) => /^\d{7,8}$/.test(dni);
            const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            const isValidPhone = (phone) => /^\d{10,}$/.test(phone); 
            const isValidOperationId = (id) => /^\d{11,12}$/.test(id);

            const isAdmin = (email) => {
                if (!email) return false;
                const adminList = settings.admins ? settings.admins.split(',').map(e => e.trim().toLowerCase()) : [];
                return adminList.includes(email.toLowerCase());
            };
            
            const calculatePrice = (basePrice) => Math.ceil(Number(basePrice) * (1 + settings.markupPercentage / 100));
            
            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); alert("¡Copiado!"); } 
                catch (err) { console.error(err); }
                document.body.removeChild(textArea);
            };

            // --- ACTIONS ---
            const toggleFavorite = async (productId) => {
                let newFavs;
                if (favorites.includes(productId)) newFavs = favorites.filter(id => id !== productId);
                else newFavs = [...favorites, productId];
                setFavorites(newFavs);
                if (currentUser) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), { favorites: newFavs });
                else localStorage.setItem('nexus_favs', JSON.stringify(newFavs));
            };

            const performAuth = async (isRegister) => {
                setAuthError(''); 
                if (isRegister) {
                    if (!registerData.name || !registerData.dni || !registerData.email || !registerData.password || !registerData.phone) return setAuthError("Completa todos los campos.");
                    if (!isValidDNI(registerData.dni)) return setAuthError("DNI inválido (debe ser un número de 7 u 8 dígitos).");
                    if (!isValidEmail(registerData.email)) return setAuthError("Email inválido.");
                    if (!isValidPhone(registerData.phone)) return setAuthError("Teléfono inválido (solo números, mín 10 dígitos).");
                    if (registerData.password.length < 8) return setAuthError("La contraseña debe tener al menos 8 caracteres.");
                } else {
                    if (!loginData.email || !loginData.password) return setAuthError("Ingresa email y contraseña.");
                }

                setIsSyncing(true);
                try {
                if (isRegister) {
                    if (users.find(u => u.email === registerData.email)) {
                        setAuthError("Este email ya está registrado. Intenta iniciar sesión.");
                        setIsSyncing(false);
                        return;
                    }
                    const newUser = { ...registerData, role: 'user', joinDate: new Date().toISOString(), favorites: [] };
                    const ref = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), newUser);
                    setCurrentUser({ ...newUser, id: ref.id });
                    localStorage.setItem('nexus_user_id', ref.id);
                } else {
                    const u = users.find(u => u.email === loginData.email && u.password === loginData.password);
                    if (u) {
                    setCurrentUser(u);
                    localStorage.setItem('nexus_user_id', u.id);
                    if (u.favorites) setFavorites(u.favorites);
                    } else {
                    setAuthError("Usuario no encontrado o contraseña incorrecta.");
                    setIsSyncing(false);
                    return;
                    }
                }
                setView('store');
                setIsMenuOpen(false);
                setAuthError('');
                } catch (e) { setAuthError("Error de conexión: " + e.message); }
                setIsSyncing(false);
            };

            const onLoginSubmit = (e) => { e.preventDefault(); performAuth(false); };
            const onRegisterSubmit = (e) => { e.preventDefault(); performAuth(true); };

            const handleLogout = () => {
                localStorage.removeItem('nexus_user_id');
                localStorage.removeItem('nexus_cart'); 
                setCurrentUser(null);
                setView('store');
                setCart([]); 
                setFavorites([]);
                setShowLogoutConfirm(false);
                setIsMenuOpen(false);
            };

            const manageCart = (prod, delta) => {
                const idx = cart.findIndex(i => i.product.id === prod.id);
                if (idx === -1 && delta > 0) {
                if (prod.stock < 1) return alert("Sin stock");
                setCart([...cart, { product: prod, quantity: 1 }]);
                } else if (idx !== -1) {
                const newCart = [...cart];
                const newQty = newCart[idx].quantity + delta;
                if (newQty <= 0) setCart(cart.filter((_, i) => i !== idx));
                else if (newQty <= prod.stock) {
                    newCart[idx].quantity = newQty;
                    setCart(newCart);
                } else alert("Stock insuficiente");
                }
            };
            
            const cartTotal = cart.reduce((acc, item) => acc + (calculatePrice(item.product.basePrice) * item.quantity), 0);

            const handleGoToMP = async () => {
                if (!checkoutData.address || !checkoutData.city || !checkoutData.zipCode || !checkoutData.transferHolder) return alert("Por favor completa todos los campos.");
                setIsSyncing(true);
                try {
                    const newOrder = {
                        orderId: `ORD-${Math.floor(Math.random()*100000)}`,
                        userId: currentUser.id, userName: currentUser.name, userEmail: currentUser.email,
                        total: cartTotal, items: cart,
                        date: new Date().toISOString(), displayDate: new Date().toLocaleString(),
                        shippingAddress: `${checkoutData.address}, ${checkoutData.city}, ${checkoutData.province}`,
                        zipCode: checkoutData.zipCode, references: checkoutData.references || '',
                        paymentMethod: `Mercado Pago (Transferencia)`, transferHolder: checkoutData.transferHolder,
                        status: 'Pendiente', paymentId: '' 
                    };
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);
                    for (const item of cart) {
                        const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.product.id);
                        const pLive = products.find(p => p.id === item.product.id);
                        if (pLive) await updateDoc(pRef, { stock: Math.max(0, pLive.stock - item.quantity) });
                    }
                    setLastOrder({ ...newOrder, id: docRef.id });
                    copyToClipboard(cartTotal.toString());
                    window.open(settings.mpLink, '_blank');
                } catch(err) { alert("Error: " + err.message); }
                setIsSyncing(false);
            };

            const handleFinalizeOrder = async (e) => {
                e.preventDefault();
                if (!lastOrder?.id) return alert("No hay orden pendiente activa.");
                if (!checkoutData.paymentId) return alert("Ingresa el número de comprobante.");
                if (!isValidOperationId(checkoutData.paymentId)) return alert("El número de operación debe tener 11 o 12 dígitos numéricos reales.");

                setIsSyncing(true);
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', lastOrder.id), { status: 'Pagado', paymentId: checkoutData.paymentId });
                    setLastOrder({ ...lastOrder, status: 'Pagado', paymentId: checkoutData.paymentId });
                    setCart([]); localStorage.removeItem('nexus_cart'); 
                    setView('receipt');
                    alert("✅ ¡Compra Finalizada!");
                } catch(err) { alert("Error: " + err.message); }
                setIsSyncing(false);
            };

            const handleRecoverYes = () => {
                if (!pendingOrderRecover) return;
                setCart(pendingOrderRecover.items);
                setLastOrder(pendingOrderRecover);
                const addrParts = pendingOrderRecover.shippingAddress.split(', ');
                setCheckoutData({ ...checkoutData, address: addrParts[0]||'', city: addrParts[1]||'', province: addrParts[2]||'Santa Fe', zipCode: pendingOrderRecover.zipCode, transferHolder: pendingOrderRecover.transferHolder });
                setView('checkout');
                setPendingOrderRecover(null); 
            };

            const handleRecoverNo = async () => {
                if (!pendingOrderRecover) return;
                setIsSyncing(true);
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', pendingOrderRecover.id));
                    for (const item of pendingOrderRecover.items) {
                        const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.product.id);
                        const pLive = products.find(p => p.id === item.product.id);
                        if (pLive) await updateDoc(pRef, { stock: pLive.stock + item.quantity });
                    }
                    setPendingOrderRecover(null);
                    alert("Orden cancelada.");
                } catch(err) { alert("Error: " + err.message); }
                setIsSyncing(false);
            };

            const handleImage = (e) => {
                const f = e.target.files[0];
                if (f && f.size < 1000000) {
                    const r = new FileReader();
                    r.onload = () => setNewProduct(prev => ({...prev, image: r.result}));
                    r.readAsDataURL(f);
                } else alert("Imagen muy pesada (<1MB)");
            };

            const handleLogoUpload = (e) => {
                const f = e.target.files[0];
                if (f && f.size < 700000) {
                    const r = new FileReader();
                    r.onload = () => setTempSettings(prev => ({...prev, logoUrl: r.result}));
                    r.readAsDataURL(f);
                } else alert("Logo muy pesado (<700kb)");
            };

            const handleHeroUpload = (e) => {
                const f = e.target.files[0];
                if (f && f.size < 1000000) {
                    const r = new FileReader();
                    r.onload = () => setTempSettings(prev => ({...prev, heroUrl: r.result}));
                    r.readAsDataURL(f);
                } else alert("Imagen muy pesada (<1MB)");
            };
            
            const saveProduct = async () => {
                if (!newProduct.name || !newProduct.basePrice) return alert("Faltan datos");
                setIsSyncing(true);
                const pData = { 
                    ...newProduct, 
                    basePrice: Number(newProduct.basePrice), 
                    stock: Number(newProduct.stock),
                    image: newProduct.image || 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=500'
                };
                if (editingId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', editingId), pData);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), pData);
                
                setNewProduct({ name: '', basePrice: '', category: '', image: '', description: '', stock: '' });
                setEditingId(null);
                if (fileInputRef.current) fileInputRef.current.value = "";
                setIsSyncing(false);
            };

            const handleDeleteOrder = async (orderId) => {
                if(!confirm("¿Borrar este registro de compra?")) return;
                setIsSyncing(true);
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId));
                } catch(err) { alert(err.message); }
                setIsSyncing(false);
            };

            const deleteProd = async () => {
                if (!productToDelete) return;
                setIsSyncing(true);
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', productToDelete.id));
                setProductToDelete(null);
                setIsSyncing(false);
            };

            const saveSettings = async () => {
                setIsSyncing(true);
                try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'settings'));
                const s = await getDocs(q);
                const data = { ...tempSettings, aboutUsText: aboutText };
                if (!s.empty) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', s.docs[0].id), data);
                else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), data);
                alert("Configuración guardada.");
                } catch (err) { alert("Error: " + err.message); }
                setIsSyncing(false);
            };

            const sendChat = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                const msg = chatInput;
                setChatMessages(p => [...p, { role: 'user', text: msg }]);
                setChatInput('');
                setIsChatLoading(true);
                const ctx = products.map(p => `${p.name} ($${calculatePrice(p.basePrice)})`).join(', ');
                const prompt = `Eres "Sustore AI", asistente experto. Inventario: ${ctx}. Cliente: "${msg}". Responde en español, amigable y experto.`;
                const ans = await callGemini(prompt);
                setChatMessages(p => [...p, { role: 'ai', text: ans }]);
                setIsChatLoading(false);
            };

            const goIg = () => window.open(`https://www.instagram.com/${settings.instagramUser}/`, '_blank');
            const goWsp = () => window.open(settings.whatsappLink, '_blank');

            const addCategory = () => {
                if(newCategory && !tempSettings.categories.includes(newCategory)) {
                    setTempSettings({...tempSettings, categories: [...tempSettings.categories, newCategory]});
                    setNewCategory('');
                }
            };
            const removeCategory = (cat) => setTempSettings({...tempSettings, categories: tempSettings.categories.filter(c => c !== cat)});
            const handleCancelEdit = () => { setNewProduct({ name: '', basePrice: '', category: '', image: '', description: '', stock: '' }); setEditingId(null); if(fileInputRef.current) fileInputRef.current.value = ""; };
            const handleEditProduct = (product) => { setNewProduct({ ...product, basePrice: product.basePrice }); setEditingId(product.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const initiateDelete = (product) => setProductToDelete(product);

            const Loading = () => (
                <div className="fixed inset-0 bg-slate-900/90 z-[100] flex flex-col items-center justify-center backdrop-blur-sm">
                <RefreshCw className="w-12 h-12 text-cyan-500 animate-spin mb-4"/>
                <p className="text-cyan-400 text-sm font-bold tracking-[0.2em] animate-pulse">CARGANDO SISTEMA...</p>
                </div>
            );

            const isCheckoutValid = checkoutData.address && checkoutData.city && checkoutData.zipCode && checkoutData.transferHolder;

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 font-sans overflow-x-hidden pb-24">
                <style>{customStyles}</style>
                {isSyncing && <Loading />}

                {/* ALERT RECUPERACIÓN */}
                {pendingOrderRecover && (
                    <div className="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-up">
                        <div className="bg-slate-800 border border-yellow-500/50 p-6 rounded-2xl shadow-2xl max-w-md w-full text-center">
                            <AlertTriangle className="w-12 h-12 text-yellow-500 mx-auto mb-4 animate-bounce"/>
                            <h3 className="text-xl font-bold text-white mb-2">¡Compra Pendiente!</h3>
                            <p className="text-slate-400 mb-6 text-sm">Dejaste un pago de <strong>${pendingOrderRecover.total.toLocaleString()}</strong> sin confirmar. ¿Deseas retomarlo?</p>
                            <div className="flex gap-3">
                                <button onClick={handleRecoverNo} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-xl font-bold transition">No, descartar</button>
                                <button onClick={handleRecoverYes} className="flex-1 py-3 bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl font-bold transition">Sí, continuar</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* HEADER */}
                <header className="fixed top-0 w-full z-40 header-dark h-16 flex items-center justify-between px-4 lg:px-8 shadow-lg">
                    <div className="flex items-center gap-4 flex-1">
                    <div onClick={() => setView('store')} className="cursor-pointer">
                        {settings.logoUrl ? <img src={settings.logoUrl} className="h-10 w-10 logo-circle object-cover border-2 border-cyan-500/30"/> : <SustoreLogo />}
                    </div>
                    <div className="hidden md:flex items-center search-bar-dark rounded-full px-4 py-2 w-full max-w-md">
                        <Search className="w-4 h-4 mr-2" />
                        <input className="bg-transparent border-none outline-none text-sm w-full search-input" placeholder="Buscar productos..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                    </div>
                    </div>

                    <div className="flex items-center gap-3 sm:gap-5">
                    <button onClick={goWsp} className="text-green-400 hover:text-green-300 transition hover:scale-110"><MessageCircle className="w-6 h-6"/></button>
                    <button onClick={goIg} className="text-pink-400 hover:text-pink-300 transition hover:scale-110"><Instagram className="w-6 h-6"/></button>
                    
                    <button onClick={() => setView('favorites')} className="text-slate-400 hover:text-red-400 transition relative">
                        <Heart className={`w-6 h-6 ${favorites.length > 0 ? 'fill-red-500 text-red-500' : ''}`} />
                    </button>
                    
                    <button onClick={() => setView('cart')} className="relative text-slate-300 hover:text-cyan-400 transition">
                        <ShoppingBag className="w-6 h-6" />
                        {cart.length > 0 && <span className="absolute -top-1 -right-1 bg-green-500 text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center border border-slate-900">{cart.length}</span>}
                    </button>

                    {currentUser ? (
                        <div onClick={() => setView('profile')} className="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold text-xs cursor-pointer hover:bg-cyan-500 relative border border-cyan-400/30">
                            {currentUser.name.charAt(0).toUpperCase()}
                        </div>
                    ) : (
                        <button onClick={() => setView('login')} className="text-slate-300 hover:text-white"><User className="w-6 h-6"/></button>
                    )}

                    <button onClick={() => setIsMenuOpen(true)} className="text-slate-300 hover:text-white ml-2">
                        <Menu className="w-7 h-7" />
                    </button>
                    </div>
                </header>
                <div className="h-16"></div>

                {/* MENU LATERAL */}
                {isMenuOpen && (
                    <div className="fixed inset-0 z-[60] flex justify-end animate-fade-up">
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsMenuOpen(false)}></div>
                    <div className="relative bg-slate-800 w-72 h-full shadow-2xl flex flex-col border-l border-slate-700">
                        <div className="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-900">
                        <span className="font-bold text-lg text-white tracking-widest">MENÚ</span>
                        <button onClick={() => setIsMenuOpen(false)}><X className="text-slate-400 hover:text-white"/></button>
                        </div>
                        
                        <div className="p-4 space-y-2 overflow-y-auto flex-1">
                        <button onClick={() => { setView('store'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><Home className="w-5 h-5"/> Inicio</button>
                        <button onClick={() => { setView('about'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><Info className="w-5 h-5"/> Sobre Nosotros</button>
                        <button onClick={() => { setView('favorites'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><Heart className="w-5 h-5"/> Favoritos</button>
                        
                        {/* CATEGORÍAS EN EL MENÚ */}
                        <div className="pt-2 pb-2 border-t border-slate-700 mt-2">
                            <p className="text-xs text-slate-500 uppercase font-bold px-3 mb-2">Categorías</p>
                            {settings.categories.map(cat => (
                                <button key={cat} onClick={() => { setSearchQuery(''); setSelectedCategory(cat); setView('store'); setIsMenuOpen(false); }} className="w-full text-left px-3 py-2 rounded hover:bg-white/5 text-sm text-slate-400 hover:text-cyan-400 flex items-center gap-2 transition">
                                    <Tag className="w-3 h-3"/> {cat}
                                </button>
                            ))}
                        </div>

                        {currentUser && <button onClick={() => { setView('profile'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded hover:bg-white/5 flex gap-3 text-slate-300 hover:text-white font-medium"><ShoppingBag className="w-5 h-5"/> Mis Compras</button>}
                        {currentUser && isAdmin(currentUser.email) && <button onClick={() => { setView('admin'); setIsMenuOpen(false); }} className="w-full text-left p-3 rounded bg-purple-900/20 text-purple-300 font-bold flex gap-3 border border-purple-500/30 mt-2"><Database className="w-5 h-5"/> PANEL ADMIN</button>}
                        </div>
                        {currentUser && (
                        <div className="p-5 border-t border-slate-700 bg-slate-900">
                            <button onClick={() => setShowLogoutConfirm(true)} className="w-full py-2 border border-red-500/30 text-red-400 rounded-lg text-sm font-bold hover:bg-red-500/10">Cerrar Sesión</button>
                        </div>
                        )}
                    </div>
                    </div>
                )}

                {/* LOGOUT MODAL */}
                {showLogoutConfirm && (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 p-4 animate-fade-up">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-700 text-center">
                        <h3 className="font-bold text-lg mb-4 text-white">¿Cerrar Sesión?</h3>
                        <div className="flex gap-3">
                        <button onClick={() => setShowLogoutConfirm(false)} className="flex-1 py-2 bg-slate-700 rounded-lg text-slate-200 font-bold">Cancelar</button>
                        <button onClick={handleLogout} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Salir</button>
                        </div>
                    </div>
                    </div>
                )}

                {/* PRODUCT DELETE MODAL */}
                {productToDelete && (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/70 p-4 animate-fade-up">
                    <div className="bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-red-500/50 text-center">
                        <AlertOctagon className="w-12 h-12 text-red-500 mx-auto mb-4"/>
                        <h3 className="font-bold text-lg mb-2 text-white">Eliminar Producto</h3>
                        <p className="text-slate-400 mb-6 text-sm">¿Estás seguro? "{productToDelete.name}" se borrará para siempre.</p>
                        <div className="flex gap-3">
                        <button onClick={() => setProductToDelete(null)} className="flex-1 py-2 bg-slate-700 rounded-lg text-slate-200 font-bold">Cancelar</button>
                        <button onClick={deleteProd} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold">Eliminar</button>
                        </div>
                    </div>
                    </div>
                )}

                {/* HOME STORE */}
                {view === 'store' && (
                    <main className="animate-fade-up">
                    {/* HERO */}
                    <div className="relative h-[500px] flex items-center justify-center overflow-hidden bg-slate-900">
                        <div className="absolute inset-0 bg-cover bg-center opacity-60" style={{ backgroundImage: `url('${settings.heroUrl || "https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1920&auto=format&fit=crop"}')` }}></div>
                        <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                        <div className="relative z-10 text-center px-4">
                        <span className="bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 text-xs font-bold px-4 py-1 rounded-full uppercase tracking-widest mb-4 inline-block backdrop-blur-sm">Tecnología</span>
                        <h1 className="text-5xl md:text-7xl font-extrabold text-white mb-6 drop-shadow-lg tracking-tight">NEXT LEVEL</h1>
                        <button onClick={() => document.getElementById('products').scrollIntoView({behavior:'smooth'})} className="bg-white text-slate-900 px-8 py-3 rounded-full font-bold shadow-xl hover:scale-105 transition">VER CATÁLOGO</button>
                        </div>
                    </div>
                    
                    <div id="products" className="max-w-7xl mx-auto px-4 py-16">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex items-center gap-4">
                                <div className="h-8 w-1 bg-cyan-500 rounded-full"></div>
                                <h2 className="text-2xl font-bold text-white">
                                    {selectedCategory ? `Categoría: ${selectedCategory}` : 'Novedades'}
                                </h2>
                            </div>
                            {selectedCategory && (
                                <button onClick={() => setSelectedCategory('')} className="text-xs text-red-400 hover:text-red-300 flex items-center gap-1"><XCircle className="w-4 h-4"/> Borrar Filtro</button>
                            )}
                        </div>
                        
                        {products.length === 0 ? (
                            <div className="text-center py-20 text-slate-500 border border-dashed border-slate-700 rounded-2xl">
                                <p>No hay productos cargados aún.</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            {products
                                .filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()))
                                .filter(p => !selectedCategory || p.category === selectedCategory)
                                .map(p => (
                                <div key={p.id} className="bg-slate-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-cyan-500/10 transition group border border-slate-700/50 relative">
                                <div className="h-64 overflow-hidden relative bg-slate-900">
                                    <img src={p.image} className={`w-full h-full object-cover transition duration-500 ${p.stock > 0 ? 'group-hover:scale-110' : 'grayscale opacity-50'}`}/>
                                    
                                    {/* BOTON FAVORITO */}
                                    <button 
                                        onClick={() => toggleFavorite(p.id)} 
                                        className="absolute top-3 right-3 p-2 rounded-full bg-slate-900/50 backdrop-blur-sm hover:bg-white/20 transition z-20"
                                    >
                                        <Heart className={`w-5 h-5 ${favorites.includes(p.id) ? 'fill-red-500 text-red-500' : 'text-white'}`} />
                                    </button>

                                    {p.stock <= 0 && <div className="absolute inset-0 bg-black/70 flex items-center justify-center"><span className="text-white font-bold bg-red-600 px-3 py-1 rounded uppercase text-xs tracking-wider">AGOTADO</span></div>}
                                    {p.stock > 0 && <button onClick={() => manageCart(p, 1)} className="absolute bottom-3 right-3 bg-white text-slate-900 p-3 rounded-full shadow-lg opacity-0 group-hover:opacity-100 translate-y-2 group-hover:translate-y-0 transition hover:bg-cyan-400"><Plus className="w-5 h-5"/></button>}
                                </div>
                                <div className="p-5">
                                    <p className="text-[10px] text-cyan-400 font-bold uppercase mb-1 tracking-wider">{p.category}</p>
                                    <h3 className="font-bold text-white text-lg truncate mb-2">{p.name}</h3>
                                    <div className="flex justify-between items-end">
                                    <span className="text-xl font-bold text-white">${calculatePrice(p.basePrice).toLocaleString()}</span>
                                    <span className={`text-[10px] px-2 py-1 rounded ${p.stock > 0 ? 'bg-green-900/30 text-green-400 border border-green-900' : 'bg-red-900/30 text-red-400 border border-red-900'}`}>{p.stock > 0 ? 'Stock Disponible' : 'Sin Stock'}</span>
                                    </div>
                                </div>
                                </div>
                            ))}
                            </div>
                        )}
                    </div>
                    </main>
                )}

                {/* VISTA: FAVORITOS */}
                {view === 'favorites' && (
                    <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                        <h2 className="text-2xl font-bold text-white mb-8 flex items-center gap-2"><Heart className="text-red-500 fill-red-500"/> Mis Favoritos</h2>
                        {favorites.length === 0 ? (
                            <p className="text-slate-500 text-center py-10 border border-dashed border-slate-700 rounded-xl">No tienes productos en favoritos.</p>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                {products.filter(p => favorites.includes(p.id)).map(p => (
                                    <div key={p.id} className="bg-slate-800 rounded-2xl overflow-hidden shadow-lg border border-slate-700/50 relative">
                                        <div className="h-48 overflow-hidden relative bg-slate-900">
                                            <img src={p.image} className="w-full h-full object-cover"/>
                                            <button onClick={() => toggleFavorite(p.id)} className="absolute top-2 right-2 p-2 bg-black/50 rounded-full text-red-500 hover:bg-white hover:text-red-600 transition"><X className="w-4 h-4"/></button>
                                        </div>
                                        <div className="p-4">
                                            <h3 className="font-bold text-white truncate">{p.name}</h3>
                                            <p className="text-cyan-400 font-bold mt-1">${calculatePrice(p.basePrice).toLocaleString()}</p>
                                            <button onClick={() => manageCart(p, 1)} className="w-full mt-3 bg-slate-700 text-white py-2 rounded-lg hover:bg-cyan-600 transition text-sm font-bold">Agregar al Carrito</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}

                {/* LOGIN / REGISTRO */}
                {(view === 'login' || view === 'register') && (
                    <div className="flex items-center justify-center min-h-[80vh] px-4 animate-fade-up">
                    <div className="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-700 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-cyan-500 to-blue-500"></div>
                        <h2 className="text-2xl font-bold text-center text-white mb-6">{view === 'login' ? 'Bienvenido' : 'Crear Cuenta'}</h2>
                        
                        {authError && <div className="bg-red-500/10 border border-red-500/50 text-red-200 p-3 rounded-lg mb-4 text-sm flex items-center gap-2"><AlertCircle className="w-4 h-4"/> {authError}</div>}
                        
                        <form onSubmit={view === 'login' ? onLoginSubmit : onRegisterSubmit} className="space-y-4">
                            {view === 'register' && (
                                <>
                                <input className="w-full input-white p-3" placeholder="Nombre Completo" value={registerData.name} onChange={e => setRegisterData({...registerData, name: e.target.value})}/>
                                <input className="w-full input-white p-3" placeholder="DNI (Sin puntos)" value={registerData.dni} onChange={e => setRegisterData({...registerData, dni: e.target.value})}/>
                                </>
                            )}
                            <input className="w-full input-white p-3" placeholder="Email" value={view === 'login' ? loginData.email : registerData.email} onChange={e => view === 'login' ? setLoginData({...loginData, email: e.target.value}) : setRegisterData({...registerData, email: e.target.value})}/>
                            {view === 'register' && <input className="w-full input-white p-3" placeholder="Teléfono" value={registerData.phone} onChange={e => setRegisterData({...registerData, phone: e.target.value})}/>}
                            <input className="w-full input-white p-3" type="password" placeholder="Contraseña" value={view === 'login' ? loginData.password : registerData.password} onChange={e => view === 'login' ? setLoginData({...loginData, password: e.target.value}) : setRegisterData({...registerData, password: e.target.value})}/>
                            
                            <button className="w-full bg-cyan-600 text-white py-3.5 rounded-lg font-bold hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/20">{view === 'login' ? 'INGRESAR' : 'REGISTRARSE'}</button>
                        </form>
                        
                        <button onClick={() => { setView(view === 'login' ? 'register' : 'login'); setAuthError(''); }} className="w-full text-center text-slate-400 text-sm mt-6 hover:text-white transition">
                            {view === 'login' ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Ingresa'}
                        </button>
                    </div>
                    </div>
                )}

                {/* CHECKOUT */}
                {view === 'checkout' && currentUser && (
                    <div className="max-w-md mx-auto px-4 py-12 animate-fade-up">
                        <button onClick={() => setView('cart')} className="mb-6 text-slate-400 hover:text-white flex items-center"><ArrowRight className="w-4 h-4 rotate-180 mr-1"/> Volver</button>
                        
                        <div className="bg-white p-6 rounded-2xl shadow-xl text-slate-900 deposit-card">
                            <h2 className="text-2xl font-bold text-center mb-1">Depositar</h2>
                            <p className="text-center text-slate-500 text-sm mb-6">A través de Mercado Pago</p>
                            
                            {/* SUMMARY */}
                            <div className="mb-4 text-xs text-slate-500 border-b pb-2 border-slate-100 max-h-32 overflow-y-auto">
                                {cart.map((i, idx) => (
                                    <div key={idx} className="flex items-center gap-3 mb-2">
                                        <img src={i.product.image} className="w-8 h-8 rounded object-cover border border-slate-200"/>
                                        <div className="flex-1">
                                            <p className="font-bold text-slate-800 truncate">{i.product.name}</p>
                                            <p className="text-xs text-slate-500">{i.quantity} x ${calculatePrice(i.product.basePrice).toLocaleString()}</p>
                                        </div>
                                        <span className="font-bold text-slate-900">${(calculatePrice(i.product.basePrice) * i.quantity).toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>

                            <div className="bg-slate-50 p-4 rounded-xl mb-6 text-center border border-slate-200">
                                <p className="text-xs text-slate-500 uppercase font-bold mb-1 tracking-wide">Total a Pagar</p>
                                <div className="text-4xl font-extrabold text-slate-900">${cartTotal.toLocaleString()}</div>
                            </div>

                            <form onSubmit={handleFinalizeOrder} className="space-y-3">
                            <input className="w-full input-white p-3 bg-slate-50 border-slate-200" placeholder="Dirección de Envío" value={checkoutData.address} onChange={e => setCheckoutData({...checkoutData, address: e.target.value})} required/>
                            <div className="grid grid-cols-2 gap-3">
                                <input className="w-full input-white p-3 bg-slate-50 border-slate-200" placeholder="Ciudad" value={checkoutData.city} onChange={e => setCheckoutData({...checkoutData, city: e.target.value})} required/>
                                <input className="w-full input-white p-3 bg-slate-50 border-slate-200" placeholder="CP" value={checkoutData.zipCode} onChange={e => setCheckoutData({...checkoutData, zipCode: e.target.value})} required/>
                            </div>
                            <input className="w-full input-white p-3 bg-slate-50 border-slate-200" placeholder="Titular Transferencia" value={checkoutData.transferHolder} onChange={e => setCheckoutData({...checkoutData, transferHolder: e.target.value})} required/>

                            <button type="button" onClick={handleGoToMP} disabled={!isCheckoutValid} className={`w-full py-3.5 text-lg font-bold rounded-xl shadow-lg transition flex justify-center items-center gap-2 ${isCheckoutValid ? 'bg-[#009EE3] hover:brightness-110 text-white' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}>
                                PAGAR CON MERCADO PAGO
                            </button>

                            {lastOrder && lastOrder.status === 'Pendiente' && (
                                <div className="mt-6 pt-6 border-t border-slate-100 animate-fade-up">
                                    <label className="block text-xs font-bold text-slate-500 mb-2 text-center uppercase tracking-wide">Confirmación de Pago</label>
                                    <input className="w-full input-white p-3 text-center font-mono text-lg border-2 border-slate-200 focus:border-green-500" placeholder="Ingresa ID de Operación" value={checkoutData.paymentId} onChange={e => setCheckoutData({...checkoutData, paymentId: e.target.value})} required/>
                                    <button className="w-full mt-3 py-3 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 transition">CONFIRMAR ID</button>
                                </div>
                            )}
                            </form>
                        </div>
                    </div>
                )}

                {/* VIEW: SOBRE NOSOTROS */}
                {view === 'about' && (
                    <div className="max-w-4xl mx-auto px-4 py-12 animate-fade-up">
                        <h2 className="text-3xl font-bold mb-6 text-white flex items-center gap-3"><Info className="text-cyan-400"/> Sobre Nosotros</h2>
                        <div className="bg-slate-800 p-8 rounded-3xl border border-cyan-500/20 shadow-2xl neon-border">
                            <p className="text-slate-300 text-lg leading-relaxed whitespace-pre-wrap">{settings.aboutUsText}</p>
                        </div>
                    </div>
                )}

                {/* CART */}
                {view === 'cart' && (
                    <div className="max-w-2xl mx-auto px-4 py-12 animate-fade-up">
                        <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><ShoppingBag className="text-cyan-400"/> Carrito</h2>
                        {cart.length === 0 ? <p className="text-slate-500 text-center py-10 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">Tu carrito está vacío.</p> : (
                        <div className="space-y-4">
                            {cart.map((item, i) => (
                                <div key={i} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-4">
                                    <img src={item.product.image} className="w-16 h-16 object-cover rounded-lg"/>
                                    <div className="flex-1">
                                    <h4 className="text-white font-bold">{item.product.name}</h4>
                                    <p className="text-cyan-400 font-bold">${calculatePrice(item.product.basePrice).toLocaleString()}</p>
                                    </div>
                                    <div className="flex items-center gap-3 bg-slate-900 rounded-lg p-1.5 border border-slate-700">
                                    <button onClick={()=>manageCart(item.product, -1)} className="text-slate-400 hover:text-white"><Minus className="w-4 h-4"/></button>
                                    <span className="text-white font-bold w-4 text-center">{item.quantity}</span>
                                    <button onClick={()=>manageCart(item.product, 1)} className="text-slate-400 hover:text-white"><Plus className="w-4 h-4"/></button>
                                    </div>
                                </div>
                            ))}
                            <div className="mt-8 p-6 bg-slate-800 rounded-2xl border border-slate-700 flex justify-between items-center shadow-lg">
                                <div><p className="text-slate-400 text-xs uppercase">Total Estimado</p><span className="text-2xl font-bold text-white">${cartTotal.toLocaleString()}</span></div>
                                <button onClick={()=>{if(!currentUser){alert("Inicia sesión para comprar");setView('login')}else setView('checkout')}} className="bg-cyan-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/20">PAGAR</button>
                            </div>
                        </div>
                        )}
                    </div>
                )}

                {view === 'profile' && currentUser && (
                    <div className="max-w-3xl mx-auto px-4 py-12 animate-fade-up">
                        <div className="bg-slate-800 p-8 rounded-3xl border border-slate-700 mb-10 flex items-center gap-6 shadow-lg">
                        <div className="w-20 h-20 bg-cyan-600 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-inner">{currentUser.name[0]}</div>
                        <div><h2 className="text-2xl font-bold text-white">{currentUser.name}</h2><p className="text-slate-400">{currentUser.email}</p></div>
                        </div>
                        <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><ShoppingBag className="text-purple-400"/> Mis Compras</h3>
                        <div className="space-y-4">
                        {userOrders.length === 0 ? <p className="text-slate-500">No hay compras registradas.</p> : userOrders.map(o => (
                            <div key={o.orderId} className="bg-slate-800 p-5 rounded-2xl border border-slate-700">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-4">
                                    <div>
                                    <span className="bg-slate-700 text-white text-xs px-2 py-0.5 rounded mr-2">#{o.orderId}</span>
                                    <span className="text-xs text-slate-400">{o.displayDate}</span>
                                    </div>
                                    <span className={`text-xs px-3 py-1 rounded-full font-bold ${o.status === 'Pagado' ? 'bg-green-900/30 text-green-400 border border-green-900' : 'bg-yellow-900/30 text-yellow-400 border border-yellow-900'}`}>{o.status}</span>
                                </div>
                                
                                {/* LISTA DE PRODUCTOS EN EL HISTORIAL */}
                                <div className="space-y-3 mb-4">
                                    {o.items.map((item, idx) => (
                                    <div key={idx} className="flex items-center gap-3">
                                        <img src={item.product.image} className="w-10 h-10 rounded object-cover bg-slate-900"/>
                                        <div className="flex-1">
                                            <p className="text-white text-sm font-bold">{item.product.name}</p>
                                            <p className="text-xs text-slate-500">{item.quantity} x ${calculatePrice(item.product.basePrice).toLocaleString()}</p>
                                        </div>
                                        <p className="text-white font-bold text-sm">${(calculatePrice(item.product.basePrice) * item.quantity).toLocaleString()}</p>
                                    </div>
                                    ))}
                                </div>
                                
                                <div className="text-right border-t border-slate-700 pt-3 flex justify-between items-center">
                                    <span className="text-slate-400 text-xs">ID Pago: {o.paymentId || 'Pendiente'}</span>
                                    <p className="text-lg font-bold text-white">Total: ${o.total.toLocaleString()}</p>
                                </div>
                            </div>
                        ))}
                        </div>
                    </div>
                )}
                
                {/* ADMIN */}
                {view === 'admin' && isAdmin(currentUser?.email) && (
                    <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                        <div className="flex justify-between items-end mb-8 bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <div><h2 className="text-3xl font-bold text-white mb-1">Panel de Control</h2><p className="text-slate-400 text-sm">Gestión de Sustore</p></div>
                            <div className="flex gap-3">
                                <button onClick={() => setView('sales_report')} className="bg-purple-900/30 border border-purple-500/30 text-purple-300 px-4 py-2 rounded-lg font-bold text-sm hover:bg-purple-900/50 transition flex items-center gap-2"><FileText className="w-4 h-4"/> Ventas</button>
                                <button onClick={() => setView('store')} className="bg-slate-700 text-slate-200 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-600 transition">Salir</button>
                            </div>
                        </div>
                        <div className="grid lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 space-y-8">
                                <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 relative overflow-hidden">
                                    <h3 className="font-bold text-white mb-6 flex gap-2 items-center text-lg">{editingId ? 'Editar Producto' : 'Nuevo Producto'}</h3>
                                    {editingId && <button onClick={handleCancelEdit} className="text-red-400 text-xs mb-2 underline">Cancelar Edición</button>}
                                    <div className="grid md:grid-cols-2 gap-5">
                                        <div className="md:col-span-2">
                                        <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Nombre</label>
                                        <input className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Costo Base</label>
                                            <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.basePrice} onChange={e => setNewProduct({...newProduct, basePrice: e.target.value})}/>
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Stock</label>
                                            <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.stock} onChange={e => setNewProduct({...newProduct, stock: e.target.value})}/>
                                        </div>
                                        <div className="md:col-span-2">
                                        <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Categoría</label>
                                        <select className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white focus:border-cyan-500 transition" value={newProduct.category} onChange={(e) => setNewProduct({...newProduct, category: e.target.value})}>
                                            <option value="">Seleccionar...</option>
                                            {settings.categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                        </select>
                                        </div>
                                        <div className="col-span-2">
                                            <label className="text-xs text-slate-400 font-bold uppercase ml-1 mb-1 block">Imagen</label>
                                            <input type="file" ref={fileInputRef} onChange={handleImage} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-slate-700 file:text-white hover:file:bg-cyan-600 cursor-pointer"/>
                                        </div>
                                    </div>
                                    <button onClick={saveProduct} className="w-full mt-6 py-3 rounded-xl font-bold text-white bg-cyan-600 hover:bg-cyan-500 shadow-lg transition">{editingId ? 'Actualizar' : 'Publicar'}</button>
                                </div>
                            </div>
                            
                            <div className="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 h-fit sticky top-24">
                                <h3 className="font-bold text-white mb-6 flex items-center gap-2 text-lg"><Settings className="w-5 h-5 text-purple-400"/> Configuración</h3>
                                <div className="space-y-5">
                                <div className="pt-4 border-t border-slate-700">
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Texto "Sobre Nosotros"</label>
                                    <textarea className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-white transition h-24 text-xs" value={aboutText} onChange={(e) => setAboutText(e.target.value)} />
                                </div>
                                <div className="pt-4 border-t border-slate-700">
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Porcentaje Ganancia (%)</label>
                                    <input type="number" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-xl outline-none text-green-400 font-bold transition" value={settings.markupPercentage} onChange={(e) => setTempSettings({...tempSettings, markupPercentage: e.target.value})} />
                                </div>
                                <div className="pt-4 border-t border-slate-700">
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Logo Tienda</label>
                                    <input type="file" accept="image/*" className="text-xs text-slate-500" onChange={handleLogoUpload} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Categorías</label>
                                    <div className="flex gap-2 mb-2">
                                        <input className="w-full bg-slate-900 border border-slate-600 p-2 rounded-lg outline-none text-white text-xs" placeholder="Nueva categoría..." value={newCategory} onChange={(e) => setNewCategory(e.target.value)}/>
                                        <button onClick={addCategory} className="bg-green-600 text-white p-2 rounded-lg hover:bg-green-500"><Plus className="w-4 h-4"/></button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {settings.categories.map(cat => (
                                            <span key={cat} className="text-xs bg-slate-900 text-slate-300 px-2 py-1 rounded border border-slate-700 flex items-center gap-1">
                                                {cat}
                                                <button onClick={() => removeCategory(cat)} className="hover:text-red-400"><X className="w-3 h-3"/></button>
                                            </span>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* LISTA PRODUCTOS ADMIN (TABLA RESTAURADA) */}
                                <div className="pt-4 border-t border-slate-700">
                                    <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Gestionar Productos</label>
                                    <div className="max-h-60 overflow-y-auto rounded-lg border border-slate-700">
                                        <table className="w-full text-left text-xs text-slate-400">
                                            <thead className="bg-slate-900 text-slate-300 sticky top-0">
                                                <tr>
                                                    <th className="p-2">Img</th>
                                                    <th className="p-2">Nombre</th>
                                                    <th className="p-2">Stock</th>
                                                    <th className="p-2 text-right">Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-700">
                                                {products.map(p => (
                                                    <tr key={p.id} className="hover:bg-slate-700/50">
                                                        <td className="p-2"><img src={p.image} className="w-8 h-8 rounded object-cover"/></td>
                                                        <td className="p-2 text-white">{p.name}</td>
                                                        <td className="p-2">{p.stock}</td>
                                                        <td className="p-2 text-right flex justify-end gap-1">
                                                            <button onClick={() => handleEditProduct(p)} className="p-1 bg-blue-900/30 text-blue-400 rounded"><Edit className="w-3 h-3"/></button>
                                                            <button onClick={() => initiateDelete(p)} className="p-1 bg-red-900/30 text-red-400 rounded"><Trash2 className="w-3 h-3"/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <button onClick={saveSettings} className="bg-purple-600 text-white px-4 py-3 rounded-xl font-bold w-full hover:bg-purple-500 shadow-lg transition">Guardar Configuración</button>
                            </div>
                            </div>
                    </div>
                </div>
            )}

            {/* SALES REPORT NEON */}
            {view === 'sales_report' && isAdmin(currentUser?.email) && (
                <div className="max-w-6xl mx-auto px-4 py-12 animate-fade-up">
                    <div className="flex items-center justify-between mb-8">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setView('admin')} className="bg-slate-800 p-2 rounded-full hover:bg-slate-700 transition text-slate-300 hover:text-white"><ArrowRight className="w-5 h-5 rotate-180"/></button>
                            <h2 className="text-3xl font-bold text-white">Reporte de Ventas</h2>
                        </div>
                        <div className="flex gap-2 bg-slate-800 p-1 rounded-lg border border-white/10">
                        <button onClick={() => setActiveTab('completed')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${activeTab === 'completed' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white'}`}>COMPLETADAS</button>
                        <button onClick={() => setActiveTab('pending')} className={`px-4 py-2 rounded-lg text-xs font-bold transition ${activeTab === 'pending' ? 'bg-yellow-600 text-white' : 'text-slate-400 hover:text-white'}`}>PENDIENTES</button>
                        </div>
                    </div>
                    
                    <div className="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-900 text-cyan-400 uppercase text-xs font-bold tracking-wider"><tr><th className="p-5">Fecha</th><th className="p-5">ID Orden</th><th className="p-5">Cliente</th><th className="p-5">Monto Total</th><th className="p-5">Estado</th><th className="p-5">Acción</th></tr></thead>
                            <tbody className="divide-y divide-slate-700/50">
                                {orders.filter(o => activeTab === 'pending' ? o.status === 'Pendiente' : o.status === 'Pagado').length === 0 ? (
                                <tr><td colSpan="6" className="p-8 text-center text-slate-500 italic">No hay ventas en esta categoría.</td></tr>
                                ) : (
                                orders.filter(o => activeTab === 'pending' ? o.status === 'Pendiente' : o.status === 'Pagado').map(o => (
                                    <tr key={o.id} className="hover:bg-slate-700/30 transition">
                                        <td className="p-5 text-slate-400 font-mono text-xs">{o.displayDate}</td>
                                        <td className="p-5 font-bold text-white">{o.orderId}</td>
                                        <td className="p-5">
                                            <p className="text-white font-bold mb-1">{o.userName}</p>
                                            <p className="text-xs text-slate-400 uppercase tracking-wider">{o.transferHolder || 'Sin Dato'}</p>
                                            <p className="text-[10px] text-slate-500">{o.userEmail}</p>
                                        </td>
                                        <td className="p-5"><span className={`${o.status === 'Pagado' ? 'text-green-400' : 'text-yellow-400'} font-extrabold text-lg`}>${o.total.toLocaleString()}</span></td>
                                        <td className="p-5">
                                            {o.status === 'Pagado' ? (
                                                <span className="text-xs text-green-400 border border-green-500/30 bg-green-500/10 px-2 py-1 rounded font-mono">{o.paymentId}</span>
                                            ) : (
                                                <span className="text-xs text-yellow-400 border border-yellow-500/30 bg-yellow-500/10 px-2 py-1 rounded font-bold animate-pulse">ESPERANDO PAGO</span>
                                            )}
                                        </td>
                                        <td className="p-5">
                                            <button onClick={() => handleDeleteOrder(o.id)} className="text-red-400 hover:text-red-200 p-2 bg-red-900/20 rounded"><Trash2 className="w-4 h-4"/></button>
                                        </td>
                                    </tr>
                                ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {view === 'receipt' && lastOrder && (
                <div className="min-h-screen flex items-center justify-center p-4 animate-fade-up">
                <div className="bg-slate-800 text-slate-100 p-8 rounded-3xl shadow-2xl relative max-w-md w-full font-mono border border-slate-700">
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-green-500 to-cyan-500"></div>
                    <div className="text-center mb-8">
                    <div className="w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-2 border-green-500/50"><CheckCircle className="text-green-400 w-10 h-10" /></div>
                    <h2 className="text-2xl font-bold uppercase tracking-widest text-white mb-2">¡Pago Exitoso!</h2>
                    <p className="text-sm text-slate-400">Tu orden ha sido procesada correctamente.</p>
                    </div>
                    <button onClick={() => { setView('store'); setLastOrder(null); }} className="w-full bg-cyan-600 text-white py-4 rounded-xl font-bold hover:bg-cyan-500 transition shadow-lg uppercase tracking-wider flex items-center justify-center gap-2">
                    <ShoppingBag className="w-5 h-5"/> Volver a la Tienda
                    </button>
                </div>
                </div>
            )}

            {/* CHATBOT */}
            <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
                {isChatOpen && (
                <div className="bg-slate-800 border border-cyan-500/30 rounded-2xl shadow-2xl w-80 h-96 mb-4 flex flex-col overflow-hidden animate-fade-up">
                    <div className="bg-cyan-600 p-3 flex justify-between items-center text-white">
                    <span className="font-bold flex gap-2 items-center"><Zap className="w-4 h-4 text-yellow-300 animate-pulse"/> Asistente IA</span>
                    <button onClick={() => setIsChatOpen(false)}><X className="w-4 h-4 hover:text-slate-200"/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-900/50">
                    {chatMessages.map((m, i) => (
                        <div key={i} className={`p-3 rounded-lg text-sm max-w-[85%] shadow-sm ${m.role==='user'?'bg-cyan-600/20 ml-auto text-cyan-200 border border-cyan-500/30':'bg-slate-700 mr-auto text-slate-200 border border-slate-600'}`}>{m.text}</div>
                    ))}
                    {isChatLoading && <div className="text-xs text-cyan-400 italic animate-pulse">Escribiendo...</div>}
                    <div ref={chatEndRef}/>
                    </div>
                    <form onSubmit={sendChat} className="p-2 border-t border-cyan-500/20 flex gap-2 bg-slate-800">
                    <input className="flex-1 bg-slate-900 border border-slate-600 rounded px-3 text-sm p-2 text-white outline-none" value={chatInput} onChange={e=>setChatInput(e.target.value)} placeholder="Escribe aquí..."/>
                    <button className="p-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded transition"><Send className="w-4 h-4"/></button>
                    </form>
                </div>
                )}
                <button onClick={() => setIsChatOpen(!isChatOpen)} className="bg-cyan-500 hover:bg-cyan-400 text-white p-4 rounded-full shadow-lg hover:scale-110 transition"><MessageCircle className="w-6 h-6"/></button>
            </div>

            </div>
            );
        }

        // --- RENDERIZADO FINAL ---
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
